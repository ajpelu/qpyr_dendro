---
title: "SPEI_longterm"
author: "Antonio J. Perez-Luque"
output:  
  md_document:
    toc: true
    variant: markdown_github
bibliography: ../../refs/references.bib
csl: ../../refs/ecology.csl
---
  
```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)
```


```{r}
library("here")
library("dplyr")
library("tidyverse")
library("stringr")
library("pander")
library("magrittr")

# machine <- 'ajpeluLap'
# machine <- 'ajpelu'
```



## Read and prepare data 
```{r}

# Get file names
myfiles <- list.files(path = here("data_raw/spei/spei_longterm"), pattern = "\\.csv$")

mydf <- data.frame() 

for (j in myfiles){ 
  aux <- read.csv(file=here("data_raw/spei/spei_longterm", j), header = TRUE, sep = ',')
  
  # Remove csv and get name 
  name_aux <- str_replace(j, ".csv", "") 
  
  # Get lat long
  latlong <- str_replace(name_aux, "spei_", "")
  mylong <- as.numeric(str_split_fixed(latlong, "_", 2))[1]
  mylat <- as.numeric(str_split_fixed(latlong, "_", 2))[2]
  
  # Store lat and long 
  aux$lat <- mylat
  aux$long <- mylong 
  
  # year and month 
  aux$month <- rep(1:12, 115)
  
  auxy <- c()
  years <- c() 
  for (j in 1901:2015) { 
    auxy <- as.data.frame(rep(j,12))
    years <- rbind(years, auxy)
    } 
  names(years) <- 'year'
  
  aux <- cbind(aux,years)
  
  # join all df 
  mydf <- rbind(mydf, aux)
}


# Convert to date  
mydf <- mydf %>% mutate(date = sprintf("%d-%02d", year, month),
                        date = as.Date(paste0(date, '-01'), format="%Y-%m-%d"))
```




```{r}
speidf <- mydf %>% dplyr::select(SPEI06,SPEI12,SPEI24,month, year, date) %>% 
  group_by(year,month, date) %>%
  summarise_at(vars(SPEI06,SPEI12,SPEI24), funs(mean,sd,se=sd(.)/sqrt(n()))) %>% 
  as.data.frame() 
```

# Plot 
```{r}
speiPlot <- function(df, vi, mytitle, year_scaleX){
  require(dplyr)
  require(scales)

  # Select variable of interest 
  dfs <- df %>% dplyr::select(year, month, date, starts_with(vi))
  
  # Rename variables 
  dfs <- dfs %>% rename_all(~sub(paste0(vi,'_'), '',.x))
  # Create variable pos and neg 
  dfs <- dfs %>% mutate(signo = ifelse(mean > 0, "pos", "neg"))
  
  # Plot  
  p <- ggplot(dfs, aes(x = date, y = mean, fill = signo)) + 
    geom_bar(stat = "identity") +
    scale_fill_manual(values = c("pos" = "darkblue", "neg" = "red")) +
    theme_bw()  + 
    labs(title= mytitle, x= '', y = paste0('z-scored (',vi,')')) +
    theme(legend.position = "none")
  
  # Date Scale in X 
  if (missing(year_scaleX)){
    p
    } else { 
    year_interval <- paste0(year_scaleX," year")
    p <- p + scale_x_date(date_breaks = year_interval, date_labels = "%Y")
    }

  return(p)
}
```    


```{r}
speiPlot(speidf, vi = 'SPEI12', mytitle = "SPEI for SN", year_scaleX = 20)
```


# Analysis 

## Computo de indicadores

Vamos a calcular para el promedio espacial de la serie (valores medios de los pixeles), los eventos de sequía. El sesgo de la agregación espacial de estos datos puede ser un problema a la hora de comparar entre regiones, pero puede corregirse ([@Spinoni2015b]). No obstante en nuestro caso no vamos a realizar comparaciones entre regiones, por lo que utilizaremos la agregación espacial (un promedio) para dar una visión general de la sequía en Sierra Nevada. 


* Hemos utilizado una categorización mixta, así para valores de sequía hemos seguido las categorías propuestas por [@Agnew2000] y para los valores positivos, la clasificación de [@Mckee1993]
* Un evento de sequía comienza cuando el valor del índice está por debajo de un umbral [@Pascoa2017] (en este caso < -0.84 moderate, < -1.28 severe y < -1.65 extreme)
* Utilizaremos la escala de 6 y 12 de SPEI
* Computaremos: 

    * Duración del evento de sequía (*drought duration*, *dd*): número de meses consecutivos con el valor de spei por debajo de un umbral. 
    * Intensidad (*drought intensity*, *di*): valor medio del spei durante el periodo de sequía.
    * Severidad (*drought severity*, *ds*): suma de los valores de spei (en valores absolutos) durante el periodo de sequía 
    * Inicio (*start*, *dstart*): mes de inicio del periodo de sequía
    * Fin (*end*, *dend*): mes de fin del periodo de sequía 
    * Frecuencia de sequías (*drought frequency*, *df*): número de eventos de sequía por década. 
    
Consideramos un evento cuando se dan las condiciones en al menos dos meses consecutivos (ver [@Spinoni2014; @Pascoa2017]). Para mas info ver [@Pascoa2017; @Spinoni2014; @Spinoni2015] 


```{r}
droughtIndicators <- function(df, vname, threshold){
  require(dplyr)
  require(magrittr)

outlist <- c()

# https://github.com/tidyverse/dplyr/issues/1661
 
# Compute months under threshold 
out <- df %>% mutate(
  is_drought = ifelse(
    .[[vname]] < threshold & lead(.[[vname]] < threshold), 1, 0))

# Identified the different events and numbered them
# Compute lenght of drought events

out2 <- out %>% 
  group_by(index_events = rle(is_drought) %>% extract2("lengths") %>% rep(seq_along(.), .)) %>% 
  mutate(drought_duration = sum(is_drought)) %>% 
  as.data.frame()

# Filter events with drought duration > 1 
out3 <- out2 %>% filter(drought_duration > 1) %>% as.data.frame()

# Compute several indicators (drought assessments) 
da <- out3 %>% group_by(index_events) %>% 
  summarise(d_duration = unique(drought_duration),
            d_intensity = mean(spei, na.rm=TRUE),
            d_severity = sum(abs(spei), na.rm=TRUE),
            lowest_spei = min(spei),
            month_peak = month[which.min(spei)], 
            minyear = min(year),
            maxyear = max(year),
            rangeDate = paste(month(min(date), label=TRUE), '-',
                             (month(max(date), label=TRUE)))) %>%
  as.data.frame()

outlist$data <- out2
outlist$drought_events <- out3
outlist$drought_assessment <- da 

return(outlist) 
} 
```

```{r}
# Compute for all pixels (mean values of SN) only for scales 6 and 12 

spei6avg <- speidf %>% dplyr::select(year, month, date, spei = SPEI06_mean) 
spei12avg <- speidf %>% dplyr::select(year, month, date, spei = SPEI12_mean)

da6_mod <- droughtIndicators(spei6avg, threshold = -0.84, vname = 'spei') 
da12_mod <- droughtIndicators(spei12avg, threshold = -0.84, vname = 'spei') 

da6_sev <- droughtIndicators(spei6avg, threshold = -1.28, vname = 'spei') 
da12_sev <- droughtIndicators(spei12avg, threshold = -1.28, vname = 'spei') 

da6_ext <- droughtIndicators(spei6avg, threshold = -1.65, vname = 'spei') 
da12_ext <- droughtIndicators(spei12avg, threshold = -1.65, vname = 'spei') 


# Join all moderate and compute decade (# https://stackoverflow.com/questions/35352914/floor-a-year-to-the-decade-in-r 

mod <- rbind(da6_mod$drought_assessment %>% mutate(variable= 'spei6'),
      da12_mod$drought_assessment %>% mutate(variable= 'spei12')) %>% 
  mutate(cat = 'moderate', decade = (minyear %/% 10) * 10)

sev<- rbind(da6_sev$drought_assessment %>% mutate(variable= 'spei6'),
      da12_sev$drought_assessment %>% mutate(variable= 'spei12')) %>% 
  mutate(cat = 'severe', decade = (minyear %/% 10) * 10)

ext <- rbind(da6_ext$drought_assessment %>% mutate(variable= 'spei6'),
      da12_ext$drought_assessment %>% mutate(variable= 'spei12')) %>% 
  mutate(cat = 'extreme', decade = (minyear %/% 10) * 10)


# Compute DF (*drought frequency*)

dfmod <- mod %>% group_by(variable, decade, cat) %>% summarize(df = n())
dfsev <- sev %>% group_by(variable, decade, cat) %>% summarize(df = n())
dfext <- ext %>% group_by(variable, decade, cat) %>% summarize(df = n())

df <- dfmod %>% bind_rows(dfsev, dfext)
```

Utilizar SPEI 12 

```{r}
sev12 <- sev %>% filter(variable == "spei12") %>% arrange(desc(d_duration)) %>% 
  dplyr::select(-index_events, -decade, -variable)

write.csv(sev12, file=here::here('data/sequias', 'severe_spei12.csv'), row.names=FALSE)
pander(sev12)

```

```{r}
sev6 <- sev %>% filter(variable == "spei6") %>% arrange(desc(d_duration)) %>% 
  dplyr::select(-index_events, -decade, -variable)

write.csv(sev6, file=here::here('data/sequias', 'severe_spei6.csv'), row.names=FALSE)
pander(sev6)
```


## Duration vs. Lowest SPEI (SPEI06, SPEI12)
```{r}
require(ggrepel)
# Duracion vs
sev %>% ggplot(aes(d_duration, y=lowest_spei, label=maxyear, colour=variable)) + geom_point() + 
  geom_text_repel() 
```

## Duration vs. Severity (SPEI06, SPEI12)
```{r}
sev %>% ggplot(aes(d_duration, y=d_severity, label=maxyear, colour=variable)) + geom_point() + 
  geom_text_repel() 
```

## Duration vs. Intensity (SPEI06, SPEI12)
```{r}
sev %>% ggplot(aes(d_duration, y=d_intensity, label=maxyear, colour=variable)) + geom_point() + 
  geom_text_repel() 
```

## Severity vs. Intensity (SPEI06, SPEI12)
```{r}
sev %>% ggplot(aes(d_severity, y=d_intensity, label=maxyear, colour=variable)) + geom_point() + 
  geom_text_repel() 
```







# Datos sequia antes y despues
* Ver los valores de spei antes y despues. Computa para el t+1, t+2 y t+3 el valor de spei medio (media de todos los valores de spei del año t+1 o t+2 o t+3) y el valor de spei acumulado (lo mismo pero sumando, ojo sin poner en valor absoluto), es decir, me
)media de to
```{r}

dys <- sev12 %>% filter(d_duration > 2) %>% as.data.frame() 
dys <- dys[,'maxyear']

f <- c()

for (y in dys){ 
  
  aux <- speidf %>% 
    dplyr::select(year, month, SPEI12_mean)
    
  aux1 <- aux %>% filter(year == y + 1) %>% 
    summarise(speiyear_mean = mean(SPEI12_mean), 
              speiyear_sum = sum(SPEI12_mean)) %>% 
    mutate(droughtyear = y, tlag = 1)
  
  aux2 <- aux %>% filter(year == y + 2) %>% 
    summarise(speiyear_mean = mean(SPEI12_mean), 
              speiyear_sum = sum(SPEI12_mean)) %>% 
    mutate(droughtyear = y, tlag = 2)
  
  aux3 <- aux %>% filter(year == y + 3) %>% 
    summarise(speiyear_mean = mean(SPEI12_mean), 
              speiyear_sum = sum(SPEI12_mean)) %>% 
    mutate(droughtyear = y, tlag = 3)
  
  aux2ev <- aux %>% 
    filter(year >= y + 1) %>% 
    filter(year <= y + 2) %>% 
    summarise(speiyear_mean = mean(SPEI12_mean), 
              speiyear_sum = sum(SPEI12_mean)) %>% 
    mutate(droughtyear = y, tlag = 20)
  
  aux3ev <- aux %>% 
    filter(year >= y + 1) %>% 
    filter(year <= y + 3) %>% 
    summarise(speiyear_mean = mean(SPEI12_mean), 
              speiyear_sum = sum(SPEI12_mean)) %>% 
    mutate(droughtyear = y, tlag = 30)
  
  
  
  f <- rbind(f, aux1, aux2, aux2ev, aux3, aux3ev)
  }


write.csv(f, file=here::here('data/sequias', 'post_severe.csv'), row.names=FALSE)
```


