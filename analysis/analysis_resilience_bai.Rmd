---
title: "Growth Resilience"
author: "AJ Perez-Luque (@ajpelu)"
date: "2017 June"
output:  
  md_document:
    variant: markdown_github
bibliography: references.bib 
csl: ecology.csl
---

```{r global_options, include=FALSE}
knitr::opts_chunk$set(fig.width=12, fig.height=8,warning=FALSE, message=FALSE)
```


```{r, warning=FALSE, message=FALSE}
library("tidyverse")
library("stringr")
library("dplR")
library("knitr")
# library("detrendeR")
library("pander")
library('boot')
library('gtable')
library('grid')
```

# Resilience 

* Calcularemos las métricas resiliencia de [@Lloret2011] sobre el crecimiento. 
* Vamos a calcularlas sobre el BAI de cada árbol. 
* Utilizaremos tres sitios: SJ, CAH y CAL (ver [./analysis/analysis_chronologies.md]('./analysis/analysis_chronologies.md)) 

## Prepare data 

* Leer datos `rwl` de SJ y CA
* Leer datos de diametros de los focal tree

```{r, echo=FALSE}
#machine <- 'ajpelu'
machine <- 'ajpeluLap'
di <- paste0('/Users/', machine, '/Dropbox/phd/phd_repos/qpyr_dendro/', sep='')

# sj 
sj <- read.rwl(fname=paste0(di, '/data_raw/dendro_ring/sn_sanjuan/sn_sanjuan.rwl'), format="tucson")

# canar 
ca <- read.rwl(fname=paste0(di, '/data_raw/dendro_ring/sn_canar/sn_canar.rwl'), format="tucson")

# Read diameters data
compete <- read.csv(file=paste0(di, '/data_raw/dendro_competence.csv'), header=TRUE, sep=',')
```

```{r}
source(paste0(di, 'script/R/rw_byTree.R'))
source(paste0(di, 'script/R/bai_piovesan.R'))
```

* Crear dataframes `rwl` por cada sitio CA_High, CA_Low, SJ_High. SJ_Low
    
```{r}
# Replace SNA by SJ and SNB by CA
names(ca) <- stringr::str_replace(names(ca), "SNB", "CA") 
names(sj) <- stringr::str_replace(names(sj), "SNA", "SJ")

# Remove g in name of some cores of CA. 
names(ca) <- stringr::str_replace(names(ca), "g", "")
```

```{r}
# Create subset to compare between sites 
caL <- ca[,c("CA0101","CA0102","CA0201","CA0202","CA0301","CA0302","CA0401","CA0402","CA0501","CA0502",
             "CA0601","CA0602","CA0701","CA0702","CA0801","CA0802","CA0901","CA0902","CA1001","CA1002",
             "CA2601","CA2602","CA2701","CA2702","CA2801","CA2802","CA2901","CA2902","CA3001","CA3002")] 
caH <- ca[, c("CA1101","CA1102","CA1201","CA1202","CA1301","CA1302","CA1401","CA1402","CA1501","CA1502",
              "CA1601","CA1602","CA1701","CA1702","CA1801","CA1802","CA1901","CA1902","CA2001","CA2002",
              "CA2101","CA2102","CA2201","CA2202","CA2301","CA2302","CA2401","CA2402","CA2501","CA2502")]

```

* Lectura y preparación de datos de diámetro

```{r} 
# Prepare Diameter data 

# Compute diameter (mm)
compete <- compete %>% 
  mutate(dn_mm = (perim_mm / pi))

# Change name focal according to loc
compete <- compete %>% 
  mutate(id_focalLoc = stringr::str_replace_all(id_focal, c("A" = "SJ", "B" = "CA")))

         
# Get only focal trees, and only selected variables 
ft <- compete %>% 
  filter(sp=='Focal') %>% 
  filter(id_focal!='Fresno') %>% 
  dplyr::select(id_focal, id_focalLoc, loc, dn_mm, height_cm) 

# Set levels of eleveation 
ca_lowcode <- c(paste0('CA', str_pad(1:10, 2, pad='0')),
            paste0('CA', 26:30))
ca_highcode <- paste0('CA', 11:25)

ft <- ft %>% 
  mutate(site = as.factor(
    ifelse(id_focalLoc %in% ca_lowcode, 'CAL', 
           ifelse(id_focalLoc %in% ca_highcode, 'CAH', 'SJ'))))
```


# Aggregate RW by tree 

* Agregar valores medios de RW por site (obtenemos sj_tree / caL_tree, caH_tree) 
* ver fun rw_byTree o utilizar treeMean (dplR)

```{r}
# Remember snc = structure of core name SJ0101 (site | tree | core)
sj_tree <- rw_byTree(sj, snc =c(2,2,2), locname = 'SJ')
caL_tree <- rw_byTree(caL, snc =c(2,2,2), locname = 'CA')
caH_tree <- rw_byTree(caH, snc =c(2,2,2), locname = 'CA')
```

* Crear diferentes dataset de diametro por sitio 
```{r}
diam <- ft %>%
  mutate(diameter = dn_mm, 
         id = id_focalLoc) %>%
  dplyr::select(id, diameter, site) %>% 
  split(.$site) 


d_caH <- diam$CAH[,c('id','diameter')]
d_caL <- diam$CAL[,c('id','diameter')]
d_sj <- diam$SJ[,c('id','diameter')]
```


# Cómputo del BAI por site  

* He construido una funcion para el computo del BAI, teniendo en cuenta la aproximación de [@Piovesan2008]. Es similar a `bai.out`

```{r}
bai_sj <- bai_piovesan(rwdf = sj_tree, diam_df = d_sj)
bai_caH <- bai_piovesan(rwdf = caH_tree, diam_df = d_caH)
bai_caL <- bai_piovesan(rwdf = caL_tree, diam_df = d_caL)

# Set class to bai object 
# Esto es para que funcionen algunas otras funciones de dplR 
bais <- c('bai_sj', 'bai_caH', 'bai_caL')

for (i in bais){
  aux <- get(i)
  
  class(aux) <- c('rwl', 'data.frame')
  
  assign(i, aux)
}
  
```

## Resilience function 

```{r}

event_year <- c(1995, 2005, 2012)

window <- c(2,3) 
  i <- 1995
  window <- 3
  bai_object <- bai_sj 

  
baiResilience <- function(bai_object, event_years, window){ 
  
  out_growth <- c() 
  out_res <- c() 
  out <- list()
  
  for (i in event_years){
    # Create df previous, during and post event
    df <- bai_object %>% 
      mutate(year = as.numeric(row.names(.))) %>% as.data.frame()
    
    df_pre <- df %>% filter(year < i & year >= (i - window)) %>% mutate(disturb = 'pre')
    df_event <- df %>% filter(year == i) %>% mutate(disturb = 'dr')
    df_post <- df %>% filter(year > i & year <= (i + window)) %>% mutate(disturb = 'post')
    
    # Melt data 
    dfmelt <- bind_rows(df_pre, df_event, df_post) %>% 
      gather(tree, value, -disturb, -year)
    
    # Compute mean of Growth (previous, during and posterior)
    growth_df <- dfmelt %>% group_by(disturb, tree) %>% 
      summarise(mean_period = mean(value),
                sd_period = sd(value),
                se_period = sd_period/sqrt(length(value))) %>% 
      mutate(disturb_year = i)
    
    out_growth <- rbind(out_growth, growth_df)
    
    # Compute resilience by trees 
    aux_resilience <- c() 
    trees <- unique(growth_df$tree)
    
    for (t in trees){
      # Filter by tree
      df_tree <- growth_df %>% filter(tree == t) 
      
      # Compute resilience metrics by tree
      aux_df <- df_tree %>% select(-c(tree, sd_period, se_period)) %>% 
        spread(key=disturb, value=mean_period) %>% 
        mutate(rt = dr / pre,
               rc = post / dr,
               rs = post / pre,
               rrs = (post - dr) / pre,tree = t) %>% 
        select(rt, rc, rs, rrs, disturb_year, tree)
      
      aux_resilience <- rbind(aux_resilience, aux_df)
    }
    
    out_res <- rbind(out_res, aux_resilience)
  }
  
  
  out$growth <- out_growth
  out$resilience <- out_res
  
  return(out)
}
    
    
    
    
   


dyears <- c(1995, 2005, 2012)
res_sj3 <- baiResilience(bai_sj, event_years = dyears, window = 3)
res_sj2 <- baiResilience(bai_sj, event_years = dyears, window = 2)



resile2 <- res_sj2$resilience
resile3 <- res_sj3$resilience


summary(lm(resile2$rs~resile3$rs))



```

# References


    