---
title: "Analysis Stand Features "
author: "AJ Perez-Luque (@ajpelu)"
date: "2018 Jan"
output:   
  md_document:
    toc: true
    variant: markdown_github
---

```{r global_options, include=FALSE}
knitr::opts_chunk$set(warning=FALSE, message=FALSE)
```

```{r, warning=FALSE, message=FALSE, echo=FALSE}
library("tidyverse")
library("raster")
library("stringr")
library('rgdal')
library("sp")
library("knitr")
library("broom")
library("multcomp")
library("pander")
library("devtools")
source_gist("https://gist.github.com/ajpelu/194e721077ec045a2b864088908e7aca", filename = 'table_glht.r') # multicomp table
```


# Prepare Data
```{r, echo=FALSE}
machine <- 'ajpelu'
# machine <- 'ajpeluLap'
di <- paste0('/Users/', machine, '/Dropbox/phd/phd_repos/qpyr_dendro/', sep='')


# Read tree data
tree <- read.csv(file=paste0(di, '/data_raw/dendro_competence.csv'), header=TRUE, sep=',')



# Read spatial data 
# Centroid of focal tree 
## filename 
mygpx_ca <- paste0(di, 'data_raw/geoinfo/dendro_ca.GPX')
mygpx_sj <- paste0(di, 'data_raw/geoinfo/dendro_sj.GPX')

## reading  
field_work_ca <- readOGR(mygpx_ca, layer="waypoints", verbose = FALSE)
field_work_sj <- readOGR(mygpx_sj, layer="waypoints", verbose = FALSE)
```

* Two datasets: focal tree and competence 

```{r}
# Compute diameter (mm)
tree <- tree %>% 
  mutate(dn_mm = (perim_mm / pi))
         
### - old code 4 sites 
# Set levels of eleveation 
# sj_lowcode  <- paste0('A', str_pad(1:10, 2, pad='0'))
# sj_highcode <- paste0('A', 11:20)
# ca_lowcode <- c(paste0('B', str_pad(1:10, 2, pad='0')),
#             paste0('B', 26:30))
# ca_highcode <- paste0('B', 11:25)
# 
# tree <- tree %>% 
#   mutate(elevF = ifelse(id_focal %in% sj_lowcode, 'Low',
#                        ifelse(id_focal %in% sj_highcode, 'High',
#                               ifelse(id_focal %in% ca_lowcode, 'Low', 'High')))) %>%
#   mutate(site = paste0(loc, '_', elevF))
# 
# 


sj_code  <- paste0('A', str_pad(1:20, 2, pad='0'))
ca_lowcode <- c(paste0('B', str_pad(1:10, 2, pad='0')), paste0('B', 26:30))
ca_highcode <- paste0('B', 11:25)

tree <- tree %>% mutate(
  site = as.factor(case_when(
    id_focal %in% sj_code ~ "sj", 
    id_focal %in% ca_highcode ~ "caH", 
    id_focal %in% ca_lowcode ~ "caL")))
    
# Get only focal trees  
ft <- tree %>% 
  filter(sp=='Focal') %>% 
  filter(id_focal!='Fresno') 

# Get only no focal trees 
nft <- tree %>% 
  filter(sp!='Focal') 
```

# General Variables 
Numbers of focal trees by site 

```{r}
general_var <- ft %>% group_by(site) %>% count() 

general_var %>% kable
```



# Spatial Info
Coordinates of the centroid for each site 

```{r, spatialData} 
## Get coordinates of spatial data  
sp_ca <- as.data.frame(field_work_ca) %>% 
  dplyr::select(ele, name, lat = coords.x2, long = coords.x1) 

sp_sj <- as.data.frame(field_work_sj) %>% 
  dplyr::select(ele, name, lat = coords.x2, long = coords.x1) 

sp_sites <- rbind(sp_sj, sp_ca) %>% 
  mutate(site = as.factor(case_when(
    name %in% sj_code ~ "sj", 
    name %in% ca_highcode ~ "caH", 
    name %in% ca_lowcode ~ "caL")))


coord_sites <- sp_sites %>% 
  group_by(site) %>%
  dplyr::summarise(lat_m = mean(lat), long_m = mean(long))
  
coord_sites %>% kable()

# old code 
# 
# 
# 
# ## Add code site and get centroid (see # http://rspatial.org/analysis/rst/8-pointpat.html)
# sp_ca <- sp_ca %>% 
#   mutate(loc = 'CA', 
#          
#          
#          elevF = ifelse(name %in% ca_lowcode, 'Low', 'High'),
#          site = paste0(loc, '_', elevF)) 
# 
# coord_ca <- sp_ca %>% 
#   group_by(site) %>%
#   summarise(lat_m = mean(lat),
#             long_m = mean(long))
# 
# # plot(sp_ca$long, sp_ca$lat, pch=19, col='gray')
# # points(coord_ca$long_m, coord_ca$lat_m, pch=19, col='blue')
#   
# sp_sj <- sp_sj %>% 
#   mutate(loc = 'SJ', 
#          elevF = ifelse(name %in% sj_lowcode, 'Low', 'High'),
#          site = paste0(loc, '_', elevF))        
# coord_sj <- sp_sj %>% 
#   group_by(site) %>%
#   summarise(lat_m = mean(lat),
#             long_m = mean(long))
# 
# coords_sites <- coord_sj %>% rbind(coord_ca)
# 
# #plot(sp_sj$long, sp_sj$lat, pch=19, col='gray')
# #points(coord_sj$long_m, coord_sj$lat_m, pch=19, col='blue')
# 
# coords_sites %>% kable()
```


# Competition data

* Read data 
```{r, echo=FALSE}
# Read competition
compe <- read.csv(file=paste(di, "/data/competence/competence_indices.csv", sep=""), header=TRUE, sep=',')

compe <- compe %>% 
  mutate(site = as.factor(case_when(
    id_focal %in% sj_code ~ "sj", 
    id_focal %in% ca_highcode ~ "caH", 
    id_focal %in% ca_lowcode ~ "caL")))

# old code 
# compe <- compe %>% 
#   mutate(name = id_focal) %>% 
#   mutate(loc = ifelse(str_detect(name, "A"), 'SJ', 'CA'),
#          elevF = ifelse(name %in% sj_lowcode, 'Low',
#                         ifelse(name %in% sj_highcode, 'High',
#                               ifelse(name %in% ca_lowcode, 'Low', 'High')))) %>%
#   mutate(site = paste0(loc, '_', elevF)) %>% 
#   mutate(site = as.factor(site),
#          loc = as.factor(loc),
#          elevF = as.factor(elevF))

```

* Create a custom function to compare between sites (aov & post hoc)

```{r, echo=FALSE}
#### Function to comparison (aov)
compara <- function(df, mivariable){ 
  require('dplyr')
  require('multcomp')
  require('broom') 
  # mivariable: variabe of interest
  
  output <- list() 
  
  # Model formulation
  myformula <- as.formula(paste0(mivariable, " ~ site"))
  
  # AOV 
  mymodel <- aov(myformula, data=df)
  
  # Summary AOV (broom style)
  tm <- broom::tidy(mymodel)
  
  # Multiple comparison 
  tuk <- glht(mymodel, linfct = mcp(site = "Tukey"))
  
  # Convert comparisons into letters 
  df_letter <- fortify(cld(tuk)) %>% 
    transmute(site = as.factor(lhs),
         tukey = letters) %>%
    mutate(variable = mivariable)
  
  aux_name <- paste0('df_tuk_', mivariable)
  assign(aux_name, df_letter)
  
  mymult <- as.data.frame(table_glht(tuk))
  
  output$mymodel <- mymodel
  output$tm <- tm
  output$aux_name <- df_letter
  output$mymult <- mymult
  
  # Return also summary values 
  summ_values <- df %>% 
    dplyr::select_(mivariable, 'site') %>%
    group_by(site) %>% 
    summarise_all(funs(mean, sd, se=sd(.)/sqrt(n()), min, max)) 
  
  # Join letters and summary values
  output$summ_values <- summ_values
  
  summ_comparison <- summ_values %>% left_join(df_letter, by='site') %>% as.data.frame()
  
  output$summ_comparison <- summ_comparison
    
  return(output)
}  

```

* Export data into text files (see `/out/anovas_competition/`)

```{r, echo=FALSE}
## Comparison 
# Select only variables to compare 
compe_sel <- compe %>% dplyr::select(ba:dnn,site)

# Get vector with variables 
variables <- compe %>% dplyr::select(ba:dnn) %>% names()

for (i in variables){ 
  
  # apply comparison
  out_compara <- compara(df=compe_sel, mivariable = i)
  
  out_name  <- paste0('aov_', i)
  assign(out_name, out_compara)

}


# Loop to export into txt files (see ./out/anovas_competition ... )
for (i in variables){ 
 
  out <- get(paste0('aov_', i))
  file_out <- file(paste0(di,'out/anovas_competition/aov_', i, '.txt'), "w")
  sink(file_out)
  cat("MODEL \n")
  print(out$mymodel) 
  cat("\n")
  
  cat("MODEL pretty \n")
  print(out$tm) 
  cat("\n")
  
  cat("POST HOC \n")
  print(out$mymult) 
  cat("\n")
  
  cat("SUMMARY VALUES \n")
  print(as.data.frame(out$summ_comparison))
  cat("\n")
  
  while (sink.number()>0) sink()
  # close(file_out)
}

while (sink.number()>0) sink()
```




## Distance-Independet Indices 
### Basal Area
```{r, echo=FALSE}
mivariable <- 'ba'
s <- get(paste0('aov_', mivariable))

s$summ_comparison %>% 
  pander(round=4, caption=paste0('Mean values (', mivariable,')'))

tm <- s$tm

pander(tm, round=5,
       caption=paste0('ANOVA table (', mivariable,')'), 
       missing = '', emphasize.strong.cells = 
               which(tm < 0.1 & tm == tm$p.value, arr.ind = T))
```

### Stand Density
```{r, echo=FALSE}
mivariable <- 'std'
s <- get(paste0('aov_', mivariable))

s$summ_comparison %>% 
  pander(round=4, caption=paste0('Mean values (', mivariable,')'))

tm <- s$tm

pander(tm, round=5,
       caption=paste0('ANOVA table (', mivariable,')'), 
       missing = '', emphasize.strong.cells = 
               which(tm < 0.1 & tm == tm$p.value, arr.ind = T))
```

### Plot Density
```{r, echo=FALSE}
mivariable <- 'pd'
s <- get(paste0('aov_', mivariable))

s$summ_comparison %>% 
  pander(round=4, caption=paste0('Mean values (', mivariable,')'))

tm <- s$tm

pander(tm, round=5,
       caption=paste0('ANOVA table (', mivariable,')'), 
       missing = '', emphasize.strong.cells = 
               which(tm < 0.1 & tm == tm$p.value, arr.ind = T))
```


### Number of competitors within *r* meters (10 m)
```{r, echo=FALSE}
mivariable <- 'n_competitors'
s <- get(paste0('aov_', mivariable))

s$summ_comparison %>% 
  pander(round=4, caption=paste0('Mean values (', mivariable,')'))

tm <- s$tm

pander(tm, round=5,
       caption=paste0('ANOVA table (', mivariable,')'), 
       missing = '', emphasize.strong.cells = 
               which(tm < 0.1 & tm == tm$p.value, arr.ind = T))
```


### Number of competitors within *r* meters (10 m) such that $ dbh_j > dbh_i $
```{r, echo=FALSE}
mivariable <- 'n_competitors_higher'
s <- get(paste0('aov_', mivariable))

s$summ_comparison %>% 
  pander(round=4, caption=paste0('Mean values (', mivariable,')'))

tm <- s$tm

pander(tm, round=5,
       caption=paste0('ANOVA table (', mivariable,')'), 
       missing = '', emphasize.strong.cells = 
               which(tm < 0.1 & tm == tm$p.value, arr.ind = T))
```


### Sum of size of trees within *r* meters (10 m) 

```{r, echo=FALSE}
mivariable <- 'sum_sizes'
s <- get(paste0('aov_', mivariable))

s$summ_comparison %>% 
  pander(round=4, caption=paste0('Mean values (', mivariable,')'))

tm <- s$tm

pander(tm, round=5,
       caption=paste0('ANOVA table (', mivariable,')'), 
       missing = '', emphasize.strong.cells = 
               which(tm < 0.1 & tm == tm$p.value, arr.ind = T))
```
 

## Size ratio 

```{r, echo=FALSE}
mivariable <- 'sr'
s <- get(paste0('aov_', mivariable))

s$summ_comparison %>% 
  pander(round=4, caption=paste0('Mean values (', mivariable,')'))

tm <- s$tm

pander(tm, round=5,
       caption=paste0('ANOVA table (', mivariable,')'), 
       missing = '', emphasize.strong.cells = 
               which(tm < 0.1 & tm == tm$p.value, arr.ind = T))
```
 
           
## Distance-Dependet Indices 

### Distance to nearest tree       
```{r, echo=FALSE}
mivariable <- 'dnn'
s <- get(paste0('aov_', mivariable))

s$summ_comparison %>% 
  pander(round=4, caption=paste0('Mean values (', mivariable,')'))

tm <- s$tm

pander(tm, round=5,
       caption=paste0('ANOVA table (', mivariable,')'), 
       missing = '', emphasize.strong.cells = 
               which(tm < 0.1 & tm == tm$p.value, arr.ind = T))
```
               
                
### Crowding       
```{r, echo=FALSE}
mivariable <- 'crowding'
s <- get(paste0('aov_', mivariable))

s$summ_comparison %>% 
  pander(round=4, caption=paste0('Mean values (', mivariable,')'))

tm <- s$tm

pander(tm, round=5,
       caption=paste0('ANOVA table (', mivariable,')'), 
       missing = '', emphasize.strong.cells = 
               which(tm < 0.1 & tm == tm$p.value, arr.ind = T))
```
               

### Lorimer       

```{r, echo=FALSE}
mivariable <- 'lorimer'
s <- get(paste0('aov_', mivariable))

s$summ_comparison %>% 
  pander(round=4, caption=paste0('Mean values (', mivariable,')'))

tm <- s$tm

pander(tm, round=5,
       caption=paste0('ANOVA table (', mivariable,')'), 
       missing = '', emphasize.strong.cells = 
               which(tm < 0.1 & tm == tm$p.value, arr.ind = T))
```
    

### Negative Exponential size ratio                      

```{r, echo=FALSE}
mivariable <- 'nesr'
s <- get(paste0('aov_', mivariable))

s$summ_comparison %>% 
  pander(round=4, caption=paste0('Mean values (', mivariable,')'))

tm <- s$tm

pander(tm, round=5,
       caption=paste0('ANOVA table (', mivariable,')'), 
       missing = '', emphasize.strong.cells = 
               which(tm < 0.1 & tm == tm$p.value, arr.ind = T))
```
  

### Negative Exponential Weighted size ratio
```{r, echo=FALSE}
mivariable <- 'newsr'
s <- get(paste0('aov_', mivariable))

s$summ_comparison %>% 
  pander(round=4, caption=paste0('Mean values (', mivariable,')'))

tm <- s$tm

pander(tm, round=5,
       caption=paste0('ANOVA table (', mivariable,')'), 
       missing = '', emphasize.strong.cells = 
               which(tm < 0.1 & tm == tm$p.value, arr.ind = T))
```
 
 
### Size ratio proportional to distance 

```{r, echo=FALSE}
mivariable <- 'srd'
s <- get(paste0('aov_', mivariable))

s$summ_comparison %>% 
  pander(round=4, caption=paste0('Mean values (', mivariable,')'))

tm <- s$tm

pander(tm, round=5,
       caption=paste0('ANOVA table (', mivariable,')'), 
       missing = '', emphasize.strong.cells = 
               which(tm < 0.1 & tm == tm$p.value, arr.ind = T))
```
 

### Size difference proportional to distance 

```{r, echo=FALSE}
mivariable <- 'sdd'
s <- get(paste0('aov_', mivariable))

s$summ_comparison %>% 
  pander(round=4, caption=paste0('Mean values (', mivariable,')'))

tm <- s$tm

pander(tm, round=5,
       caption=paste0('ANOVA table (', mivariable,')'), 
       missing = '', emphasize.strong.cells = 
               which(tm < 0.1 & tm == tm$p.value, arr.ind = T))
```


# Topographic data

* Read data 
```{r}
# Read topo data 
topo <- read.csv(file=paste(di, "/data/topo/topo.csv", sep=""), header=TRUE, sep=',')

# topo <- topo %>% 
#   mutate(loc = ifelse(str_detect(name, "A"), 'SJ', 'CA'),
#          elevF = ifelse(name %in% sj_lowcode, 'Low',
#                         ifelse(name %in% sj_highcode, 'High',
#                               ifelse(name %in% ca_lowcode, 'Low', 'High')))) %>%
#   mutate(site = paste0(loc, '_', elevF)) %>% 
#   mutate(site = as.factor(site),
#          loc = as.factor(loc),
#          elevF = as.factor(elevF))

topo <- topo %>% 
  mutate(site = as.factor(case_when(
    name %in% sj_code ~ "sj", 
    name %in% ca_highcode ~ "caH", 
    name %in% ca_lowcode ~ "caL")))

```

* Compare data and export data into text files (see `/out/anovas_topo/`)

```{r, echo=FALSE}
## Comparison 
# Select only variables to compare 

topo_sel <- topo %>% dplyr::select(mde, slope, site)

# Get vector with variables 
variables <- c('mde','slope')

for (i in variables){ 
  
  # apply comparison
  out_compara <- compara(df=topo_sel, mivariable = i)
  
  out_name  <- paste0('aov_', i)
  assign(out_name, out_compara)

}


# Loop to export into txt files (see ./out/anovas_topo ... )
for (i in variables){ 
 
  out <- get(paste0('aov_', i))
  
  file_out <- file(paste0(di,'out/anovas_topo/aov_', i, '.txt'), "w")
  sink(file_out)

  cat("MODEL \n")
  print(out$mymodel) 
  cat("\n")
  
  cat("MODEL pretty \n")
  print(out$tm) 
  cat("\n")
  
  cat("POST HOC \n")
  print(out$mymult) 
  cat("\n")
  
  cat("SUMMARY VALUES \n")
  print(as.data.frame(out$summ_comparison))
  cat("\n")
  
  while (sink.number()>0) sink()
  # close(file_out)

}

while (sink.number()>0) sink()
```


### Elevation 

```{r, echo=FALSE}
mivariable <- 'mde'
s <- get(paste0('aov_', mivariable))

s$summ_comparison %>% 
  pander(round=4, caption=paste0('Mean values (', mivariable,')'))

tm <- s$tm

pander(tm, round=5,
       caption=paste0('ANOVA table (', mivariable,')'), 
       missing = '', emphasize.strong.cells = 
               which(tm < 0.1 & tm == tm$p.value, arr.ind = T))
```


### Slope 

```{r, echo=FALSE}
mivariable <- 'slope'
s <- get(paste0('aov_', mivariable))

s$summ_comparison %>% 
  pander(round=4, caption=paste0('Mean values (', mivariable,')'))

tm <- s$tm

pander(tm, round=5,
       caption=paste0('ANOVA table (', mivariable,')'), 
       missing = '', emphasize.strong.cells = 
               which(tm < 0.1 & tm == tm$p.value, arr.ind = T))
```


# Focal tree summary 

```{r}
## Comparison 
# Select only variables to compare 
ft_sel <- ft %>%
  mutate(dn = dn_mm / 10, 
         h = height_cm / 100) %>% 
  dplyr::select(dn, h, site) 

  
# Get vector with variables 
variables <- c('dn','h')

for (i in variables){ 
  
  # apply comparison
  out_compara <- compara(df=ft_sel, mivariable = i)
  
  out_name  <- paste0('aov_', i)
  assign(out_name, out_compara)

}


# Loop to export into txt files (see ./out/anovas_ft ... )
for (i in variables){ 
 
  out <- get(paste0('aov_', i))
  
  file_out <- file(paste0(di,'out/anovas_ft/aov_', i, '.txt'), "w")
  sink(file_out)

  cat("MODEL \n")
  print(out$mymodel) 
  cat("\n")
  
  cat("MODEL pretty \n")
  print(out$tm) 
  cat("\n")
  
  cat("POST HOC \n")
  print(out$mymult) 
  cat("\n")
  
  cat("SUMMARY VALUES \n")
  print(as.data.frame(out$summ_comparison))
  cat("\n")
  
  while (sink.number()>0) sink()
  # close(file_out)

}

while (sink.number()>0) sink()
```


### dn Focal tree 

```{r, echo=FALSE}
mivariable <- 'dn'
s <- get(paste0('aov_', mivariable))

s$summ_comparison %>% 
  pander(round=4, caption=paste0('Mean values (', mivariable,')'))

tm <- s$tm

pander(tm, round=5,
       caption=paste0('ANOVA table (', mivariable,')'), 
       missing = '', emphasize.strong.cells = 
               which(tm < 0.1 & tm == tm$p.value, arr.ind = T))
```


### height Focal tree 

```{r, echo=FALSE}
mivariable <- 'h'
s <- get(paste0('aov_', mivariable))

s$summ_comparison %>% 
  pander(round=4, caption=paste0('Mean values (', mivariable,')'))

tm <- s$tm

pander(tm, round=5,
       caption=paste0('ANOVA table (', mivariable,')'), 
       missing = '', emphasize.strong.cells = 
               which(tm < 0.1 & tm == tm$p.value, arr.ind = T))
```





```{r}
# Join all data and export as table

# Get name of variables 
variables <- compe %>% dplyr::select(ba:dnn) %>% names() %>% rbind()
# Add topo and focal tree variables 
nombres <- c(variables, 'mde','slope', 'dn', 'h')

out <- c()

for (i in nombres){ 
  # name of aov object
  aov_name <- paste0('aov_',i)
  # get aov_object 
  aux <- get(aov_name)
  # get summ comparison dataframe 
  aux2 <- aux$summ_comparison
  out <- rbind(out, aux2)
}

out2 <- out %>% dplyr::select(site, mean, sd, tukey, mivar = variable)
                              

# See this solution 
# http://stackoverflow.com/questions/39066811/long-to-wide-with-dplyr
# http://garrettgman.github.io/tidying/
out3 <- gather(out2, variable, value, mean, sd, tukey) %>% 
  unite(var, variable, site) %>% 
  spread(var, value, convert=TRUE) 
  

# out4 <- out3 %>% 
#   transmute(variables = mivar,
#             CA_High_m = round(mean_CA_High, 3),
#             CA_High_sd = round(sd_CA_High, 3),
#             CA_High_l = tukey_CA_High,
#             CA_Low_m = round(mean_CA_Low, 3),
#             CA_Low_sd = round(sd_CA_Low, 3),
#             CA_Low_l = tukey_CA_Low,
#             SJ_High_m = round(mean_SJ_High, 3),
#             SJ_High_sd = round(sd_SJ_High, 3),
#             SJ_High_l = tukey_SJ_High,
#             SJ_Low_m = round(mean_SJ_Low, 3),
#             SJ_Low_sd = round(sd_SJ_Low, 3),
#             SJ_Low_l = tukey_SJ_Low)

out4 <- out3 %>% 
  transmute(variables = mivar,
            caH_m = round(mean_caH, 3),
            caH_sd = round(sd_caH, 3),
            caH_l = tukey_caH,
            caL_m = round(mean_caL, 3),
            caL_sd = round(sd_caL, 3),
            caL_l = tukey_caL,
            sj_m = round(mean_sj, 3),
            sj_sd = round(sd_sj, 3),
            sj_l = tukey_sj)
            

# Export data 
# write.csv(out4, file=paste(di, "data/proto_tables/site_features.csv", sep=""), row.names = FALSE)
write.csv(out4, file=paste(di, "data/competence/resumen_medias_indices_competencia.csv", sep=""), row.names = FALSE)

pander(out4, caption='Summary Values')
```

# General topo of the sites 

```{r}
topo_site <- topo %>% group_by(site) %>% summarise(
  elev_mean = mean(mde), 
  elev_min = min(mde), 
  elev_max = max(mde), 
  slope_mean = mean(slope)
)


site_general <- general_var %>% 
  left_join(coord_sites, by='site') %>% 
  left_join(topo_site, by='site') 

write.csv(site_general, file=paste(di, "data/sites_summary/site_general.csv", sep=""), row.names = FALSE)
```         


                 


