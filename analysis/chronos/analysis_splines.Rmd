---
title: "chronos_splines"
author: "AJ Perez-Luque (@ajpelu)"
date: "2017 Dec"
output:  
  md_document:
    variant: markdown_github
bibliography: ../references.bib
csl: ../ecology.csl
---

```{r global_options, include=FALSE}
knitr::opts_chunk$set(fig.width=12, fig.height=8,warning=FALSE, message=FALSE)
```


```{r, warning=FALSE, message=FALSE}
library("tidyverse")
library("stringr")
library("dplR")
library("knitr")
# library("detrendeR")
library("pander")
```

# Read y Prepare data 
* Leer datos `rwl` de SJ y CA

```{r, echo=FALSE}
machine <- 'ajpelu'
# machine <- 'ajpeluLap'
di <- paste0('/Users/', machine, '/Dropbox/phd/phd_repos/qpyr_dendro/', sep='')

# sj 
sj <- read.rwl(fname=paste0(di, '/data_raw/dendro_ring/sn_sanjuan/sn_sanjuan.rwl'), format="tucson")

# canar 
ca <- read.rwl(fname=paste0(di, '/data_raw/dendro_ring/sn_canar/sn_canar.rwl'), format="tucson")
```

Computar RWI para tres sitios CA_High, CA_Low, SJ.  

# Preparar datos para computar RWI 
```{r}
source(paste0(di, 'script/R/computeSpline.R'))
```

```{r}
# Replace SNA by SJ and SNB by CA
names(ca) <- stringr::str_replace(names(ca), "SNB", "CA") 
names(sj) <- stringr::str_replace(names(sj), "SNA", "SJ")

# Remove g in name of some cores of CA. 
names(ca) <- stringr::str_replace(names(ca), "g", "")
```

* Crear dataframes `rwl` por cada sitio CA_High, CA_Low, SJ

```{r}
# Create subset to compare between sites 
caL <- ca[,c("CA0101","CA0102","CA0201","CA0202","CA0301","CA0302","CA0401","CA0402","CA0501","CA0502",
             "CA0601","CA0602","CA0701","CA0702","CA0801","CA0802","CA0901","CA0902","CA1001","CA1002",
             "CA2601","CA2602","CA2701","CA2702","CA2801","CA2802","CA2901","CA2902","CA3001","CA3002")] 
caH <- ca[, c("CA1101","CA1102","CA1201","CA1202","CA1301","CA1302","CA1401","CA1402","CA1501","CA1502",
              "CA1601","CA1602","CA1701","CA1702","CA1801","CA1802","CA1901","CA1902","CA2001","CA2002",
              "CA2101","CA2102","CA2201","CA2202","CA2301","CA2302","CA2401","CA2402","CA2501","CA2502")]

# remove the rows with NA across all columns 
caL <- caL[rowSums(is.na(caL))!=ncol(caL), ]

```


## Compute RWI 

```{r}
rwi_sj <- computeSpline(rwdf = sj, nsmooth = 30)
rwi_caL <- computeSpline(rwdf = caL, nsmooth = 30)
rwi_caH <- computeSpline(rwdf = caH, nsmooth = 30)

# Export data 
write.csv(rwi_sj, file=paste(di, "data/rwi/rwi_sj.csv", sep=""), row.names = TRUE)
write.csv(rwi_caL, file=paste(di, "data/rwi/rwi_caL.csv", sep=""), row.names = TRUE)
write.csv(rwi_caH, file=paste(di, "data/rwi/rwi_caH.csv", sep=""), row.names = TRUE)
```


### Summary dendrochronology statistics

* Por cada site (ca_high, ca_low, sj) calculamos los estadísticos de la serie rwi. En concreto: 

:red_circle: DUDAS cual utilizar como reportes 
    
## By site 

```{r}

objects_rwi <- c('rwi_caL','rwi_caH','rwi_sj')

out <- c() 

for (i in objects_rwi){ 
  
  aux <- get(i)
  name_aux <- sub(".*\\_", '', i)
  
  # Get ids 
  aux_ids <- read.ids(aux, stc = c(2,2,2))
  
  # Stats of RWI 
  aux_stats <- rwi.stats(aux, ids = aux_ids)
  
  # Add site 
  aux_stats$site <- as.factor(name_aux)
  
  out <- rbind(out, aux_stats)
  }


rwi_statistics <- out 

rwi_statistics %>% 
  write.csv(file=paste(di, "data/dendro_summary/site3_dendro_rwi.csv", sep=""), row.names = FALSE)

pander(rwi_statistics, caption='Dendrochronological summary by sites') 
```


## Compute residual chronologies 

A partir de cada serie (RWI) vamos a computar chronologias por sitio. 

* Cada serie RWI se somete a un modelo autorregresivo (pre-withening) y posteriormente se calcula el promedio para cada año mediante una estimación robusta de la media (biweight). 

* La calidad estadistica de cada serie se chequeó via la EPS (expressed population signal) [@Wigley1984]. Se calculó para cada serie la EPS utilizando una ventana temporal de 30 años. 
* Posteriormente, a threshold value of EPS >0.85 was used to determine the cutoff year of the time span that could be considered reliable 


```{r}

objects_rwi <- c('rwi_caL','rwi_caH','rwi_sj')

out <- c() 
out_eps <- c() 

for (i in objects_rwi){ 
  
  aux <- get(i)
  
  name_aux <- sub(".*\\_", '', i)
  
  # Compute chrono 
  crono_aux <- chron(aux, prefix = "", biweight = TRUE, prewhiten = TRUE)
  
  # Add year and site 
  crono_aux$year <- as.numeric(row.names(crono_aux))
  crono_aux$site <- as.factor(name_aux) 
  
  # name export 
  nameexport <- paste0("cro_", name_aux) 
  
  assign(nameexport, crono_aux)
  
  
  # eps 
  # Get ids 
  aux_ids <- read.ids(aux, stc = c(2,2,2))
  
  # eps cutoff
  aux_stats <- rwi.stats.running(aux, ids = aux_ids, window.length = 30)
  
  aux_eps <- data.frame(year = c(min(crono_aux$year), 
                                aux_stats$mid.year, 
                                max(crono_aux$year)),
                       eps = c(NA, aux_stats$eps, NA), 
                       site = as.factor(name_aux))
  
  
  
  out <- rbind(out, crono_aux)
  out_eps <- rbind(out_eps, aux_eps)
  }



# cronos 
cro_rwi <- out

# Export data 
write.csv(cro_rwi, file=paste(di, "data/cronos_medias/cronos_sites_rwi.csv", sep=""), row.names = FALSE)
```

# Obtener el año a partir del cual podemos considerar reliable la chrono. 
## eps 

```{r}
# eps umbral 
eps_cut <- 0.85
year_cutoffs <- 
  out_eps %>% 
  group_by(site) %>% 
  # filter(eps < eps_cut) %>% 
  slice(which.max(eps < eps_cut)) %>% as.data.frame()

pander(year_cutoffs) 
```

Ojo el año es el mid year del periodo considerado. Por ejemplo para SJ, todos los valores de EPS son mayores del valor del umbral, y coincide que el menor valor de eps es el del primer periodo. Ojo a eso.

## sample depth 
```{r}
# ssamp.depth
sample_treshold <- 5 

year_sampledepth <- 
  cro_rwi %>% 
  group_by(site) %>% 
  # filter(eps < eps_cut) %>% 
  slice(which.max(samp.depth > sample_treshold)) %>% as.data.frame()

pander(year_sampledepth) 
```



### Plots of RWI 

```{r}
cro_rwi <- cro_rwi %>% 
  mutate(site_sorted = case_when(
    site == "sj" ~ "0_sj", 
    site == "caH" ~ "1_caH",
    site == "caL" ~ "2_caL"))


year_cutoffs <- year_cutoffs %>% 
  mutate(site_sorted = case_when(
    site == "sj" ~ "0_sj", 
    site == "caH" ~ "1_caH",
    site == "caL" ~ "2_caL"))

year_sampledepth <- year_sampledepth %>% 
  mutate(site_sorted = case_when(
    site == "sj" ~ "0_sj", 
    site == "caH" ~ "1_caH",
    site == "caL" ~ "2_caL")
```

Plots de las cronos, añadiendo líneas para los años de sequía 1995, 2005 y 2012 (líneas negras) y líneas para los años con valor eps > 0.85 (ver ejemplo paper Dorado-liñan https://link.springer.com/article/10.1007/s00484-017-1410-5). También añado una con el sample depth > 5 (línea azul). Escoger uno de los dos criterios. Preguntar a G. Gea 

```{r, rwi_crono}
label_site <- c("0_sj" = "Northern (SJ)",
                "1_caH" = "Southern High (CaH)",
                "2_caL" = "Southern Low (CaL)")

# 
plot_rwi_crono <- ggplot(cro_rwi, aes(x=year, y=res)) +
  theme_bw() + 
  theme(panel.grid = element_blank(), 
        strip.background = element_rect(fill = "white"),
        strip.text = element_text(face="bold", size=12), 
        axis.text = element_text(face="bold", size=10), 
        axis.title = element_text(face="bold", size=12)) + 
  geom_hline(yintercept = 1, colour = "grey") + 
  geom_line(size=.8) + scale_y_continuous(breaks = seq(0.4,1.8, 0.2)) +
  facet_wrap(~site_sorted, scales = "fixed", ncol = 1,
             labeller = as_labeller(label_site)) + 
  ylab("Ring width index") + xlab("Year") + 
  geom_vline(xintercept = c(1995, 2005, 2012), linetype = "dotted") + 
  geom_vline(aes(xintercept = year), data = year_cutoffs,  linetype = "dashed", colour='red') + 
  geom_vline(aes(xintercept = year), data = year_sampledepth,  linetype = "dashed", colour='blue') +
  scale_x_continuous(limits = c(1819, 2016), 
                     breaks= seq(1820, 2020, by=20))
  
  
plot_rwi_crono   
ggsave(plot=plot_rwi_crono, width=8, height = 6,
       filename=paste0(di, 'out/chronos_rwi/rwi_crono_3sites.pdf')) 
```


```{r, rwi_crono_1950}
plot_rwi_crono50 <- cro_rwi %>% 
  filter(year > 1949) %>% 
  ggplot(aes(x=year, y=res)) +
  theme_bw() + 
  theme(panel.grid = element_blank( ), 
        strip.background = element_rect(fill = "white"),
        strip.text = element_text(face="bold", size=12), 
        axis.text = element_text(face="bold", size=10), 
        axis.title = element_text(face="bold", size=12)) + 
  geom_hline(yintercept = 1, colour = "grey") + 
  geom_line(size=.8) + scale_y_continuous(breaks = seq(0.4,1.8, 0.2)) +
  facet_wrap(~site_sorted, scales = "fixed", ncol = 1,
             labeller = as_labeller(label_site)) + 
  ylab("Ring width index") + xlab("Year") + 
  geom_vline(xintercept = c(1995, 2005, 2012), linetype = "dotted") +
  scale_x_continuous(limits = c(1950, 2016), 
                     breaks = seq(1950, 2016, by=10))

plot_rwi_crono50   
ggsave(plot=plot_rwi_crono50, width=8, height = 6,
       filename=paste0(di, 'out/chronos_rwi/rwi_crono_3sites50.pdf')) 

```

VAS POR AQUI 



# CLIMATE RELATIONSHIPS 
```{r}


library(ncdf4)

nc <- nc_open( "/Users/ajpelu/Downloads/climaobs/tg_0.25deg_reg_v16.0.nc")
print(nc)

lon <- ncvar_get(nc,"longitude")


http://geog.uoregon.edu/bartlein/courses/geog490/week04-netCDF.html#open-the-netcdf-file 






eobs 

untar("/Users/ajpelu/Downloads/climaobs/tg_0.25deg_reg_v16.0.nc", exdir = "/Users/ajpelu/Downloads/climaobs")


# Precipitation dataset URL
ds <- "/Users/ajpelu/Downloads/climaobs/tg_0.25deg_reg_v16.0.nc" 

di <- dataInventory("/Users/ajpelu/Downloads/climaobs/tg_0.25deg_reg_v16.0.nc")
  "http://opendap.knmi.nl/knmi/thredds/dodsC/e-obs_0.25regular/rr_0.25deg_reg_v16.0.nc"
  

http://meteo.unican.es/work/loadeR/wiki/html/OaccessingLoadingStationData.html
download.file("http://meteo.unican.es/work/loadeR/data/VALUE_ECA_86_v2.tar.gz", destfile ="/Users/ajpelu/Downloads/climaobs/VALUE_ECA_86_v2.tar.gz")  
  
value <- "/Users/ajpelu/Downloads/climaobs/VALUE_ECA_86_v2"

di <-dataInventory(value)



?loa





precip  <- loadGridData(dataset = ds,
			   var = "rr",
			   lonLim = -3.428,
			   latLim = 36.957,
			   years = 1950:2016,
			   season = 1:12)

```



Resilience RWI ??? 

# RESILIENCE RWI 








