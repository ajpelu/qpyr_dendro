---
title: "chronos_splines"
author: "AJ Perez-Luque (@ajpelu)"
date: "2017 Dec"
output:  
  md_document:
    variant: markdown_github
bibliography: ../references.bib
csl: ../ecology.csl
---

```{r global_options, include=FALSE}
knitr::opts_chunk$set(fig.width=12, fig.height=8,warning=FALSE, message=FALSE)
```


```{r, warning=FALSE, message=FALSE}
library("tidyverse")
library("stringr")
library("dplR")
library("knitr")
# library("detrendeR")
library("pander")
library("gridExtra")
```

# Read y Prepare data 
* Leer datos `rwl` de SJ y CA

```{r, echo=FALSE}
machine <- 'ajpelu'
# machine <- 'ajpeluLap'
di <- paste0('/Users/', machine, '/Dropbox/phd/phd_repos/qpyr_dendro/', sep='')

# sj 
sj <- read.rwl(fname=paste0(di, '/data_raw/dendro_ring/sn_sanjuan/sn_sanjuan.rwl'), format="tucson")

# canar 
ca <- read.rwl(fname=paste0(di, '/data_raw/dendro_ring/sn_canar/sn_canar.rwl'), format="tucson")
```

Computar RWI para tres sitios CA_High, CA_Low, SJ.  

# Preparar datos para computar RWI 
```{r}
source(paste0(di, 'script/R/computeSpline.R'))
source(paste0(di, 'script/R/rw_byTree.R'))
source(paste0(di, 'script/R/rwiResilience.R'))
```

```{r}
# Replace SNA by SJ and SNB by CA
names(ca) <- stringr::str_replace(names(ca), "SNB", "CA") 
names(sj) <- stringr::str_replace(names(sj), "SNA", "SJ")

# Remove g in name of some cores of CA. 
names(ca) <- stringr::str_replace(names(ca), "g", "")
```

* Crear dataframes `rwl` por cada sitio CA_High, CA_Low, SJ

```{r}
# Create subset to compare between sites 
caL <- ca[,c("CA0101","CA0102","CA0201","CA0202","CA0301","CA0302","CA0401","CA0402","CA0501","CA0502",
             "CA0601","CA0602","CA0701","CA0702","CA0801","CA0802","CA0901","CA0902","CA1001","CA1002",
             "CA2601","CA2602","CA2701","CA2702","CA2801","CA2802","CA2901","CA2902","CA3001","CA3002")] 
caH <- ca[, c("CA1101","CA1102","CA1201","CA1202","CA1301","CA1302","CA1401","CA1402","CA1501","CA1502",
              "CA1601","CA1602","CA1701","CA1702","CA1801","CA1802","CA1901","CA1902","CA2001","CA2002",
              "CA2101","CA2102","CA2201","CA2202","CA2301","CA2302","CA2401","CA2402","CA2501","CA2502")]

# remove the rows with NA across all columns 
caL <- caL[rowSums(is.na(caL))!=ncol(caL), ]

```


## Compute RWI 

```{r}
rwi_sj <- computeSpline(rwdf = sj, nsmooth = 30)
rwi_caL <- computeSpline(rwdf = caL, nsmooth = 30)
rwi_caH <- computeSpline(rwdf = caH, nsmooth = 30)

# Export data 
write.csv(rwi_sj, file=paste(di, "data/rwi/rwi_sj.csv", sep=""), row.names = TRUE)
write.csv(rwi_caL, file=paste(di, "data/rwi/rwi_caL.csv", sep=""), row.names = TRUE)
write.csv(rwi_caH, file=paste(di, "data/rwi/rwi_caH.csv", sep=""), row.names = TRUE)
```


### Summary dendrochronology statistics

* Por cada site (ca_high, ca_low, sj) calculamos los estadísticos de la serie rwi. En concreto: 

:red_circle: DUDAS cual utilizar como reportes 
    
## By site 

```{r}

objects_rwi <- c('rwi_caL','rwi_caH','rwi_sj')

out <- c() 

for (i in objects_rwi){ 
  
  aux <- get(i)
  name_aux <- sub(".*\\_", '', i)
  
  # Get ids 
  aux_ids <- read.ids(aux, stc = c(2,2,2))
  
  # Stats of RWI 
  aux_stats <- rwi.stats(aux, ids = aux_ids)
  
  # Add site 
  aux_stats$site <- as.factor(name_aux)
  
  out <- rbind(out, aux_stats)
  }


rwi_statistics <- out 

rwi_statistics %>% 
  write.csv(file=paste(di, "data/dendro_summary/site3_dendro_rwi.csv", sep=""), row.names = FALSE)

pander(rwi_statistics, caption='Dendrochronological summary by sites') 
```


## Compute residual chronologies 

A partir de cada serie (RWI) vamos a computar chronologias por sitio. 

* Cada serie RWI se somete a un modelo autorregresivo (pre-withening) y posteriormente se calcula el promedio para cada año mediante una estimación robusta de la media (biweight). 

* La calidad estadistica de cada serie se chequeó via la EPS (expressed population signal) [@Wigley1984]. Se calculó para cada serie la EPS utilizando una ventana temporal de 30 años. 
* Posteriormente, a threshold value of EPS >0.85 was used to determine the cutoff year of the time span that could be considered reliable 


```{r}

objects_rwi <- c('rwi_caL','rwi_caH','rwi_sj')

out <- c() 
out_eps <- c() 

for (i in objects_rwi){ 
  
  aux <- get(i)
  
  name_aux <- sub(".*\\_", '', i)
  
  # Compute chrono 
  crono_aux <- chron(aux, prefix = "", biweight = TRUE, prewhiten = TRUE)
  
  # Add year and site 
  crono_aux$year <- as.numeric(row.names(crono_aux))
  crono_aux$site <- as.factor(name_aux) 
  
  # name export 
  nameexport <- paste0("cro_", name_aux) 
  
  assign(nameexport, crono_aux)
  
  
  # eps 
  # Get ids 
  aux_ids <- read.ids(aux, stc = c(2,2,2))
  
  # eps cutoff
  aux_stats <- rwi.stats.running(aux, ids = aux_ids, window.length = 30)
  
  aux_eps <- data.frame(year = c(min(crono_aux$year), 
                                aux_stats$mid.year, 
                                max(crono_aux$year)),
                       eps = c(NA, aux_stats$eps, NA), 
                       site = as.factor(name_aux))
  
  
  
  out <- rbind(out, crono_aux)
  out_eps <- rbind(out_eps, aux_eps)
  }



# cronos 
cro_rwi <- out

# Export data 
write.csv(cro_rwi, file=paste(di, "data/cronos_medias/cronos_sites_rwi.csv", sep=""), row.names = FALSE)
```

# Obtener el año a partir del cual podemos considerar reliable la chrono. 
## eps 

```{r}
# eps umbral 
eps_cut <- 0.85
year_cutoffs <- 
  out_eps %>% 
  group_by(site) %>% 
  # filter(eps < eps_cut) %>% 
  slice(which.max(eps < eps_cut)) %>% as.data.frame()

pander(year_cutoffs) 
```

Ojo el año es el mid year del periodo considerado. Por ejemplo para SJ, todos los valores de EPS son mayores del valor del umbral, y coincide que el menor valor de eps es el del primer periodo. Ojo a eso.

## sample depth 
```{r}
# ssamp.depth
sample_treshold <- 5 

year_sampledepth <- 
  cro_rwi %>% 
  group_by(site) %>% 
  # filter(eps < eps_cut) %>% 
  slice(which.max(samp.depth > sample_treshold)) %>% as.data.frame()

pander(year_sampledepth) 
```



### Plots of RWI 

```{r}
cro_rwi <- cro_rwi %>% 
  mutate(site_sorted = case_when(
    site == "sj" ~ "0_sj", 
    site == "caH" ~ "1_caH",
    site == "caL" ~ "2_caL"))


year_cutoffs <- year_cutoffs %>% 
  mutate(site_sorted = case_when(
    site == "sj" ~ "0_sj", 
    site == "caH" ~ "1_caH",
    site == "caL" ~ "2_caL"))

year_sampledepth <- year_sampledepth %>% 
  mutate(site_sorted = case_when(
    site == "sj" ~ "0_sj", 
    site == "caH" ~ "1_caH",
    site == "caL" ~ "2_caL"))
```

Plots de las cronos, añadiendo líneas para los años de sequía 1995, 2005 y 2012 (líneas negras) y líneas para los años con valor eps > 0.85 (ver ejemplo paper Dorado-liñan https://link.springer.com/article/10.1007/s00484-017-1410-5). También añado una con el sample depth > 5 (línea azul). Escoger uno de los dos criterios. Preguntar a G. Gea 

```{r, rwi_crono}
label_site <- c("0_sj" = "Northern (SJ)",
                "1_caH" = "Southern High (CaH)",
                "2_caL" = "Southern Low (CaL)")

# 
plot_rwi_crono <- ggplot(cro_rwi, aes(x=year, y=res)) +
  theme_bw() + 
  theme(panel.grid = element_blank(), 
        strip.background = element_rect(fill = "white"),
        strip.text = element_text(face="bold", size=12), 
        axis.text = element_text(face="bold", size=10), 
        axis.title = element_text(face="bold", size=12)) + 
  geom_hline(yintercept = 1, colour = "grey") + 
  geom_line(size=.8) + scale_y_continuous(breaks = seq(0.4,1.8, 0.2)) +
  facet_wrap(~site_sorted, scales = "fixed", ncol = 1,
             labeller = as_labeller(label_site)) + 
  ylab("Ring width index") + xlab("Year") + 
  geom_vline(xintercept = c(1995, 2005, 2012), linetype = "dotted") + 
  geom_vline(aes(xintercept = year), data = year_cutoffs,  linetype = "dashed", colour='red') + 
  geom_vline(aes(xintercept = year), data = year_sampledepth,  linetype = "dashed", colour='blue') +
  scale_x_continuous(limits = c(1819, 2016), 
                     breaks= seq(1820, 2020, by=20))
  
  
plot_rwi_crono   
ggsave(plot=plot_rwi_crono, width=8, height = 6,
       filename=paste0(di, 'out/chronos_rwi/rwi_crono_3sites.pdf')) 
```


```{r, rwi_crono_1950}
plot_rwi_crono50 <- cro_rwi %>% 
  filter(year > 1949) %>% 
  ggplot(aes(x=year, y=res)) +
  theme_bw() + 
  theme(panel.grid = element_blank( ), 
        strip.background = element_rect(fill = "white"),
        strip.text = element_text(face="bold", size=12), 
        axis.text = element_text(face="bold", size=10), 
        axis.title = element_text(face="bold", size=12)) + 
  geom_hline(yintercept = 1, colour = "grey") + 
  geom_line(size=.8) + scale_y_continuous(breaks = seq(0.4,1.8, 0.2)) +
  facet_wrap(~site_sorted, scales = "fixed", ncol = 1,
             labeller = as_labeller(label_site)) + 
  ylab("Ring width index") + xlab("Year") + 
  geom_vline(xintercept = c(1995, 2005, 2012), linetype = "dotted") +
  scale_x_continuous(limits = c(1950, 2016), 
                     breaks = seq(1950, 2016, by=10))

plot_rwi_crono50   
ggsave(plot=plot_rwi_crono50, width=8, height = 6,
       filename=paste0(di, 'out/chronos_rwi/rwi_crono_3sites50.pdf')) 

```


# Resilience 


* Computar métricas de resiliencia RWI para los tres sitios. 
* Computar tres eventos climáticos: 1995, 2005, 2012
* Computar ventanas temporales: 2, 3 y 4 

## Aggregate RWI by tree 

* Agregar valores medios de RWI por site (obtenemos sj_tree / caL_tree, caH_tree) 
* ver fun rw_byTree (utilizada para bai_resilience.Rmd)

```{r}
# Remember snc = structure of core name SJ0101 (site | tree | core)
rwi_sj_tree <- rw_byTree(rwi_sj, snc =c(2,2,2), locname = 'SJ')
rwi_caL_tree <- rw_byTree(rwi_caL, snc =c(2,2,2), locname = 'CA')
rwi_caH_tree <- rw_byTree(rwi_caH, snc =c(2,2,2), locname = 'CA')
```


```{r}
# Drought years 
dyears <- c(1995, 2005, 2012)

# SJ 
res_4_sj <- rwiResilience(rwi_sj_tree, event_years = dyears, window = 4)
res_3_sj <- rwiResilience(rwi_sj_tree, event_years = dyears, window = 3)
res_2_sj <- rwiResilience(rwi_sj_tree, event_years = dyears, window = 2)

# caL
res_4_caL <- rwiResilience(rwi_caL_tree, event_years = dyears, window = 4)
res_3_caL <- rwiResilience(rwi_caL_tree, event_years = dyears, window = 3)
res_2_caL <- rwiResilience(rwi_caL_tree, event_years = dyears, window = 2)

# caH
res_4_caH <- rwiResilience(rwi_caH_tree , event_years = dyears, window = 4)
res_3_caH <- rwiResilience(rwi_caH_tree , event_years = dyears, window = 3)
res_2_caH <- rwiResilience(rwi_caH_tree , event_years = dyears, window = 2)
```


### Computar correlaciones ventanas temporales 
```{r, echo = FALSE}
# Vector with objects name
obj <- c('res_2_sj', 'res_3_sj', 'res_4_sj',
         'res_2_caL', 'res_3_caL', 'res_4_caL',
         'res_2_caH', 'res_3_caH', 'res_4_caH')

correla_ws <- c()

for (i in obj){ 
  x <- get(i)
  xres <- x$resilience
  out <- xres %>% 
    mutate(ws = paste0('ws_', as.character(str_extract(i, "([0-9])"))),
           site = str_replace(i, "res_[0-9]_", '')) %>%
    dplyr::select(-disturb_year, -tree)
             
  correla_ws <- bind_rows(correla_ws, out)

}

# Split by window size 
correla <- correla_ws %>% split(.$ws) 

# Change names 
names(correla[["ws_2"]])[1:4] <- paste0(names(correla[["ws_2"]])[1:4], '2')
names(correla[["ws_3"]])[1:4] <- paste0(names(correla[["ws_3"]])[1:4], '3')
names(correla[["ws_4"]])[1:4] <- paste0(names(correla[["ws_4"]])[1:4], '4')

cor2 <- correla[["ws_2"]] %>% dplyr::select(-ws) %>% mutate(ind = row_number())
cor3 <- correla[["ws_3"]] %>% dplyr::select(-ws) %>% mutate(ind = row_number())
cor4 <- correla[["ws_4"]] %>% dplyr::select(-ws) %>% mutate(ind = row_number())


correlations <- inner_join(cor2, cor3, by='ind') %>% inner_join(cor4, by='ind')
```


#### Resistance 

```{r correla_temporal_window_rt, echo = FALSE}
# Resistance
aux_coefs <- c()

model <- lm(rt2~rt3, data=correlations)
p_rt23 <- correlations %>% ggplot(aes(rt2, rt3)) + 
  geom_point(aes(colour=site.x)) + theme_bw() + geom_smooth(method = 'lm', se=FALSE) + 
  ggtitle(paste('rt (R2) = ', round(summary(model)$r.squared, 3))) + 
  theme(legend.position = c(.2, .75))
aux <- as.data.frame(cbind('rt','2-3', as.numeric(summary(model)$r.squared)))
aux_coefs <- rbind(aux_coefs, aux)

model <- lm(rt2~rt4, data=correlations)
p_rt24 <- correlations %>% ggplot(aes(rt2, rt4)) + 
  geom_point(aes(colour=site.x)) + theme_bw() + geom_smooth(method = 'lm', se=FALSE) + 
  ggtitle(paste('rt (R2) = ', round(summary(model)$r.squared, 3))) +
  theme(legend.position = 'none')
aux <- as.data.frame(cbind('rt','2-4', as.numeric(summary(model)$r.squared)))
aux_coefs <- rbind(aux_coefs, aux)

model <- lm(rt3~rt4, data=correlations)
p_rt34 <- correlations %>% ggplot(aes(rt3, rt4)) + 
  geom_point(aes(colour=site.x)) + theme_bw() + geom_smooth(method = 'lm', se=FALSE) + 
  ggtitle(paste('rt (R2) = ', round(summary(model)$r.squared, 3))) +
  theme(legend.position = 'none')
aux <- as.data.frame(cbind('rt','3-4', as.numeric(summary(model)$r.squared)))
aux_coefs <- rbind(aux_coefs, aux)

grid.arrange(p_rt23, p_rt24, p_rt34,ncol=3) 
```


#### Recovery

```{r correla_temporal_window_rc, echo = FALSE}
# Recovery 
model <- lm(rc2~rc3, data=correlations)
p_rc23 <- correlations %>% ggplot(aes(rc2, rc3)) + 
  geom_point(aes(colour=site.x)) + theme_bw() + geom_smooth(method = 'lm', se=FALSE) + 
  ggtitle(paste('rc (R2) = ', round(summary(model)$r.squared, 3))) + 
  theme(legend.position = c(.2, .75))
aux <- as.data.frame(cbind('rc','2-3', as.numeric(summary(model)$r.squared)))
aux_coefs <- rbind(aux_coefs, aux)


model <- lm(rc2~rc4, data=correlations)
p_rc24 <- correlations %>% ggplot(aes(rc2, rc4)) + 
  geom_point(aes(colour=site.x)) + theme_bw() + geom_smooth(method = 'lm', se=FALSE) + 
  ggtitle(paste('rc (R2) = ', round(summary(model)$r.squared, 3))) +
  theme(legend.position = 'none')
aux <- as.data.frame(cbind('rc','2-4', as.numeric(summary(model)$r.squared)))
aux_coefs <- rbind(aux_coefs, aux)


model <- lm(rc3~rc4, data=correlations)
p_rc34 <- correlations %>% ggplot(aes(rc3, rc4)) + 
  geom_point(aes(colour=site.x)) + theme_bw() + geom_smooth(method = 'lm', se=FALSE) + 
  ggtitle(paste('rc (R2) = ', round(summary(model)$r.squared, 3))) +
  theme(legend.position = 'none')
aux <- as.data.frame(cbind('rc','3-4', as.numeric(summary(model)$r.squared)))
aux_coefs <- rbind(aux_coefs, aux)


grid.arrange(p_rc23, p_rc24, p_rc34,ncol=3) 
```


#### Resilience

```{r correla_temporal_window_rs, echo = FALSE}
# Resilience
model <- lm(rs2~rs3, data=correlations)
p_rs23 <- correlations %>% ggplot(aes(rs2, rs3)) + 
  geom_point(aes(colour=site.x)) + theme_bw() + geom_smooth(method = 'lm', se=FALSE) + 
  ggtitle(paste('rs (R2) = ', round(summary(model)$r.squared, 3))) + 
  theme(legend.position = c(.2, .75))
aux <- as.data.frame(cbind('rs','2-3', as.numeric(summary(model)$r.squared)))
aux_coefs <- rbind(aux_coefs, aux)

model <- lm(rs2~rs4, data=correlations)
p_rs24 <- correlations %>% ggplot(aes(rs2, rs4)) + 
  geom_point(aes(colour=site.x)) + theme_bw() + geom_smooth(method = 'lm', se=FALSE) + 
  ggtitle(paste('rs (R2) = ', round(summary(model)$r.squared, 3))) +
  theme(legend.position = 'none')
aux <- as.data.frame(cbind('rs','2-4', as.numeric(summary(model)$r.squared)))
aux_coefs <- rbind(aux_coefs, aux)

model <- lm(rs3~rs4, data=correlations)
p_rs34 <- correlations %>% ggplot(aes(rs3, rs4)) + 
  geom_point(aes(colour=site.x)) + theme_bw() + geom_smooth(method = 'lm', se=FALSE) + 
  ggtitle(paste('rs (R2) = ', round(summary(model)$r.squared, 3))) +
  theme(legend.position = 'none')
aux <- as.data.frame(cbind('rs','3-4', as.numeric(summary(model)$r.squared)))
aux_coefs <- rbind(aux_coefs, aux)

grid.arrange(p_rs23, p_rs24, p_rs34,ncol=3) 
```

#### Relative Resilience

```{r correla_temporal_window_rrs, echo = FALSE}
# Relative Resilience
model <- lm(rrs2~rrs3, data=correlations)
p_rrs23 <- correlations %>% ggplot(aes(rrs2, rrs3)) + 
  geom_point(aes(colour=site.x)) + theme_bw() + geom_smooth(method = 'lm', se=FALSE) + 
  ggtitle(paste('rrs (R2) = ', round(summary(model)$r.squared, 3))) + 
  theme(legend.position = c(.2, .75))
aux <- as.data.frame(cbind('rrs','2-3', as.numeric(summary(model)$r.squared)))
aux_coefs <- rbind(aux_coefs, aux)

model <- lm(rrs2~rrs4, data=correlations)
p_rrs24 <- correlations %>% ggplot(aes(rrs2, rrs4)) + 
  geom_point(aes(colour=site.x)) + theme_bw() + geom_smooth(method = 'lm', se=FALSE) + 
  ggtitle(paste('rrs (R2) = ', round(summary(model)$r.squared, 3))) +
  theme(legend.position = 'none')
aux <- as.data.frame(cbind('rrs','2-4', as.numeric(summary(model)$r.squared)))
aux_coefs <- rbind(aux_coefs, aux)

model <- lm(rrs3~rrs4, data=correlations)
p_rrs34 <- correlations %>% ggplot(aes(rrs3, rrs4)) + 
  geom_point(aes(colour=site.x)) + theme_bw() + geom_smooth(method = 'lm', se=FALSE) + 
  ggtitle(paste('rrs (R2) = ', round(summary(model)$r.squared, 3))) +
  theme(legend.position = 'none')
aux <- as.data.frame(cbind('rrs','3-4', as.numeric(summary(model)$r.squared)))
aux_coefs <- rbind(aux_coefs, aux)

grid.arrange(p_rrs23, p_rrs24, p_rrs34,ncol=3) 
```


#### Coeficientes de correlacion entre ventanas temporales

```{r echo=FALSE}
# Export correlations window size 
names(aux_coefs) <- c('var', 'window_size', 'r2')

write.csv(aux_coefs, file=paste0(di, '/out/correla_resilience/correla_window_size_rwi.csv'), row.names = F)
```

```{r}
aux_coefs %>% pander()
```


Nos quedamos con 3 años de ventana temporal. 

# Plots Crecimiento
## Boxplot with outliers 
```{r rwi_disturbances_boxplot, echo = FALSE}
gsj <- res_3_sj$rwi %>% mutate(site='SJ')
gcaL <- res_3_caL$rwi %>% mutate(site='caL')
gcaH <- res_3_caH$rwi %>% mutate(site='caH')

g <- bind_rows(gsj, gcaL, gcaH)

# Export csv 
write.csv(g, file=paste0(di, 'data/resilience/rwi_drought.csv'), row.names = FALSE)

g %>% mutate(disturb = dplyr::recode(disturb, 
                              dr = '1_dr', pre = '0_pre', post = '2_post')) %>%
  ggplot(aes(y=mean_period, x=disturb)) + 
  geom_boxplot() + 
  facet_grid(site~disturb_year, scales='free_y') + 
  theme_bw()
``` 

## Mean + se 
```{r rwi_disturbances_mean_se, echo = FALSE}
g %>% 
  mutate(disturb = dplyr::recode(disturb, dr = '1_dr', pre = '0_pre', post = '2_post')) %>%
  group_by(disturb, disturb_year, site) %>% 
  summarise(mean = mean(mean_period),
            sd = sd(mean_period),
            se = sd/sqrt(length(mean_period))) %>%
  ggplot(aes(y=mean, x=disturb)) + 
  geom_errorbar(aes(ymin=mean - se, 
                    ymax=mean + se),
                width = 0.2) +
  geom_point(size=2, shape=21, fill='white') + 
  facet_grid(site~disturb_year, scales='free_y') + 
  theme_bw() + ylab('Ring width index') + 
  theme(panel.grid = element_blank())
```

```{r rwi_disturbances_mean_se_colours, echo = FALSE}
pgrowht <- g %>% 
  mutate(disturb = dplyr::recode(disturb, dr = '1_dr', pre = '0_pre', post = '2_post')) %>%
  group_by(disturb, disturb_year, site) %>% 
  summarise(mean = mean(mean_period),
            sd = sd(mean_period),
            se = sd/sqrt(length(mean_period))) %>%
  ggplot(aes(y=mean, x=disturb, colour=site)) + 
  geom_errorbar(aes(ymin=mean - se, 
                    ymax=mean + se),
                width = 0.15) +
  geom_point(size=3, aes(shape=site), fill='white') + 
  geom_line(aes(group=site))+
  facet_wrap(~disturb_year, scales='free_y') + 
  theme_bw() + ylab('Ring width index') +  
  scale_shape_manual(values=c(15,19,19)) + 
  theme(panel.grid = element_blank())

pgrowht
ggsave(plot=pgrowht, width=8, height = 4,
       filename=paste0(di, 'out/mean_resilience/rwi/rwi_mean.pdf')) 
```

## tables

```{r}
g %>% 
  mutate(disturb = dplyr::recode(disturb, dr = '1_dr', pre = '0_pre', post = '2_post')) %>%
  dplyr::group_by(site, disturb_year, disturb) %>% 
  dplyr::summarise(mean = mean(mean_period/100), 
                   sd = sd(mean_period/100),
                   se = sd/sqrt(length(mean_period/100))) %>% as.data.frame() %>% pander() 
```


# Prepare data of Resiliencia for ANOVAS
```{r}
# Prepara data 
rsj <- res_3_sj$resilience %>% mutate(site='SJ')
rcaL<- res_3_caL$resilience %>% mutate(site='caL')
rcaH <- res_3_caH$resilience %>% mutate(site='caH')

re <- bind_rows(rsj, rcaL, rcaH)
re$disturb_year <- as.factor(re$disturb_year)
re$site <- as.factor(re$site)

# Export csv 
write.csv(re, file=paste0(di, 'data/resilience/resilience_rwi.csv'), row.names = FALSE)
```


