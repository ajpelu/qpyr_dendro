---
title: "BAI resiliences ten droughts"
author: "AJ Perez-Luque (@ajpelu)"
output: 
  md_document:
    variant: markdown_github
bibliography: ../references.bib 
csl: ../ecology.csl
---

```{r global_options, include=FALSE}
knitr::opts_chunk$set(fig.width=12, fig.height=8, warning=FALSE, error=TRUE, message=FALSE)
```


```{r packages, warning=FALSE, message=FALSE, echo=FALSE}
library("here")
library("tidyverse")
library("dplR")
library("knitr")
library('gtable')
library('grid')
library('gridExtra')
library('stringr')
library('pander')
library('broom')
library('effects')
library('devtools')
library("ggrepel")
library("patchwork")
```
# Resilience 

* Calcularemos las métricas resiliencia de [@Lloret2011] sobre el crecimiento. 
* Vamos a calcularlas sobre el BAI de cada árbol. 
* Utilizaremos tres sitios: SJ, CAH y CAL (ver [./analysis/analysis_chronologies.md]('./analysis/analysis_chronologies.md)) 

## Prepare data 

* Leer datos `rwl` de SJ y CA
* Leer datos de diametros de los focal tree

```{r}
# machine <- 'ajpelu'

# machine <- 'ajpeluLap'

# di <- paste0('/Users/', machine, '/Dropbox/phd/phd_repos/qpyr_dendro/', sep = '')

# sj 
sj <- read.rwl(fname=here::here('data_raw/dendro_ring/sn_sanjuan', 'sn_sanjuan.rwl'), format="tucson")

# canar 
ca <- read.rwl(fname=here::here('data_raw/dendro_ring/sn_canar', 'sn_canar.rwl'), format="tucson")

# Read diameters data
compete <- read.csv(file=here::here('data_raw', 'dendro_competence.csv'), header=TRUE, sep=',')
```

```{r}
source(here::here('script/R','rw_byTree.R'))
source(here::here('script/R', 'bai_piovesan.R'))
source(here::here('script/R', 'baiResilience.R'))
```

* Crear dataframes `rwl` por cada sitio CA_High, CA_Low, SJ_High. SJ_Low
    
```{r, echo=FALSE}
# Replace SNA by SJ and SNB by CA
names(ca) <- stringr::str_replace(names(ca), "SNB", "CA") 
names(sj) <- stringr::str_replace(names(sj), "SNA", "SJ")

# Remove g in name of some cores of CA. 
names(ca) <- stringr::str_replace(names(ca), "g", "")
```


```{r, echo=FALSE}
# Create subset to compare between sites 
caL <- ca[,c("CA0101","CA0102","CA0201","CA0202","CA0301","CA0302","CA0401","CA0402","CA0501","CA0502",
             "CA0601","CA0602","CA0701","CA0702","CA0801","CA0802","CA0901","CA0902","CA1001","CA1002",
             "CA2601","CA2602","CA2701","CA2702","CA2801","CA2802","CA2901","CA2902","CA3001","CA3002")] 
caH <- ca[, c("CA1101","CA1102","CA1201","CA1202","CA1301","CA1302","CA1401","CA1402","CA1501","CA1502",
              "CA1601","CA1602","CA1701","CA1702","CA1801","CA1802","CA1901","CA1902","CA2001","CA2002",
              "CA2101","CA2102","CA2201","CA2202","CA2301","CA2302","CA2401","CA2402","CA2501","CA2502")]

```

* Lectura y preparación de datos de diámetro

```{r} 
# Prepare Diameter data 

# Compute diameter (mm)
compete <- compete %>% 
  mutate(dn_mm = (perim_mm / pi))

# Change name focal according to loc
compete <- compete %>% 
  mutate(id_focalLoc = stringr::str_replace_all(id_focal, c("A" = "SJ", "B" = "CA")))

         
# Get only focal trees, and only selected variables 
ft <- compete %>% 
  filter(sp=='Focal') %>% 
  filter(id_focal!='Fresno') %>% 
  dplyr::select(id_focal, id_focalLoc, loc, dn_mm, height_cm) 

# Set levels of eleveation 
ca_lowcode <- c(paste0('CA', str_pad(1:10, 2, pad='0')),
            paste0('CA', 26:30))
ca_highcode <- paste0('CA', 11:25)

ft <- ft %>% 
  mutate(site = as.factor(
    ifelse(id_focalLoc %in% ca_lowcode, 'CAL', 
           ifelse(id_focalLoc %in% ca_highcode, 'CAH', 'SJ'))))
```


# Aggregate RW by tree 

* Agregar valores medios de RW por site (obtenemos sj_tree / caL_tree, caH_tree) 
* ver fun rw_byTree o utilizar treeMean (dplR)

```{r}
# Remember snc = structure of core name SJ0101 (site | tree | core)
sj_tree <- rw_byTree(sj, snc =c(2,2,2), locname = 'SJ')
caL_tree <- rw_byTree(caL, snc =c(2,2,2), locname = 'CA')
caH_tree <- rw_byTree(caH, snc =c(2,2,2), locname = 'CA')
```

* Crear diferentes dataset de diametro por sitio 
```{r}
diam <- ft %>%
  mutate(diameter = dn_mm, 
         id = id_focalLoc) %>%
  dplyr::select(id, diameter, site) %>% 
  split(.$site) 


d_caH <- diam$CAH[,c('id','diameter')]
d_caL <- diam$CAL[,c('id','diameter')]
d_sj <- diam$SJ[,c('id','diameter')]
```


## Cómputo del BAI por site  

* He construido una funcion para el computo del BAI, teniendo en cuenta la aproximación de [@Piovesan2008]. Es similar a `bai.out`

```{r}
bai_sj <- bai_piovesan(rwdf = sj_tree, diam_df = d_sj)
bai_caH <- bai_piovesan(rwdf = caH_tree, diam_df = d_caH)
bai_caL <- bai_piovesan(rwdf = caL_tree, diam_df = d_caL)

# Set class to bai object 
# Esto es para que funcionen algunas otras funciones de dplR 
bais <- c('bai_sj', 'bai_caH', 'bai_caL')

for (i in bais){
  aux <- get(i)
  
  class(aux) <- c('rwl', 'data.frame')
  
  assign(i, aux)
}


```

## Resilience

* Computar métricas de resiliencia BAI para los tres sitios. 
* Computar varios eventos climáticos: 1995, 2005, 2012 ... (ver dys)
* Computar ventanas temporales: 3

```{r}
# Drought years 
# Utilizamos spei12 
dy <- read.csv(file=here::here('data/sequias', 'severe_spei12.csv'), header=TRUE)
dy <- dy %>% arrange(desc(maxyear))


# solamente aquellos mayor de 2 meses 
dys <- dy %>% filter(d_duration > 2) %>% as.data.frame() 
dys <- dys[,'maxyear']

```

```{r}
# Computar resiliencia para otros years (ventana temporal 3y) 
# SJ 
res_3_sj <- baiResilience(bai_sj, event_years = dys, window = 3)
# caL
res_3_caL <- baiResilience(bai_caL, event_years = dys, window = 3)
# caH
res_3_caH <- baiResilience(bai_caH, event_years = dys, window = 3)
```

```{r}
# Computar resiliencia para otros years (ventana temporal 10y) 
# SJ 
# Remove 1914 
dyssj <- dys[which(dys!=1914)]
res10sj <- baiResilience(bai_sj, event_years = dyssj, window = 10)
# caL
res10caL <- baiResilience(bai_caL, event_years = dys, window = 10)
# caH
res10caH <- baiResilience(bai_caH, event_years = dys, window = 10)
```

* Sample depth?
```{r}
## Sample depth (#trees by site)
sampleDepth <- function(x, site){ 
  x$samps <- rowSums(!is.na(x))
  x$year <- as.numeric(row.names(x))
  x$site <- site
  out <- x[,c("samps", "year", "site")]
  return(out)
} 

d_sj <- sampleDepth(sj_tree, site='SJ')
d_caL <- sampleDepth(caL_tree, site='caL')
d_caH <- sampleDepth(caH_tree, site='caH')

d <- rbind(d_sj, d_caL, d_caH)
```



```{r}
# Prepara data 
rsj <- res_3_sj$resilience %>% mutate(site='SJ')
rcaL<- res_3_caL$resilience %>% mutate(site='caL')
rcaH <- res_3_caH$resilience %>% mutate(site='caH')

re <- bind_rows(rsj, rcaL, rcaH)
re$site <- as.factor(re$site)

# Get mean values by site and add sample deepth
s <- re %>% 
  group_by(site, disturb_year) %>% 
  summarise_at(c("rt", "rs", "rc", "rrs"), funs(mean(., na.rm = TRUE), sd(., na.rm=TRUE),se=sd(., na.rm=TRUE)/sqrt(n()))) %>% 
  inner_join(d, by=c("disturb_year" = "year", "site"="site")) %>% 
  inner_join(dy, by=c("disturb_year" = "maxyear")) 
```


```{r}
# Prepara data 
rsj10 <- res10sj$resilience %>% mutate(site='SJ')
rcaL10<- res10caL$resilience %>% mutate(site='caL')
rcaH10 <- res10caH$resilience %>% mutate(site='caH')

re10 <- bind_rows(rsj10, rcaL10, rcaH10)
re10$site <- as.factor(re10$site)

# Get mean values by site and add sample deepth
s10 <- re10 %>% 
  group_by(site, disturb_year) %>% 
  summarise_at(c("rt", "rs", "rc", "rrs"), funs(mean(., na.rm = TRUE), sd(., na.rm=TRUE),se=sd(., na.rm=TRUE)/sqrt(n()))) %>% 
  inner_join(d, by=c("disturb_year" = "year", "site"="site")) %>% 
  inner_join(dy, by=c("disturb_year" = "maxyear")) 
```


### Plot Resilience temporal 
* Resilience of several drought years. 
* Point size = duration of the drought event 
* point = mean value of resilience (para eventos con mas de 10 árboles, samps > 10). 
* error bar = standard_deviation of resilience. 

Para cada árbol se calcula, la resiliencia (wsize = 3 years) de BAI en cada uno de los años de sequía. Si para un año de sequía no tenemos un mínimo de 10 años, pues entonces no lo ploteamos. Las barras de error indican la sd de los valores de resiliencia de los arboles para ese evento de sequía. 

```{r}
# ojo he ploteado los que tiene mas de 10 árboles 
resi_temporal <- s %>% filter(samps >= 10) %>% 
  ggplot(aes(y=rs_mean, x=disturb_year, colour=site)) + 
  geom_errorbar(aes(ymin=rs_mean - rs_sd, 
                    ymax=rs_mean + rs_sd),
                width = 0.2, 
                position=position_dodge(2)) +
  geom_point(aes(size=d_duration), shape=21, fill='white', position=position_dodge(2)) + 
  facet_wrap(~site, scales='free_y', ncol=1) + 
  theme_bw() + 
  theme(strip.background = element_rect(fill='transparent')) + 
  ylab('Resilience (Rs)') + xlab('years') + 
  scale_x_continuous(breaks=seq(1910,2020, by=5)) # + geom_smooth(aes(colour=site), se=FALSE)

resi_temporal

pdf(here::here('/out/bai_resiliences_severes', 'res_bai_longterm.pdf'), width=12, height = 9)
resi_temporal
dev.off()
```


```{r} 
resi_temporal10 <- s10 %>% filter(samps >= 10) %>% 
  ggplot(aes(y=rs_mean, x=disturb_year, colour=site)) + 
  geom_errorbar(aes(ymin=rs_mean - rs_sd, 
                    ymax=rs_mean + rs_sd),
                width = 0.2, 
                position=position_dodge(2)) +
  geom_point(aes(size=d_duration), shape=21, fill='white', position=position_dodge(2)) + 
  facet_wrap(~site, scales='free_y', ncol=1) + 
  theme_bw() + 
  theme(strip.background = element_rect(fill='transparent')) + 
  ylab('Resilience (Rs)') + xlab('years') + 
  scale_x_continuous(breaks=seq(1910,2020, by=5)) # + geom_smooth(aes(colour=site), se=FALSE)


pdf(here::here('/out/bai_resiliences_severes', 'res_bai_longterm10.pdf'), width=12, height = 9)
resi_temporal10
dev.off()
```

### Relation resiliencia y sequias (intensidad, etc)

```{r}
#https://gist.github.com/ottadini/6882677 
lm_eqn = function(m) {
  # Displays regression line equation and R^2 value on plot
  # Usage:
  # p + annotate("text", x=25, y=300, label=lm_eqn(lm(y ~ x, df)), parse=TRUE)
  
  l <- list(#a = format(coef(m)[1], digits = 2),
            # b = format(abs(coef(m)[2]), digits = 2),
            r2 = format(summary(m)$r.squared, digits = 3));
  
  if (coef(m)[2] >= 0)  {
    # eq <- substitute(italic(y) == a + b %.% italic(x)*","~~italic(r)^2~"="~r2,l)
    eq <- substitute(~~italic(r)^2~"="~r2,l)
  } else {
    # eq <- substitute(italic(y) == a - b %.% italic(x)*","~~italic(r)^2~"="~r2,l) 
    eq <- substitute(~~italic(r)^2~"="~r2,l)
  }
  
  as.character(as.expression(eq));                 
}

```


```{r}
sdf <- s %>% filter(samps >= 10) %>% 
  group_by(disturb_year) %>% 
  summarise_at(c("rt_mean", "rs_mean", "rc_mean", "rrs_mean"), 
               funs(mean(., na.rm = TRUE), sd(., na.rm=TRUE),se=sd(., na.rm=TRUE)/sqrt(n()))) %>% 
  inner_join(dy, by=c("disturb_year" = "maxyear")) 



plotrel <- function(df, v, x, label, XLab, YLab){
  require(ggplot2)
  require(ggrepel)

  formulita <- as.formula(paste0(v, "_mean_mean ~", x)) 
  
  yerrbar <- aes_string(ymin = paste0(v, "_mean_mean - ",  v, "_mean_se"), 
                        ymax = paste0(v, "_mean_mean + ",  v, "_mean_se")) 
  
  ggplot(df, aes_string(y=paste0(v, "_mean_mean"), x=x, label=label)) + 
    geom_errorbar(mapping = yerrbar) + 
    geom_point(size=4, pch = 21, colour="black", fill="white") + 
    theme_bw() + 
    geom_smooth(method='lm', se=FALSE) +
    xlab(XLab) + ylab(YLab) + geom_smooth(method='lm', se=FALSE, colour="black") +
    geom_text_repel() + 
    annotate("text", x=7, y = 0.5, 
             label=lm_eqn(lm(formulita, df)), parse=TRUE) 
    
  }

sevRs <- plotrel(sdf, v = "rs", x = 'd_severity', label = 'disturb_year',
        XLab = "Drought Severity", YLab = "Resilience (Rs) (3year window size)")

sevRt <- plotrel(sdf, v = "rt", x = 'd_severity', label = 'disturb_year',
        XLab = "Drought Severity", YLab = "Resistance (Rt) (3year window size)") 

sevRc <- plotrel(sdf, v = "rc", x = 'd_severity', label = 'disturb_year',
        XLab = "Drought Severity", YLab = "Recovery (Rc) (3year window size)") 

pdf(here::here('/out/bai_resiliences_severes', 'rs_vs_drought_3years.pdf'), width=18, height = 7)
sevRt + sevRc + sevRs 
dev.off()
```



```{r}
sdf10 <- s10 %>% filter(samps >= 10) %>% group_by(disturb_year) %>% 
  summarise_at(c("rt_mean", "rs_mean", "rc_mean", "rrs_mean"), 
               funs(mean(., na.rm = TRUE), sd(., na.rm=TRUE),se=sd(., na.rm=TRUE)/sqrt(n()))) %>% 
  inner_join(dy, by=c("disturb_year" = "maxyear")) 



sevRs10 <- plotrel(sdf10, v = "rs", x = 'd_severity', label = 'disturb_year',
        XLab = "Drought Severity", YLab = "Resilience (Rs) (10year window size)")

sevRt10 <- plotrel(sdf10, v = "rt", x = 'd_severity', label = 'disturb_year',
        XLab = "Drought Severity", YLab = "Resistance (Rt) (10year window size)") 

sevRc10 <- plotrel(sdf10, v = "rc", x = 'd_severity', label = 'disturb_year',
        XLab = "Drought Severity", YLab = "Recovery (Rc) (10year window size)") 

pdf(here::here('/out/bai_resiliences_severes', 'rs_vs_drought_10years.pdf'), width=18, height = 7)
sevRt10 + sevRc10 + sevRs10 
dev.off()
```


# Plots de Resiliencies con lo que ocurre tras el evento 
```{r}

post <- read.csv(file=here::here('data/sequias', 'post_severe.csv'), header=TRUE)
names(post) <- c('spei_avg', 'spei_sum', 'dyear', 'tlag')

u <- post %>% 
  gather(variable, value, -(dyear:tlag)) %>%
  unite(temp, variable, tlag) %>%
  spread(temp, value)


postdf <- s %>% filter(samps >= 10) %>% 
  group_by(disturb_year) %>% 
  summarise_at(c("rt_mean", "rs_mean", "rc_mean", "rrs_mean"), 
               funs(mean(., na.rm = TRUE), sd(., na.rm=TRUE),se=sd(., na.rm=TRUE)/sqrt(n()))) %>% 
  inner_join(u, by=c("disturb_year" = "dyear")) 




rsdf <- postdf %>% 
  dplyr::select(c(rs_mean_mean, rs_mean_se, spei_avg_1:spei_sum_30)) %>% 
  mutate(v = 'rs') %>% 
  rename(mean = rs_mean_mean, se = rs_mean_se)

rcdf <- postdf %>% 
  dplyr::select(c(rc_mean_mean, rc_mean_se, spei_avg_1:spei_sum_30)) %>% 
  mutate(v = 'rc') %>% 
  rename(mean = rc_mean_mean, se = rc_mean_se)

rtdf <- postdf %>% 
  dplyr::select(c(rt_mean_mean, rt_mean_se, spei_avg_1:spei_sum_30)) %>% 
  mutate(v = 'rt') %>% 
  rename(mean = rt_mean_mean, se = rt_mean_se)
                          
auxdf <- rbind(rsdf, rcdf, rtdf) %>% 
  gather(-mean, -se, -v, key="var", value = "value") 


# Get r2 
variables <- c('rs', 'rc', 'rt')

auxdf_eq <- c() 

for (vari in variables){ 
  varidf  <- auxdf %>% filter(v == vari) 

  speis <- unique(varidf$var)
  
  o <- c()
  out <- data.frame()
  
  for (s in speis){ 
    varidf_spei <- varidf %>% filter(var == s) 
  
    m <- lm(mean ~ value, varidf_spei) 
    
    o$var <- as.character(s)
    o$v <- as.character(vari)
    o$a <- as.numeric(format(coef(m)[1], digits = 5))
    o$b <- as.numeric(format(coef(m)[2], digits = 5))
    o$r2 <- as.numeric(format(summary(m)$r.squared, digits = 3))
    
    o <- as.data.frame(o)
    
    out <- rbind(out, o)
  }
  
  auxdf_eq <- rbind(auxdf_eq, out)
} 


# Resiliences vs SPEI avg 
auxdf_avg <- auxdf %>% filter(var %in% c('spei_avg_1', 'spei_avg_2', 'spei_avg_3', 'spei_avg_20', 'spei_avg_30')) 
auxdf_avgeq <- auxdf_eq %>% filter(var %in% c('spei_avg_1', 'spei_avg_2', 'spei_avg_3', 'spei_avg_20', 'spei_avg_30')) 


rs_vs_post_avg <- auxdf_avg %>% 
  ggplot(aes(x = value, y = mean)) + 
  facet_grid(v ~ var, scales = "free_y") +
  geom_point() + theme_bw() + 
  geom_errorbar(aes(ymin = mean - se, ymax =mean +se)) +
  geom_smooth(method='lm', se=FALSE, colour="black") +
  geom_text(data=auxdf_avgeq, aes(x =-.5, y = 0.6, label=r2), parse = TRUE, inherit.aes=FALSE) 


pdf(here::here('/out/bai_resiliences_severes', 'rs_vs_post_avg.pdf'), width=14, height =10)
rs_vs_post_avg 
dev.off()

# Resiliences vs SPEI sum
auxdf_sum <- auxdf %>% filter(var %in% c('spei_sum_1', 'spei_sum_2', 'spei_sum_3', 'spei_sum_20', 'spei_sum_30')) 
auxdf_sumeq <- auxdf_eq %>% filter(var %in% c('spei_sum_1', 'spei_sum_2', 'spei_sum_3', 'spei_sum_20', 'spei_sum_30')) 


rs_vs_post_sum <- auxdf_sum %>% 
  ggplot(aes(x = value, y = mean)) + 
  facet_grid(v ~ var, scales = "free_y") +
  geom_point() + theme_bw() + 
  geom_errorbar(aes(ymin = mean - se, ymax =mean +se)) +
  geom_smooth(method='lm', se=FALSE, colour="black") +
  geom_text(data=auxdf_sumeq, aes(x =-.5, y = 0.6, label=r2), parse = TRUE, inherit.aes=FALSE) 

pdf(here::here('/out/bai_resiliences_severes', 'rs_vs_post_sum.pdf'), width=14, height =10)
rs_vs_post_sum
dev.off()



```



