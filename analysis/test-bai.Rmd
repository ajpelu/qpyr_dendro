---
title: "dendro"
author: "AJ Perez-Luque (@ajpelu)"
date: "2017 Feb"
output:  
  md_document:
    variant: markdown_github
bibliography: references.bib 
csl: ecology.csl
---

```{r, warning=FALSE, message=FALSE}
library("tidyverse")
library("stringr")
library("dplR")
library("knitr")
library("detrendeR")
source(paste0(getwd(), '/script/R/bai_piovesan.R'))
source(paste0(getwd(), '/script/R/rw_byTree.R'))
```

# Read data 

```{r, echo=FALSE}
machine <- 'ajpelu'
# machine <- 'ajpeluLap'
di <- paste0('/Users/', machine, '/Dropbox/phd/phd_repos/qpyr_dendro/', sep='')

# sj 
sj <- read.rwl(fname=paste0(di, '/data_raw/dendro_ring/sn_sanjuan/sn_sanjuan.rwl'), format="tucson")

# canar 
ca <- read.rwl(fname=paste0(di, '/data_raw/dendro_ring/sn_canar/sn_canar.rwl'), format="tucson")

# Read diameters data
compete <- read.csv(file=paste0(di, '/data_raw/dendro_competence.csv'), header=TRUE, sep=',')
```

## Aggregate RW by tree 

* Lectura y preparación de datos de diámetro
```{r} 
# Prepare Diameter data 

# Compute diameter (mm)
compete <- compete %>% 
  mutate(dn_mm = (perim_mm / pi))
         
# Get only focal trees, and only selected variables 
ft <- compete %>% 
  filter(sp=='Focal') %>% 
  filter(id_focal!='Fresno') %>% 
  dplyr::select(id_focal, loc, dn_mm, height_cm) 


# Set levels of eleveation 
sj_lowcode  <- paste0('A', str_pad(1:10, 2, pad='0'))
sj_highcode <- paste0('A', 11:20)
ca_lowcode <- c(paste0('B', str_pad(1:10, 2, pad='0')),
            paste0('B', 26:30))
ca_highcode <- paste0('B', 11:25)

ft <- ft %>% 
  mutate(elev = as.factor(
    ifelse(id_focal %in% sj_lowcode, 'Low',
                       ifelse(id_focal %in% sj_highcode, 'High',
                              ifelse(id_focal %in% ca_lowcode, 'Low', 'High'))))) %>%
  mutate(site = as.factor(paste0(loc, '_', elev)))
```

### General statistics by site

```{r}
# Create subset to compare between sites 
caL <- ca[,c("SNB0101","SNB0102","SNB0201","SNB0202","SNB0301","SNB0302","SNB0401","SNB0402","SNB0501","SNB0502g",
             "SNB0601","SNB0602","SNB0701","SNB0702g","SNB0801g","SNB0802g","SNB0901g","SNB0902","SNB1001","SNB1002",
             "SNB2601","SNB2602","SNB2701","SNB2702g","SNB2801","SNB2802","SNB2901","SNB2902","SNB3001","SNB3002")] 


caH <- ca[, c("SNB1101","SNB1102","SNB1201","SNB1202","SNB1301","SNB1302","SNB1401","SNB1402","SNB1501","SNB1502",
              "SNB1601","SNB1602","SNB1701","SNB1702","SNB1801","SNB1802","SNB1901","SNB1902","SNB2001","SNB2002g",
              "SNB2101","SNB2102","SNB2201g","SNB2202g","SNB2301g","SNB2302","SNB2401","SNB2402","SNB2501","SNB2502")]


sjL <- sj[, c("SNA0101","SNA0102","SNA0201","SNA0202","SNA0301","SNA0302","SNA0401","SNA0402","SNA0501","SNA0502",
              "SNA0601","SNA0602","SNA0603","SNA0701","SNA0702","SNA0801","SNA0802","SNA0901","SNA0902","SNA0903",
              "SNA1001","SNA1002","SNA1003")]
sjH <- sj[, c("SNA1101","SNA1102","SNA1103","SNA1201","SNA1202","SNA1203","SNA1301","SNA1302","SNA1303","SNA1401",
              "SNA1402","SNA1501","SNA1502","SNA1601","SNA1602","SNA1701","SNA1702","SNA1703","SNA1801","SNA1802",
              "SNA1901","SNA1902","SNA2001","SNA2003","SNA2002")]
```

### Dendrochronological summary 
```{r}
objects_rwl <- c('caL','caH','sjL','sjH')

out <- c() 

for (i in objects_rwl){ 
  
  aux <- get(i)
  aux_stats <- rwi.stats(aux)
  
  aux_stats$site <- i
  
  out <- rbind(out, aux_stats)
  }

d <- rwl.report(ca)

```




* Agregar valores medios de RW 
:red_circle: DOCUMENTAR 
```{r}
sj_tree <- rw_byTree(sj)
ca_tree <- rw_byTree(ca)
```


* Crear diferentes dataset por sitio 
```{r}
# function to subset averaged RW 
subsetRW <- function(rwdf, codes){ 
  require(dplyr)
  aux_codes <- paste0('rw_', codes)
  mysubset <- rwdf %>% select(one_of(aux_codes), year)
  mysubset
  }


sjL <- subsetRW(sj_tree, sj_lowcode)
sjH <- subsetRW(sj_tree, sj_highcode)
caL <- subsetRW(ca_tree, ca_lowcode)
caH <- subsetRW(ca_tree, ca_highcode)



ft %>% group_by(site) %>% do(data = (.)) %>% 
             select(data) %>% 
             lapply(function(x) {(x)}) %>% .[[1]]

```









                                                      
    








## San Juan Data 

Algunos árboles tienen 3 cores. Sin embargo, no los tres cores llegan hasta la corteza, por lo tanto, no podemos utilizar el diametro para estimar bai. Vamos a realizar lo siguiente: 

* Crear dos datasets: 
    * Dataset con series de datos que llegan hasta corteza (`sj_cor`)
    * Dataset con series de datos que no llegan hasta corteza (`sj_sin`): se trata de cores que no llegan hasta la corteza. 
    
* Para el cálculo del BAI, en el dataset `sj` utilizamos el diámetro medido en campo. En el caso del dataset `sj_sin` utilizamos la suma de todos los diámetros (:red_circle: `$TODO$ ASK to Guillermo`)

```{r}
# Get summary ring-width series
sj_summ <- summary(sj)

# Get names cores with last year different to 2016 
id_cores_no_bark <- sj_summ %>% 
  filter(last != 2016) %>% select(series) %>% mutate(series = factor(series)) 

id_cores_no_bark <- unname(unlist(id_cores_no_bark))

# Subbet datasets 
sj_cor <- sj[which(! colnames(sj) %in% (id_cores_no_bark))]
sj_sin <- sj[which(colnames(sj) %in% (id_cores_no_bark))]
```


Lectura y preparación de datos de diámetro

```{r}
compete <- read.csv(file=paste0(di, '/data_raw/dendro_competence.csv'), header=TRUE, sep=',')

# Compute diameter (mm)
compete <- compete %>% 
  mutate(dn_mm = (perim_mm / pi))
         
# Get only focal trees, and only selected variables 
ft <- compete %>% 
  filter(sp=='Focal') %>% 
  filter(id_focal!='Fresno') %>% 
  select(id_focal, loc, dn_mm, height_cm)

# Select only SJ trees and 
ft_sj <- ft %>% filter(loc=='SJ')


# get Create a dataframe with core ID
cores <- data.frame(id_cores=colnames(sj))

# Extract replicate and Tree ID from core ID 
cores <- cores %>% 
  mutate(id_focal = as.factor(stringr::str_sub(id_cores, 3,5)),
         id_replica = stringr::str_sub(id_cores, 6,8))

# Create df with diameter and height for each core ID 
diam_cores <- cores %>% inner_join(ft_sj, by='id_focal') %>% 
  select(id_cores, dn_mm)

# remove diamm of cores without bark 
diam_cores_sj <- diam_cores %>% filter(! id_cores %in% id_cores_no_bark)
```

## Cómputo del BAI 


He construido una funcion para el computo del BAI, teniendo en cuenta la aproximación de [@Piovesan2008]


```{r} 
# Compute BAI for SJ locality 
baisj <- bai_piovesan(rwdf = sj_cor, diam_df = diam_cores_sj)
```


```{r}
rwl.report(sj_cor)






bai_p <- bai_piovesan(rwdf = sj_cor, diam_df = diam_cores_sj)
bai_d <- bai.out(rwl = sj_cor, diam = diam_cores_sj)







diam_cores_sjsin <- data.frame(id_cores = colnames(sj_sin),
                               dn_mm = colSums(sj_sin, na.rm = TRUE))
rownames(diam_cores_sjsin) <- NULL


bai_psin <- bai_piovesan(rwdf = sj_sin, diam_df = diam_cores_sjsin)
bai_dsinsin <- bai.out(rwl = sj_sin)
bai_dsin <- bai.out(rwl = sj_sin, diam = diam_cores_sjsin)





```

```{r}
set.seed(1234)
serie <- sample(colnames(b_test_dplR),1)

require(reshape2)


bp <- melt(t(b_test_piovesan))
names(bp) <- c('cores', 'years', 'bai_p') 


bd <- melt(t(b_test_dplR))
names(bd) <- c('cores', 'years', 'bai_d') 




diff <- bp %>% 
  inner_join(bd, by=c('cores','years')) %>% 
  mutate(diff = bai_p - bai_d)




ggplot(x, aes(y=bai, x=years, colour=test)) + 
  geom_point() + 
  facet_wrap(~cores)











```{r, eval=FALSE, echo=FALSE}
# BAI dplR
baisj <- bai.out(rwl = sj_cor, diam = diam_cores_sj)

baisjt <- bai.out(rwl = sjt)


# Function to compute BAI (Piovesan et al)

# rwl_file
myrwl <- sj_cor
# Diameter df  
diam_df <- diam_cores_sj

# Core
id_core <- 'SNA0101'  

# Ring-width serie
myrwl_serie <- myrwl[[id_core]]

# Diameter for core id_core 
dbh <- subset(diam_df, id_cores == id_core)
dbh <- dbh[,2]



myrwl_serie2 <- na.omit(myrwl_serie)
cum



r0 <- dbh/2 - c(0,cumsum(rev(myrwl_serie2)))



bai <- (pi/4)*(dbh^2 - ((dbh - 2*myrwl_serie)^2)) 

s <- myrwl_serie[94:96]

d <- sum(s)*2


rev(s)







# Extract rwl serie 
myrwl_i <- myrwl[[1]]


diam_df_i <- diam_cores_sj[1]




# Remove NA 
myrwl_io <- na.omit(myrwl_i)

bai <- 
diam.vec <- diam[, 2]









########## test Piovesan
# rwl_file
myrwl <- baisj

#id_core


# Extract rwl serie 
myrwl_i <- myrwl[[1]]


dbh <- 372.4226





# Year
n.vec <- seq_len(nrow(myrwl))

# Series
seq_len(ncol(myrwl))

# Select a ring-width series
dat <- myrwl[[1]] 
# Remove NA
dat2 <- na.omit(dat)


ggplot(s1, aes(y=SNA0101, x=row.names(s1))) + 
  geom_point() + 
  geom_line(b1, aes(y=SNA0101, x=row.names(b1)))

ggplot(s1, aes(y=SNA0101, x=row.names(b1), group=1)) + geom_line()


```




```{r}

x <- c(1,2,2,3,1,3,4,5)

xx <- rollmean(x=x, k=3, align = 'center', na.pad = T)

```
