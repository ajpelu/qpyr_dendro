---
output: 
  word_document
editor_options: 
  chunk_output_type: console
---

```{r, include=FALSE}
knitr::opts_chunk$set(echo = FALSE, message=FALSE, warning = FALSE)
```

```{r load_pkg}
library("tidyverse")
library("here")
library("ggrepel")
library("scales")
library("grid")
library("gridExtra")
library("patchwork")
library("ggcorrplot")
library("stringr")
library("pander")
library("lemon")
library("ggpubr")
source(here::here('/script/R/custom_functions.R'))
```


```{r data}
ltdf <- read.table(file=here::here("/data_raw/meteo", "long_term_data_rediam_data.txt"), header=T, sep=';', dec=',')

source(here::here("/script/R/", "hydro_year.R"))

ltdf <- ltdf %>% 
  dplyr::select(cod = INDICATIVO, VARIABLE, FECHA, VALOR) %>% 
  dplyr::mutate(fecha = as.Date(FECHA, format='%d/%m/%Y'),
                month = lubridate::month(fecha),
                hmonth = ifelse(month <= 8, month + 4, month -8), 
                hyear = hydro_year(fecha),
                hyear_f = paste0(hyear-1,'-', hyear))


# We used only the 5514 station (the most long term)
# Filter by station and prec 
# Filter from 1950 
st5514 <- ltdf %>% 
  filter(VARIABLE == 'PM1') %>% 
  filter(cod == '5514') %>% 
  filter(hyear >= 1950) %>% 
  dplyr::select(fecha, month, hmonth, hyear, hyear_f, pre=VALOR)

st5514_pro <- st5514 %>% 
  group_by(hyear_f, hmonth) %>% 
  dplyr::summarise(pre = sum(pre)) %>%
  dplyr::mutate(csum = cumsum(pre)) %>% as.data.frame()

df <- st5514_pro  %>% 
  filter(!(hyear_f %in% c('2004-2005', '2011-2012')))

```

```{r plot_cummulatedPrec}

size_line <- .25 

cp <- ggplot(df, aes(x=as.factor(hmonth), y=csum)) + 
  geom_boxplot(aes(x=as.factor(hmonth)), size = 0.25, outlier.size = 0.5) +  
  geom_smooth(aes(group=1), se=TRUE, level=0.95, colour='black', size = size_line) + 
  geom_line(data=subset(st5514_pro, hyear_f == '2004-2005'),
            aes(x=as.factor(hmonth), y=csum, group=1), colour='blue', size = size_line) +
  geom_line(data=subset(st5514_pro, hyear_f == '2011-2012'), 
            aes(x=as.factor(hmonth), y=csum, group=1),
            colour='red', size = size_line) +
  theme_bw() + 
  theme(strip.background = element_rect(fill = NA, color = "black"),
        axis.text.x = element_text(angle = 90, hjust = 1, vjust=0.5, size=7),
        axis.text.y = element_text(size=7),
        axis.title.y = element_text(size = 7)) + 
  ylab("Cumulative \n Precipitation (mm)") + xlab('') + 
  # ggtitle('Granada Base Aerea, 1950-2015') + 
  scale_x_discrete(labels=c("1"="Sep", "2"="Oct", "3"="Nov", "4"="Dec", "5"="Jan", "6"="Feb",
                            "7"="Mar", "8"="Apr", "9"="May", "10"="Jun", "11"="Jul", "12"="Aug")) +
  annotate("text", label = "2004-2005", x = 2, y = 420, size = 2, colour = "blue") + 
  annotate("text", label = "2011-2012", x = 2, y = 520, size = 2, colour = "red") + 
  annotate("text", label = "1950-2015", x = 2, y = 620, size = 2, colour = "black") +
  theme(panel.grid = element_blank(), 
        axis.title.y = element_text(hjust = 0.5),
        plot.background = element_blank())
```


```{r data_prec}
prec_files <- list.files(here::here('data_raw/meteo/prec_subclima/'), pattern="*.csv")

dfpre <- c() 

for (i in prec_files){
  
  auxdf <- read.csv(here::here('data_raw/meteo/prec_subclima', i), header = TRUE, sep=";")
  auxdf$code <- gsub(x=i, pattern = ".csv", replacement = "")
  
  dfpre <- rbind(dfpre, auxdf)
} 


dfpre$date <- as.Date(dfpre$date, format = "%d/%m/%Y")

dfpre <- dfpre %>% 
  dplyr::mutate(fecha = as.Date(date, format='%d/%m/%Y'),
                month = lubridate::month(fecha),
                hmonth = ifelse(month <= 8, month + 4, month -8), 
                hyear = hydro_year(fecha),
                hyear_f = paste0(hyear-1,'-', hyear))


aux <- dfpre %>% 
  group_by(hyear_f, code) %>% 
  dplyr::mutate(csum = cumsum(prec)) %>% 
  filter(hmonth == 12) %>% 
  dplyr::select(-month, -prec, -date, -fecha) %>% as.data.frame()


presn <- aux %>% group_by(hyear) %>% 
  dplyr::summarise(
    csum_mean = mean(csum, na.rm = TRUE),
    csum_sd = sd(csum, na.rm = TRUE), 
    csum_se = csum_sd/sqrt(length(csum_sd)), 
    n = n())  

meandf <- mean(presn$csum_mean)
sddf <- sd(presn$csum_mean)
```

```{r plot_prec}
yeah <- presn %>% filter(csum_mean < (meandf - 1*sddf)) %>% 
  mutate(pos = csum_mean - 50) %>%  as.data.frame()
  
prec_hydrol_sn <- ggplot(presn, aes(x=hyear, y=csum_mean)) + 
  geom_hline(yintercept = meandf) + 
  geom_hline(yintercept = meandf + 2*sddf, color ='blue', linetype = 'dashed') +
  geom_hline(yintercept = meandf - 2*sddf, color ='red', linetype = 'dashed') +
  geom_hline(yintercept = meandf + 1*sddf, color ='blue', linetype = 'dotted') +
  geom_hline(yintercept = meandf  - 1*sddf, color ='red', linetype = 'dotted') +
  geom_errorbar(aes(ymin = csum_mean - csum_se, ymax= csum_mean + csum_se), width=.1, colour='gray') +
  geom_point(size=2) + theme_bw() + 
  geom_line(size=.25, colour = 'black') + 
  scale_x_continuous(breaks=seq(1950,2015, by=5)) +
  scale_y_continuous(breaks=seq(0,1500, by=250)) + 
  geom_text_repel(
    data = yeah,
    aes(label = hyear), 
    size = 2.5, 
    alpha = .5,
    colour = "black",
    segment.size = 0.1, 
    segment.alpha = 0.5,
    point.padding=unit(.7,'lines'),
    nudge_y = -yeah$csum_mean,
    direction = 'x'
    ) +
  theme(panel.grid = element_blank(),
        axis.title = element_text(size = 9),
        axis.text.y = element_text(size = 8)) +
  ylab('Cumulative Precipitation (mm)') + xlab('Year') +
  expand_limits(y=c(0,2000)) 
```

```{r plot_all}
p <- prec_hydrol_sn + annotation_custom(ggplotGrob(cp), xmin = 1990, xmax = Inf, ymin=1050)
```

**Figure S1.** Temporal evolution of cumulative precipitation (hydrological year) during the period 1950-2017. Points represent mean and errorbars standard error. *Black* line indicates mean for the whole period (`r meandf` mm). *Red* lines represent -1 and -2 standard deviation (*dotted* and *dashed* lines respectively). *Blue* lines represent +1 and +2 standard deviation (*dotted* and *dashed* lines respectively). Years with average values below -1SD are labelled. Data from 28 meteorological stations distributed around Sierra Nevada area (from National Spanish Meteorological Services, AEMET). ***Inset plot***: cumulative precipitation during the hydrological years 2004-2005 (*blue line*) and 2011-2012 (*red line*). The boxplot representing the average from 1950-2015 period. Data from meteorological station Granada, Base Aérea. 



##### SPEI 

```{r}
# DATOS desde 1901 

# Get file names
myfiles <- list.files(path = here("data_raw/spei/spei_longterm"), pattern = "\\.csv$")

mydf <- data.frame() 

for (j in myfiles){ 
  aux <- read.csv(file=here("data_raw/spei/spei_longterm", j), header = TRUE, sep = ',')
  
  # Remove csv and get name 
  name_aux <- str_replace(j, ".csv", "") 
  
  # Get lat long
  latlong <- str_replace(name_aux, "spei_", "")
  mylong <- as.numeric(str_split_fixed(latlong, "_", 2))[1]
  mylat <- as.numeric(str_split_fixed(latlong, "_", 2))[2]
  
  # Store lat and long 
  aux$lat <- mylat
  aux$long <- mylong 
  
  # year and month 
  aux$month <- rep(1:12, 115)
  
  auxy <- c()
  years <- c() 
  for (j in 1901:2015) { 
    auxy <- as.data.frame(rep(j,12))
    years <- rbind(years, auxy)
    } 
  names(years) <- 'year'
  
  aux <- cbind(aux,years)
  
  # join all df 
  mydf <- rbind(mydf, aux)
}


# Convert to date  
mydf <- mydf %>% mutate(date = sprintf("%d-%02d", year, month),
                        date = as.Date(paste0(date, '-01'), format="%Y-%m-%d"))

speidf <- mydf %>% dplyr::select(SPEI06,SPEI12,SPEI24,month, year, date) %>% 
  group_by(year,month, date) %>%
  summarise_at(vars(SPEI06,SPEI12,SPEI24), funs(mean,sd,se=sd(.)/sqrt(n()))) %>% 
  as.data.frame() 
```

```{r}
speiPlot <- function(df, vi, mytitle, year_scaleX){
  require(dplyr)
  require(scales)

  # Select variable of interest 
  dfs <- df %>% dplyr::select(year, month, date, starts_with(vi))
  
  # Rename variables 
  dfs <- dfs %>% rename_all(~sub(paste0(vi,'_'), '',.x))
  # Create variable pos and neg 
  dfs <- dfs %>% mutate(signo = ifelse(mean > 0, "pos", "neg"))
  
  # Plot  
  p <- ggplot(dfs, aes(x = date, y = mean, fill = signo)) + 
    geom_rect(aes(xmin=as.Date("2005-01-01"), xmax = as.Date("2005-12-01"), ymin=-Inf, ymax=Inf),
              fill="grey", alpha=.9) + 
    geom_rect(aes(xmin=as.Date("2012-01-01"), xmax = as.Date("2012-12-01"), ymin=-Inf, ymax=Inf),
              fill="grey", alpha=.9) + 
    geom_bar(stat = "identity") +
    scale_fill_manual(values = c("pos" = "darkblue", "neg" = "red")) +
    theme_bw()  + 
    labs(title= mytitle, x= '', 
         y = paste0(substr(vi, 1, 4), ' (', gsub("[^0-9]","",vi),'-month scale)')) +
    theme(strip.background = element_rect(fill = "white"),
        legend.position = "none", 
        panel.grid = element_blank(), 
        axis.text.y = element_text(size=10),
        axis.text.x = element_text(size=9),
        axis.title.y = element_text(size = 12))
  
  # Date Scale in X 
  if (missing(year_scaleX)){
    p
    } else { 
    year_interval <- paste0(year_scaleX," year")
    p <- p + scale_x_date(date_breaks = year_interval, date_labels = "%Y",
                          limits=as.Date(c("1901-01-01", "2015-12-01")))
    }

  return(p)
}



s <- speiPlot(speidf, vi = 'SPEI12', mytitle = "", year_scaleX = 10)
```



```{r}
s12 <- ggarrange(p, s,
          labels = c("a", "b"),
          ncol = 1, nrow = 2)
```



```{r}
# SAVE as eps 
saveImage(s12, path="./man/figures/svg/", dpi=300, w=25, h=20, fig= "fig_s1ab", u = "cm") 
```


**Figure S1.** ***A*** Temporal evolution of cumulative precipitation (hydrological year) during the period 1950-2017. Points represent mean and errorbars standard error. *Black* line indicates mean for the whole period (`r meandf` mm). *Red* lines represent -1 and -2 standard deviation (*dotted* and *dashed* lines respectively). *Blue* lines represent +1 and +2 standard deviation (*dotted* and *dashed* lines respectively). Years with average values below -1SD are labelled. Data from 28 meteorological stations distributed around Sierra Nevada area (from National Spanish Meteorological Services, AEMET). ***Inset plot***: cumulative precipitation during the hydrological years 2004-2005 (*blue line*) and 2011-2012 (*red line*). The boxplot representing the average from 1950-2015 period. Data from meteorological station Granada, Base Aérea. 
***B*** Drought severity in Sierra Nevada for the 1901-2016 period based on the Standardised Precipitation-Evapotranspiration Index (SPEI). Data from Global SPEI database (http://spei.csic.es/database.html). We obtanied the SPEI data for a 12 month scale and for all 0.5º grid cells covering Sierra Nevada. Horizontal gray bars indicate 2005 and 2012 year. 

