---
output: 
  word_document
editor_options: 
  chunk_output_type: console
---

```{r, include=FALSE}
knitr::opts_chunk$set(echo = FALSE, message=FALSE, warning = FALSE)
```

```{r load_pkg}
library("tidyverse")
library("here")
library("dplyr")
library("ggrepel")
library("scales")

library("grid")
# library("GGally")
library("gridExtra")
library("patchwork")
library("ggcorrplot")
library("stringr")
library("pander")
library("lemon")
library("viridis")
library("ggthemes")
source(here::here('/script/R/custom_functions.R'))
```


```{r data}
corBai <- read.csv(file=here("/out/correla_resilience/", "correla_window_size.csv"), header = TRUE)
corEvi <- read.csv(file=here("/out/correla_resilience/", "correla_window_size_evi.csv"), header = TRUE)
corRwi <- read.csv(file=here("/out/correla_resilience/", "correla_window_size_rwi.csv"), header = TRUE)

generaMatrix <- function(cordf, variable){ 
  m <- cordf %>% filter(var == variable) %>% 
    dplyr::select(-var, -window_size) %>% 
    mutate(w1 = c(2, 2, 3), 
           w2 = c(3,4,4)) 
  mf <- m %>% 
    dplyr::select(r2, w2, w1) %>% rename(w1 = w2, w2 = w1)
  
  df <- m %>% rbind(mf) %>% 
    add_row(r2 = 1, w1=2, w2=2) %>% 
    add_row(r2 = 1, w1=3, w2=3) %>% 
    add_row(r2 = 1, w1=4, w2=4) 
  
    df <- df %>% 
    mutate(w1 = case_when(
      w1 == 2 ~ '2 years',
      w1 == 3 ~ '3 years',
      w1 == 4 ~ '4 years'),
      w2 = case_when(
      w2 == 2 ~ '2 years',
      w2 == 3 ~ '3 years',
      w2 == 4 ~ '4 years'))

      cor_df <- as.data.frame.matrix(xtabs(r2 ~., df))

return(cor_df)
}

cor_rt <- generaMatrix(corBai, 'rt')
cor_rc <- generaMatrix(corBai, 'rc')
cor_rs <- generaMatrix(corBai, 'rs') 

cor_rte <- generaMatrix(corEvi, 'rt')
cor_rce <- generaMatrix(corEvi, 'rc')
cor_rse <- generaMatrix(corEvi, 'rs')
```

```{r plot_function}
correP <- function(df, mytitle, ...){
  require(ggplot2)
  require(ggcorrplot) 
  
  p <- ggcorrplot(df, method = "square", type ='upper', 
                  outline.color = "black", colors = "white",
                  ggtheme = theme_minimal, 
                  lab = TRUE, lab_size = 5,
                  title = mytitle, show.legend = FALSE, 
                  tl.cex = 7,
                  tl.srt = 1)
  p <- p + theme(plot.title = element_text(size = 10, face = "bold.italic"),
                 panel.grid = element_blank(),
                 axis.text.x = element_text(hjust = 0.5)) + scale_x_discrete(position = "top") 
  p      
}
```

```{r plot}
g_rt <- correP(cor_rt, 'BAI Rt')
g_rc <- correP(cor_rc, 'BAI Rc')
g_rs <- correP(cor_rs, 'BAI Rs')
g_rte <- correP(cor_rte, 'EVI Rt')
g_rce <- correP(cor_rce, 'EVI Rc')
g_rse <- correP(cor_rse, 'EVI Rs')

g <- (g_rte + g_rce + g_rse) / (g_rt + g_rc + g_rs) + plot_layout(nrow=2) + plot_annotation(tag_levels = c('a'))
```

**Figure S5.** Correlation between indices of resilience (*Rt*, resistance; *Rc*, recovery; *Rs*, Resilience) using periods of several lengths (2, 3 and 4 years after a drought). Top plots (a, b and c) showing the resilience indices of greenness (EVI) to drought; and bottom plots (d, e, f) the resilience indices of tree-growth (BAI) to drought. 

```{r plot_out, fig.width=6, dpi = 300, out.width = 0.8} 
g
```



```{r}
# SAVE as eps 
saveImage(g , path="./man/figures/svg/", dpi=300, w=20, h=10, fig= "fig_s5", u = "cm") 
```




