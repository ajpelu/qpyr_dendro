---
output: 
  word_document
editor_options: 
  chunk_output_type: console
---

```{r, include=FALSE}
knitr::opts_chunk$set(echo = FALSE, message=FALSE, warning = FALSE)
```

```{r load_pkg}
library("tidyverse")
library("here")
library("ggrepel")
library("scales")
library("grid")
library("gridExtra")
library("patchwork")
library("stringr")
library("pander")
library("lemon")
library("magrittr")
source(here::here('/script/R/colores_den.R'))

```



```{r data}
cro_sites <- read.csv(here("data/cronos_medias", "cronos_sites.csv"), header = TRUE, sep = ',')

cro_sites <- cro_sites %>% mutate(site = 
  case_when(
    site == "CA_Low" ~ "CA-Low", 
    site == "CA_High" ~ "CA-High",
    site == "SJ" ~ "SJ",
  )
)

# To get p.value of the model 
# https://stackoverflow.com/questions/5587676/pull-out-p-values-and-r-squared-from-a-linear-regression
lmp <- function(modelobject) {
    if (class(modelobject) != "lm") stop("Not an object of class 'lm' ")
    f <- summary(modelobject)$fstatistic
    p <- pf(f[1],f[2],f[3],lower.tail=F)
    attributes(p) <- NULL
    return(p)
}


year_init <- 1975

# Lm CA-High
dfCaH <- cro_sites %>% 
  filter(year >= year_init) %>% 
  filter(site == 'CA-High')

mCaH <- lm(bai_mean ~ year, dfCaH)
r2caH <- format(summary(mCaH)$r.squared, digits = 3)
pCaH <- lmp(mCaH)


# Lm CA-Low 
dfCaL <- cro_sites %>% 
  filter(year >= year_init) %>% 
  filter(site == 'CA-Low')

mCaL <- lm(bai_mean ~ year, dfCaL)
r2caL <- format(summary(mCaL)$r.squared, digits = 3)
pCaL <- lmp(mCaL)

# Lm SJ
dfSJ <- cro_sites %>% 
  filter(year >= year_init) %>% 
  filter(site == 'SJ')

mSJ <- lm(bai_mean ~ year, dfSJ)
r2SJ <- format(summary(mSJ)$r.squared, digits = 3)
pSJ <- lmp(mSJ)


lms <- data.frame(year = as.numeric(c(2018, 2018, 2018)),
                     site = c("CA-Low", "CA-High", "SJ"), 
                     r2 = as.numeric(c(r2caL, r2caH, r2SJ)),
                     pvalue = as.numeric(round(c(pCaL, pCaH, pSJ), 4)),
                     y = as.numeric(
                       c(as.numeric(predict(mCaL)[40]), 
                           as.numeric(predict(mCaH)[40]), 
                           as.numeric(predict(mSJ)[40]))))
# lms$y <- lms$y / 100
lms <- lms %>% mutate(
  y = y/100,
  pc = ifelse(pvalue < 0.001, "p < 0.001", as.character(paste0("p = ", pvalue))),
  label = round(r2,3), 
  labelp = ifelse(pvalue < 0.001, paste0(label, "**"), label))
  
```

```{r plot_configure}
# colores <- c("#B2DF8A","#1F78B4","#A6CEE3")
# colores <- c('#7570b3','#e7298a','#1b9e77')
# colores <- c('#33a02c', '#984ea3', '#a65628')
# colores <- c("#000000", "#0072B2", "#D55E00") 
# colores <- c("#B2DF8A","#1F78B4","#A6CEE3")
# colores <- c("#000000", "#0072B2", "#D55E00") 

```

```{r plot_cronobai}

# cores 
cronos_bai <- cro_sites %>% filter(nseries > 5) %>% 
  ggplot(aes(x=year, y=bai_mean/100, colour=site)) + 
  theme_bw() + ylab('BAI') + 
  geom_ribbon(aes(ymin = (bai_mean - bai_se)/100,
                  ymax = (bai_mean + bai_se)/100,
                  fill=site), alpha=.4, colour=NA) +
  geom_line() + 
  geom_point(size=.8) + 
  scale_colour_manual(values = colores_den) +
  scale_fill_manual(values = colores_den) +
  ylab(expression(paste("BAI (", cm^2, year^-1, ")", sep=''))) +
  scale_x_continuous(breaks = seq(1815, 2020, by=10), limits=c(1815,2020), sec.axis = dup_axis()) +
  geom_smooth(data = subset(cro_sites, year > year_init & site == 'CA-High'), 
              aes(x=year, y=bai_mean/100, colour=site), method = 'lm', se=FALSE, size = .5) +
  geom_smooth(data = subset(cro_sites, year > year_init & site == 'CA-Low'), 
              aes(x=year, y=bai_mean/100, colour=site), method = 'lm', se=FALSE, size = .5) +
  geom_smooth(data = subset(cro_sites, year > year_init & site == 'SJ'), 
              aes(x=year, y=bai_mean/100, colour=site), method = 'lm', se=FALSE, size = .5)  +
  geom_text_repel(data = lms, 
                  aes(x=year, y = y, colour = site, label = labelp),
                  direction = "x", nudge_x = Inf, nudge_y = 1, show.legend = FALSE, 
                  size = 3) + 
  theme(panel.grid = element_blank(),
        axis.text.x=element_text(size=6),
        legend.position = c(0.2,.8),
        strip.background = element_blank(),
        axis.title.x.top = element_blank(), 
        axis.text.x.top = element_blank())  
```


```{r plot_samp}
  # scale_y_continuous(sec.axis = sec_axis(~ ., name = '# trees', breaks = c(0,15,30))) +
  # geom_line(aes(x=year, y=n_trees+40, colour=site)) 
samp <- cro_sites %>% ggplot(aes(x=year, y=n_trees, colour=site)) + 
  theme_bw() + ylab('# trees') + 
  geom_line() + 
  scale_colour_manual(values = colores_den) +
  scale_fill_manual(values = colores_den) +
  scale_x_continuous(breaks = seq(1815, 2020, by=10), limits=c(1815,2020), 
                     sec.axis = dup_axis(), position = "top") +
  theme(panel.grid = element_blank(),
        legend.position = "none", 
        axis.title.x=element_blank(),
        axis.text.x.top = element_text(size=6), 
        axis.text.x.bottom = element_blank(), 
        # axis.text.x=element_blank(),
        # axis.ticks.x=element_blank(), 
        # plot.margin = margin(t = 5, r = 0, b = -5, l = 0, unit = "pt")
        ) 
  # theme(plot.margin = unit(c(1,5,-30,6),units="points"),
  #       axis.title.y = element_text(vjust =0.25))
```

```{r plot_all}
plot_bai_s <- samp + cronos_bai + plot_layout(ncol=1, heights = c(0.15, 0.85))

```

**Figure 4.** Basal Area Increment (BAI) chronologies of *Q. pyrenaica* for northern population (SJ; *red*) and southern ones: low-elevation (CA-Low; *green*) and high-elevation (CA-High, *blue*) sites. Shading areas correspond to standard error of the mean. Number of series is displayed in the upper plot. We only show years replicated with # series > 5. Linear trends since 1975 are shown all sites (numbers indicate $r^2$ values; asterisks indicate significant linear trend, *p < 0.001*).


```{r out_plot, fig.height = 5, fig.width=7, dpi = 300, out.width = 0.8}
plot_bai_s
```
