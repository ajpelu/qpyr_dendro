---
output:
  word_document
editor_options: 
  chunk_output_type: console
---

```{r, include=FALSE}
knitr::opts_chunk$set(echo = FALSE, message=FALSE, warning = FALSE)
```

```{r load_pkg}
library("tidyverse")
library("here")
library("scales")
library("patchwork")
library("ggrepel")
library("broom")
library("cowplot")
library("purrr")
library("ggpubr")
library("rstatix")
library("ggpmisc")
source(here::here('/script/R/colores_den.R'))
```

```{r data}
df <- read.csv(file=here::here('/out/bai_resiliences_severes' ,'resiliences_bai_droughts.csv'), header=TRUE)

# peores sequias 
dy <- read.csv(file=here::here('data/sequias', 'severe_spei12.csv'), header=TRUE)
dy <- dy %>% arrange(desc(d_duration))
# solamente aquellos mayor de 2 meses 
dys <- dy %>% filter(d_duration > 2) %>% filter(maxyear > 1940 ) %>% as.data.frame() 
# dys <- dys[,'maxyear'] 

sdf <- df %>% 
  filter(samps >= 10) %>% 
  group_by(disturb_year) %>% 
  summarise_at(c("rt_mean", "rs_mean", "rc_mean", "rrs_mean"), 
               funs(mean(., na.rm = TRUE), sd(., na.rm=TRUE),se=sd(., na.rm=TRUE)/sqrt(n()))) %>% 
  inner_join(dy, by=c("disturb_year" = "maxyear")) 
```

```{r some_functions}
#https://gist.github.com/ottadini/6882677 
lm_eqn = function(m) {
  eq2 <- substitute(~~italic(r)^2~"="~rvalue*","~italic(p)~"="~pvalue,  
                    list(rvalue = formatC(summary(m)$r.squared, digits = 3, format = "f"), 
                         pvalue = formatC(summary(m)$coefficients[2,4], digits = 3, format = "f")))
  
  as.character(as.expression(eq2));                 
}


fit_model <- function(x){
  lm(value ~ d_severity, data = x)
}


# Get R2 and p.value 
get_rsq <- function(mod) broom::glance(mod)$r.squared
get_pvalue <- function(mod) broom::glance(mod)$p.value


```


**Figure 6.** Resilience metrics of tree-growth for eigth severe drought events since 1950 (see main text for details) as a function of drought severity. *Left*: Resistance (*Rt*); *Center*: Recovery (*Rc*); *Right*: Resilience (*Rs*). Points indicate resilience metrics for oak populations: SJ (*red*), CA-High (*blue*) and CA-Low (*green*). Resilience metrics were computed for each population (sample depth > 10) and drought event. Gray lines represent overall relationships for each Resilience metrics.


```{r}
# Include 1995
dfall <- df %>% 
  filter(samps >= 10) %>% 
  group_by(disturb_year, site) %>% 
  filter(disturb_year > 1940) %>% 
  summarise_at(c("rt_mean", "rs_mean", "rc_mean", "rrs_mean"), 
               funs(mean(., na.rm = TRUE), sd(., na.rm=TRUE),se=sd(., na.rm=TRUE)/sqrt(n()))) %>% 
  inner_join(dy, by=c("disturb_year" = "maxyear")) %>% 
  dplyr::select(disturb_year, site, rt_mean_mean, rs_mean_mean, rc_mean_mean, 
               d_severity) %>% 
  rename_at(vars(ends_with("_mean")), funs(str_remove(., "_mean_mean"))) %>% 
  rename("a.rt" = "rt", "b.rc" = "rc", "c.rs" = "rs") %>% 
  gather("res_index", "value", a.rt, b.rc, c.rs)


p <- ggplot(dfall, aes(x = d_severity, y = value, colour=site, 
                    fill=site, label = disturb_year)) + 
  geom_smooth(method='lm', se=FALSE) + 
  geom_smooth(method='lm', se=FALSE, aes(group=1),  size = 1, colour = "grey") +
  geom_point(size=1.5, pch = 21) +
  geom_text_repel(nudge_x = 0.5, size = 2, show.legend = FALSE) +
  theme_bw() +
  theme(panel.grid = element_blank(), 
        axis.text = element_text(size=9),
        legend.position = "bottom", 
        strip.background = element_rect(fill = "white"),
        strip.text = element_text(size = 11, face = "bold.italic")) +
  scale_colour_manual(values = colores_den) +
  scale_fill_manual(values = colores_den) +
  xlab("Drought Severity") + ylab("") + 
  xlim(5,25) + ylim(0.3,3.8) +
  facet_wrap(~res_index, labeller = as_labeller(c("a.rt" = "Resistance", 
                                                  "b.rc" = "Recovery", 
                                                  "c.rs" = "Resilience"))) +
  stat_fit_glance(method = "lm",
                  method.args = list(formula = y ~ x),
                  aes(label = sprintf('r^2~"="~%.3f~~italic(p)~"="~%.3f',
                      stat(r.squared), stat(p.value))),
                  parse = TRUE) +
  guides(fill = guide_legend(override.aes = list(linetype = 0)),
        color = guide_legend(override.aes = list(size=3)))


# Add global eq
dfaux <- dfall %>%
  group_by(res_index) %>% 
  nest() %>%
  mutate(model = map(data, fit_model)) %>% 
  mutate(eq = map(model, lm_eqn))


res_long_term_sites_all <- p + geom_text(data = dfaux, 
              aes(x = 15, y = 0.3, label = eq), 
              inherit.aes = FALSE, parse = TRUE, 
              col = "gray40")

```

```{r, eval=FALSE, echo=FALSE}
## Esto no es necesario, es solamente para calcular lm y demÃ¡s por tibles
dfpub <- dfall %>% group_by(res_index, site) %>% nest() 

dfpub <- dfpub %>% 
  mutate(model = map(data, fit_model)) %>% 
  mutate(eq = map(model, lm_eqn))
  
# mutate(r.squared = map_dbl(model, get_rsq),
#                         pvalue = map_dbl(model, get_pvalue)) 
# d <- dfpub %>% unnest(data, .drop = T) 
```


```{r, fig.width=6, dpi = 300, out.width = 0.8}
res_long_term_sites_all
```


```{r}
# SAVE as eps 
ggsave(filename = here::here("./man/figures/svg/fig_6.jpg"), 
       dpi = 300,  plot=res_long_term_sites_all, width=25, height=14, units = "cm")
ggsave(filename = here::here("./man/figures/svg/fig_6.eps"), 
       dpi = 300,  plot=res_long_term_sites_all, width=25, height=14, units = "cm")
ggsave(filename = here::here("./man/figures/svg/fig_6.svg"), 
       dpi = 300,  plot=res_long_term_sites_all, width=25, height=14, units = "cm")

```


```{r no95}
# No 1995
dfno95 <- df %>% 
  filter(disturb_year != 1995) %>% 
  filter(samps >= 10) %>% 
  group_by(disturb_year, site) %>% 
  filter(disturb_year > 1940) %>% 
  summarise_at(c("rt_mean", "rs_mean", "rc_mean", "rrs_mean"), 
               funs(mean(., na.rm = TRUE), sd(., na.rm=TRUE),se=sd(., na.rm=TRUE)/sqrt(n()))) %>% 
  inner_join(dy, by=c("disturb_year" = "maxyear")) %>% 
  dplyr::select(disturb_year, site, rt_mean_mean, rs_mean_mean, rc_mean_mean, 
               d_severity) %>% 
  rename_at(vars(ends_with("_mean")), funs(str_remove(., "_mean_mean"))) %>% 
  rename("a.rt" = "rt", "b.rc" = "rc", "c.rs" = "rs") %>% 
  gather("res_index", "value", a.rt, b.rc, c.rs)


g <- ggplot(dfno95, aes(x = d_severity, y = value, colour=site, 
                    fill=site, label = disturb_year)) + 
  geom_smooth(method='lm', se=FALSE) + 
  geom_smooth(method='lm', se=FALSE, aes(group=1),  size = 1, colour = "grey") +
  geom_point(size=1.5, pch = 21) +
  geom_text_repel(nudge_x = 0.5, size = 2, show.legend = FALSE) +
  theme_bw() +
  theme(panel.grid = element_blank(), 
        axis.text = element_text(size=9),
        legend.position = "bottom", 
        strip.background = element_rect(fill = "white"),
        strip.text = element_text(size = 11, face = "bold.italic")) +
  scale_colour_manual(values = colores_den) +
  scale_fill_manual(values = colores_den) +
  xlab("Drought Severity") + ylab("") + 
  # xlim(5,20) + 
  ylim(0.3,2) +
  facet_wrap(~res_index, labeller = as_labeller(c("a.rt" = "Resistance", 
                                                  "b.rc" = "Recovery", 
                                                  "c.rs" = "Resilience"))) +
  stat_fit_glance(method = "lm",
                  method.args = list(formula = y ~ x),
                  aes(label = sprintf('r^2~"="~%.3f~~italic(p)~"="~%.3f',
                      stat(r.squared), stat(p.value))),
                  parse = TRUE) +
  guides(fill = guide_legend(override.aes = list(linetype = 0)),
        color = guide_legend(override.aes = list(size=3)))


# Add global eq
dfauxno95 <- dfno95 %>%
  group_by(res_index) %>% 
  nest() %>%
  mutate(model = map(data, fit_model)) %>% 
  mutate(eq = map(model, lm_eqn))



res_long_term_sites_no95 <-  g + geom_text(data = dfauxno95, 
              aes(x = 12, y = 0.3, label = eq), 
              inherit.aes = FALSE, parse = TRUE, 
              col = "gray40")
```


```{r}
# SAVE as eps 
ggsave(filename = here::here("./man/figures/svg/fig_s8.jpg"), 
       dpi = 300,  plot=res_long_term_sites_no95, width=25, height=14, units = "cm")
ggsave(filename = here::here("./man/figures/svg/fig_s8.eps"), 
       dpi = 300,  plot=res_long_term_sites_no95, width=25, height=14, units = "cm")
ggsave(filename = here::here("./man/figures/svg/fig_s8.svg"), 
       dpi = 300,  plot=res_long_term_sites_no95, width=25, height=14, units = "cm")

```




```{r, echo=FALSE, eval=FALSE}
# Analisis global 
dff <- sdf %>% 
  dplyr::select(d_severity, rt_mean_mean, rs_mean_mean, rc_mean_mean) %>% 
  gather(key = res_metric, value,c(rt_mean_mean,rs_mean_mean,rc_mean_mean))

nested_df <- group_by(dff, res_metric) %>% nest()

nested_df <- nested_df %>% 
  mutate(model = map(data, fit_model))

nested_df <- nested_df %>% 
  mutate(r.squared = map_dbl(model, get_rsq),
         pvalue = map_dbl(model, get_pvalue))

```



```{r, eval= FALSE, echo = FALSE}

# Plot separately 
library("purrr")

plotrelsite <- function(df, v, x, label, site, titulo, coord_eqX, xLM, yLM, ...){
  require(ggplot2)
  require(ggrepel)
  require(purrr)

  formulita <- as.formula(paste0(v, "_mean_mean ~", x))
  
  eqns <- df %>% split(.$site) %>% 
    map(~ lm(formulita, data = .)) %>%
    map(lm_eqn) %>% 
    do.call(rbind, .) %>%
    as.data.frame() %>%
    set_names("equation") %>%
    mutate(site = rownames(.))
  
  ggplot(df, 
         aes_string(y=paste0(v, "_mean_mean"), x=x, label=label, colour=site, fill=site)) +
    geom_smooth(method='lm', se=FALSE, aes(group=1), colour='gray',  size = 1) + # linetype = "dotted",
    geom_smooth(method='lm', se=FALSE) + 
    geom_point(size=1.5, pch = 21) + 
    theme_bw() + 
    geom_text_repel(nudge_x = 0.5, size = 2, show.legend = FALSE) + 
    ggtitle(titulo) + 
    theme(plot.title = element_text(size = 11, face = "bold.italic"),
          panel.grid = element_blank(), 
          axis.text.y = element_text(size=9),
          axis.text.x = element_text(size=9),
          axis.title = element_text(size = 10)) +
    geom_text_repel(data = eqns, aes(x = coord_eqX, y = Inf, label = equation),
                    direction = "y", segment.size = 0, hjust = 0,
                    parse = TRUE, show.legend = FALSE) +
    annotate("text", x = xLM, y = yLM, 
             label=lm_eqn(lm(formulita, df)), parse=TRUE, 
             size = 4, fontface = "bold", hjust="left", col = "gray40") +
    scale_colour_manual(values = colores_den) +
    scale_fill_manual(values = colores_den)
    
}



# Include 1995
sdfsite <- df %>% 
  filter(samps >= 10) %>% 
  group_by(disturb_year, site) %>% 
  filter(disturb_year > 1940) %>% 
  summarise_at(c("rt_mean", "rs_mean", "rc_mean", "rrs_mean"), 
               funs(mean(., na.rm = TRUE), sd(., na.rm=TRUE),se=sd(., na.rm=TRUE)/sqrt(n()))) %>% 
  inner_join(dy, by=c("disturb_year" = "maxyear")) 



sevRt_site <- plotrelsite(sdfsite, v = "rt", x = 'd_severity', label = 'disturb_year', site = "site",
             titulo = "Rt", coord_eqX = Inf, xLM = -Inf, yLM = 0.5) + xlab('') + ylab('') + xlim(5,25) + ylim(0,3.8)

sevRs_site <- plotrelsite(sdfsite, v = "rs", x = 'd_severity', label = 'disturb_year', site = "site",
                 titulo = "Rs", coord_eqX = -Inf, xLM = 10, yLM = 0.5) + xlab('') + ylab('') + xlim(5,25) +  ylim(0,3.8)

sevRc_site <- plotrelsite(sdfsite, v = "rc", x = 'd_severity', label = 'disturb_year', site = "site",
                 titulo = "Rc",  coord_eqX = -Inf, xLM = 10, yLM = 0.5) +
  xlab("Drought Severity") + ylab("") + xlim(5,25) +  ylim(0,3.8)



res_long_term_sites <- sevRt_site + theme(legend.position="none") +
  sevRc_site + theme(legend.position="bottom") +
  sevRs_site + theme(legend.position = "none") + plot_layout(nrow = 1) 





sevRt_site95 <- plotrelsite(sdfsite95, v = "rt", x = 'd_severity', label = 'disturb_year', site = "site",
                 titulo = "Rt", coord_eqX = Inf, xLM = -Inf, yLM = 0.5) + xlab('') + ylab('') 

sevRs_site95 <- plotrelsite(sdfsite95, v = "rs", x = 'd_severity', label = 'disturb_year', site = "site",
                 titulo = "Rs", coord_eqX = Inf, xLM = 10, yLM = 0.5) + xlab('') + ylab('') 

sevRc_site95 <- plotrelsite(sdfsite95, v = "rc", x = 'd_severity', label = 'disturb_year', site = "site",
                 titulo = "Rc",  coord_eqX = -Inf, xLM = 10, yLM = 0.5) + xlab("Drought Severity") + ylab("") 

res_long_term_sites95 <- sevRt_site95 + theme(legend.position="none") +
  sevRc_site95 + theme(legend.position="bottom") +
  sevRs_site95 + theme(legend.position = "none") + plot_layout(nrow = 1) 


ggsave(filename = here::here("./man/figures/svg/fig_6_no95.jpg"), 
       dpi = 300,  plot=res_long_term_sites95, width=25, height=14, units = "cm")
ggsave(filename = here::here("./man/figures/svg/fig_6_no95.eps"), 
       dpi = 300,  plot=res_long_term_sites95, width=25, height=14, units = "cm")
ggsave(filename = here::here("./man/figures/svg/fig_6_no95.svg"), 
       dpi = 300,  plot=res_long_term_sites95, width=25, height=14, units = "cm")


# {r, fig.width=6, dpi = 300, out.width = 0.8}
res_long_term_sites95

library(ggpubr)

ggscatter(
  sd, x = "Sepal.Length", y = "Sepal.Width",
  color = "Species", palette = "jco",
  add = "reg.line"
  ) +
  facet_wrap(~site) +
  stat_cor(label.y = 4.4) +
  stat_regline_equation(label.y = 4.2)


df1 <- sdfsite %>% dplyr::select(disturb_year, d_severity, rt_mean_mean, site) 
 
  ggscatter(df1, x = "d_severity", y = "rt_mean_mean", 
            color = "site", palette = c("#00AFBB", "#E7B800", "#FC4E07"), 
            label = "disturb_year", font.label = c(8, "plain"), repel = TRUE, 
            add = "reg.line", ccor.coef = TRUE) +
    ggpubr::stat_cor(label.x= 15, aes(color = site, label = paste(..rr.label.., ..p.label.., sep = "~`,`~"))) +
    ggpubr::stat_cor(label.x= 15, aes(label = paste(..rr.label.., ..p.label.., sep = "~`,`~")))
    

  
df2 <-sdfsite %>% dplyr::select(disturb_year, site, rt_mean_mean, rs_mean_mean, rc_mean_mean, d_severity) %>%  gather(variable, value, c("rt_mean_mean", "rs_mean_mean", "rc_mean_mean")) 

ggscatter(df2, x = "d_severity", y = "value", 
            color = "site", palette = c("#00AFBB", "#E7B800", "#FC4E07"), 
            label = "disturb_year", font.label = c(8, "plain"), repel = TRUE, 
            add = "reg.line", ccor.coef = TRUE) + 
  facet_wrap(~variable, scales = "free") + 
  ggpubr::stat_cor(label.x= 15, aes(color = site, label = paste(..rr.label.., ..p.label.., sep = "~`,`~"))) +
    ggpubr::stat_cor(label.x= 15, aes(label = paste(..rr.label.., ..p.label.., sep = "~`,`~")))


# another way 

# Create df with lm
dflm <- df_test %>% 
  group_by(res_index, site) %>% 
  do(fit = lm(value ~ d_severity, data =.)) 

dfeq <- dflm %>% mutate(r.squared = map_dbl(fit, get_rsq),
         pvalue = map_dbl(fit, get_pvalue))

dfeq <- dflm %>% broom::glance(fit)$r.squared

# function to get expression p.value
mieq = function(x) {
      eq <- substitute(~~italic(r)^2~"="~rvalue*","~italic(p)~"="~pvalue,
           list(rvalue = formatC(x$r.squared, digits = 3, format = "f"),
                pvalue = formatC(x$p.value, digits = 3, format = "f")))
  
  as.character(as.expression(eq));
}


equations <- dfeq %>% group_by(res_index, site) %>% summarise(eq = mieq(.data))
  

df <- df_test %>% 
  inner_join(dfeq, by = c("site", "res_index")) %>% 
  inner_join(equations, by = c("site", "res_index"))
  

# GGpubr 
library(ggpubr)
library(rstatix)


format_pval <- function(pval){
  pval <- scales::pvalue(pval, accuracy= 0.0001, add_p = TRUE)
  gsub(pattern = "(=|<)", replacement = " \\1 ", x = pval)
}
# 

# trailing zeros 

ggscatter(df_test, x = "d_severity", y = "value", color="site", 
          facet.by = "res_index", 
          panel.labs = list("res_index" =c("Resistance", "Recovery", "Resilience")),
          add = "reg.line", label = "disturb_year", repel = TRUE, font.label = c(8, "plain")) + 
    scale_colour_manual(values = colores_den) +
  scale_fill_manual(values = colores_den) +
   stat_cor(
     aes(color = site, 
         label = #paste(
           paste("italic(r)^2", round(..estimate..^2, digits=3), sep = "~`=`~"),
           format_pval(..p..),
          # paste("italic(p)", round(..p.value.., 3), sep = "~`=`~"),
           sep = "~`,`~")))

```





