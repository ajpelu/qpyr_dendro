---
output:
  word_document
bibliography: ../../refs/references.bib
csl: ../../refs/ecology.csl
editor_options: 
  chunk_output_type: console
---

```{r, include=FALSE}
knitr::opts_chunk$set(echo = FALSE, message=FALSE, warning = FALSE)
```


```{r load_pkg}
library("tidyverse")
library("here")
library("ggrepel")
library("scales")
library("grid")
library("gridExtra")
library("patchwork")
library("stringr")
library("pander")
library("lemon")
library("magrittr")
source(here::here('/script/R/custom_functions.R'))
```


```{r}
cro_sites <- read.csv(here("data/cronos_medias", "cronos_sites.csv"), header = TRUE, sep = ',')

cro_sites <- cro_sites %>% mutate(site = 
  case_when(
    site == "CA_Low" ~ "CA-Low", 
    site == "CA_High" ~ "CA-High",
    site == "SJ" ~ "SJ",
  )
)

# To get p.value of the model 
# https://stackoverflow.com/questions/5587676/pull-out-p-values-and-r-squared-from-a-linear-regression
lmp <- function(modelobject) {
    if (class(modelobject) != "lm") stop("Not an object of class 'lm' ")
    f <- summary(modelobject)$fstatistic
    p <- pf(f[1],f[2],f[3],lower.tail=F)
    attributes(p) <- NULL
    return(p)
}


year_init <- 1975

# Lm CA-High
dfCaH <- cro_sites %>% 
  filter(year >= year_init) %>% 
  filter(site == 'CA-High')

mCaH <- lm(bai_mean ~ year, dfCaH)
r2caH <- format(summary(mCaH)$r.squared, digits = 3)
pCaH <- lmp(mCaH)


# Lm CA-Low 
dfCaL <- cro_sites %>% 
  filter(year >= year_init) %>% 
  filter(site == 'CA-Low')

mCaL <- lm(bai_mean ~ year, dfCaL)
r2caL <- format(summary(mCaL)$r.squared, digits = 3)
pCaL <- lmp(mCaL)

# Lm SJ
dfSJ <- cro_sites %>% 
  filter(year >= year_init) %>% 
  filter(site == 'SJ')

mSJ <- lm(bai_mean ~ year, dfSJ)
r2SJ <- format(summary(mSJ)$r.squared, digits = 3)
pSJ <- lmp(mSJ)


lms <- data.frame(year = as.numeric(c(2018, 2018, 2018)),
                     site = c("CA-Low", "CA-High", "SJ"), 
                     r2 = as.numeric(c(r2caL, r2caH, r2SJ)),
                     pvalue = as.numeric(round(c(pCaL, pCaH, pSJ), 4)),
                     y = as.numeric(
                       c(as.numeric(predict(mCaL)[40]), 
                           as.numeric(predict(mCaH)[40]), 
                           as.numeric(predict(mSJ)[40]))))
# lms$y <- lms$y / 100
lms <- lms %>% mutate(
  y = y/100,
  pc = ifelse(pvalue < 0.001, "p < 0.001", as.character(paste0("p = ", pvalue))),
  label = round(r2,3), 
  labelp = ifelse(pvalue < 0.001, paste0(label, "**"), label))
  
```


```{r plot_cronobai}
# cores 
cronos_bai <- cro_sites %>% filter(nseries > 5) %>% 
  ggplot(aes(x=year, y=bai_mean/100, colour=site)) + 
  theme_bw() + ylab('BAI') + xlab("") + 
  geom_ribbon(aes(ymin = (bai_mean - bai_se)/100,
                  ymax = (bai_mean + bai_se)/100,
                  fill=site), alpha=.4, colour=NA) +
  geom_line() + 
  geom_point(size=.8) + 
  scale_colour_manual(values = colores_den) +
  scale_fill_manual(values = colores_den) +
  ylab(expression(paste("BAI (", cm^2, year^-1, ")", sep=''))) +
  scale_x_continuous(breaks = seq(1815, 2020, by=10), limits=c(1815,2020), sec.axis = dup_axis()) +
  geom_smooth(data = subset(cro_sites, year > year_init & site == 'CA-High'), 
              aes(x=year, y=bai_mean/100, colour=site), method = 'lm', se=FALSE, size = .5) +
  geom_smooth(data = subset(cro_sites, year > year_init & site == 'CA-Low'), 
              aes(x=year, y=bai_mean/100, colour=site), method = 'lm', se=FALSE, size = .5) +
  geom_smooth(data = subset(cro_sites, year > year_init & site == 'SJ'), 
              aes(x=year, y=bai_mean/100, colour=site), method = 'lm', se=FALSE, size = .5)  +
  geom_text_repel(data = lms, 
                  aes(x=year, y = y, colour = site, label = labelp),
                  direction = "x", nudge_x = Inf, nudge_y = 1, show.legend = FALSE, 
                  size = 3) + 
  theme(panel.grid = element_blank(),
        axis.text.x=element_text(size=6),
        legend.position = c(0.2,.8),
        strip.background = element_blank(),
        axis.ticks.length.x.top = unit(-3.5, "pt"),
        axis.title.x.top = element_blank(), 
        axis.text.x.top = element_blank())  
```


```{r plot_samp}
  # scale_y_continuous(sec.axis = sec_axis(~ ., name = '# trees', breaks = c(0,15,30))) +
  # geom_line(aes(x=year, y=n_trees+40, colour=site)) 
samp <- cro_sites %>% ggplot(aes(x=year, y=n_trees, colour=site)) + 
  theme_bw() + ylab('# trees') + 
  geom_line() + 
  scale_colour_manual(values = colores_den) +
  scale_fill_manual(values = colores_den) +
  scale_x_continuous(breaks = seq(1815, 2020, by=10), limits=c(1815,2020), 
                     sec.axis = dup_axis(), position = "top") +
  theme(panel.grid = element_blank(),
        legend.position = "none", 
        axis.title.x=element_blank(),
        axis.text.x.top = element_text(size=6), 
        axis.text.x.bottom = element_blank(), 
        axis.ticks.x.bottom =element_blank(),
        axis.line.x.bottom = element_blank(), 
        #panel.border = element_blank(), 
        # axis.line.y.right = element_line(), 
        # axis.line.x.top = element_line(), 
        # axis.line.y.left = element_line(),
        plot.margin = unit(c(0,0,-4,0), "pt")
        # axis.ticks.x=element_blank(), 
        # plot.margin = margin(t = 5, r = 0, b = -5, l = 0, unit = "pt")
        ) 
  # theme(plot.margin = unit(c(1,5,-30,6),units="points"),
  #       axis.title.y = element_text(vjust =0.25))
```



```{r datagc}
gc_todos <- read.csv(here::here("data/disturbance", "disturbance_gc.csv"), header = TRUE, sep = ',')

# customize plot (corrected scale)
pos_neg_log <- scales::trans_new('signed_log', 
                                 transform = function(x) sign(x)*log(abs(x)),
                                 inverse = function(x) sign(x)*exp(abs(x)))

plotGC <- function(df, y, yse, x, my_ylab, 
                   micolor, limitesX, ...){ 
  # Get error bar aesthetic
  yerrorbar <- aes_string(ymin = paste(y, yse, sep = '-'),
                         ymax = paste(y, yse, sep = '+'))
  
  p <- ggplot(df, aes_string(x = x, y = y)) +
    geom_errorbar(mapping = yerrorbar, colour = micolor, width = .35, size = .2, 
                  na.rm = TRUE) + 
    geom_bar(stat = 'identity', fill = micolor, colour = micolor) +
    geom_hline(yintercept = 0, colour = 'black', lwd = 0.2) + 
    ylab(my_ylab) +
    # Add line to %GC = 50 
    geom_hline(yintercept = c(50, -50), linetype=2, colour='black', lwd=0.2) +
    theme_bw() +
    theme(panel.grid = element_blank(),
          axis.text.y = element_text(size = 5.5),
          axis.text.x = element_text(size = 6)) +
    coord_cartesian(xlim=limitesX)
    # Customize limits and breaks to min of year data 
  p
}


# ---------- Min and Max axis        
# Get min and max of year range and create vector of 10 years for labelling

# ajustar limites X para combinar con otra figura 
limitesX <- c(1815,2020)
# ajustar rango para combinar con otra figura 
mi_scalex <- scale_x_continuous(breaks = seq(1815, 2020, by=10), limits=c(1815,2020)) 


# xrange <- seq(round(min(gc_todos$year) / 10) * 10, 
#     round(max(gc_todos$year) / 10) * 10, by = 10)
# 
# limitesX <- c(min(gc_todos$year), max(gc_todos$year))

# Get automatically limits of y for caH anc caL
minimoY <- min((gc_todos %>% 
      dplyr::filter(site != 'gc_sj' & gc_md < 0) %>% 
      mutate(error = gc_md - gc_md_se))$error, na.rm = TRUE) 
   
maximoY <- max((gc_todos %>% 
      dplyr::filter(site != 'gc_sj' & gc_md > 0) %>% 
      mutate(error = gc_md + gc_md_se))$error, na.rm = TRUE) 

# Establece rango de datos para y 
mismo_y <- scale_y_continuous(limits=c(minimoY, maximoY), 
                            breaks = c(-100, -50, 0, 50, 50, 100, 150))


```



```{r plot_caH}
pcaH <- gc_todos %>% dplyr::filter(site == 'gc_caH') %>% 
  plotGC(y = 'gc_md', yse = 'gc_md_se', x = 'year', 
         my_ylab = NULL, micolor = colores_den[1], limitesX = limitesX) + 
  mismo_y + xlab('') + mi_scalex + 
  # scale_x_continuous(breaks = xrange, position = 'bottom') + 
  annotate("text", x = 1990, y = 120, label = "CA-High", fontface = 2, size = 3)
```

```{r plot_caL}
pcaL <- gc_todos %>% dplyr::filter(site == 'gc_caL') %>% 
  plotGC(y = 'gc_md', yse = 'gc_md_se', x = 'year',
         my_ylab = '% GC', micolor = colores_den[2], limitesX = limitesX) + 
  mismo_y +  xlab('') + mi_scalex + 
  # scale_x_continuous(breaks = xrange, position = 'bottom') +  
  annotate("text", x = 1990, y = 120, label = "CA-Low", fontface = 2, size = 3) 
```

```{r plot_SJ}
psj <- gc_todos %>% dplyr::filter(site == 'gc_sj') %>% 
  plotGC(y = 'gc_md', yse = 'gc_md_se', x = 'year', 
         my_ylab = NULL, micolor = colores_den[3], limitesX = limitesX) + 
  xlab('') + xlab('Year') + mi_scalex + 
  # scale_x_continuous(breaks = xrange, position = 'bottom') + 
  scale_y_continuous(trans = pos_neg_log, 
                     breaks=c(-1000, -500, -100, 1, 100, 500)) + 
  geom_hline(yintercept = 1,  lwd=0.2)+
  annotate("text", x = 1990, y = 440, label = "SJ", fontface = 2, size = 3)

```


```{r}
samp <- samp + labs(tag='a')
cronos_bai <- cronos_bai + theme(plot.margin = unit(c(0,0,-4,0), "pt"))
pcaH <- pcaH + theme(plot.margin = unit(c(0,0,-5,0), "pt")) + labs(tag = 'b')
pcaL <- pcaL + theme(plot.margin = unit(c(0,0,-5,0), "pt"))
psj <- psj +  theme(plot.margin = unit(c(0,0,-4,0), "pt"))
```


```{r, fig.height=10, dpi = 300, out.width = 0.8}
cronos_bai_gc <- 
(samp / cronos_bai) + pcaH + pcaL + psj +
  plot_layout(ncol = 1, heights = c(0.13/2, 0.87/2, rep(1/3, 3)/2))

```

```{r, fig.height=10, dpi = 300, out.width = 0.8}
cronos_bai_gc 
```

```{r}
saveImage(cronos_bai_gc, path="./man/figures/svg/", dpi=300, w=25, h=27, fig= "cronos_bai_gc", u = "cm") 
```









**Figure 3.** a) Basal Area Increment (BAI) chronologies of *Q. pyrenaica* for northern population (SJ; *red*) and southern ones: low-elevation (CA-Low; *green*) and high-elevation (CA-High, *blue*) sites. Shading areas correspond to standard error of the mean. Number of series is displayed in the upper plot. We only show years replicated with # series > 5. Linear trends since 1975 are shown all sites (numbers indicate $r^2$ values; asterisks indicate significant linear trend, *p < 0.001*). b) Comparison of median growth change ($GC$) following @Nowacki1997 for *Q. pyrenaica* sites. Dashed black lines indicate a threshold of 50 % of GC (see material and methods). Note that y-axes do not correspond in all of the three panels for the sake of clarity. Error bars indicate standard error. 




