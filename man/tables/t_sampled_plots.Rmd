---
output:
  word_document:
    reference_docx: ../../templates/template_tables_portrait.docx
bibliography: ../../refs/references.bib
csl: ../../refs/ecosystems.csl
---

```{r, include=FALSE}
knitr::opts_chunk$set(echo = FALSE, message=FALSE, warning = FALSE)
```

```{r}
library(tidyverse)
library(here)
library(pander)
library(kableExtra)
library(knitr)
library(dplyr)
library(flextable)
library(officer)
```


**Table 1.** Characteristics of sampled plot. Lat = latitude; Long = longitude. Dbh and height of all trees, Basal Area (BA), Density and SRD (Size ratio proportional to distance) are computed for all trees within a 10-m radius of focal trees (see methods). Temp.: annual average of mean monthly minimun and maximum temperatures. Values shown here correspond to site averages. Standard deviations are shown in parentheses. Different letters indicate statistically significant differences between sites (Kruskal-Wallis test followed by Dunnâ€™s test, p<0.05). Stands were monospecific, hence all results correspond to oak data. 



```{r}
topo <- read.csv(here::here("/data/sites_summary", "site_general.csv"), header = TRUE)
ages <- read.csv(here::here("/data/dendro_summary", "site3_avg_ages.csv"), header = TRUE)
dendro_summ <- read.csv(here::here("/data/dendro_summary", "site3_dendro_summary.csv"), header = TRUE)
biotic <- read.csv(here::here("/data/competence", "biotic_stand_features.csv"), header = TRUE)
letritas <- read.csv(here::here("/out/kw_stand_features", "kw_letras.csv"), header = TRUE)

letritas <- letritas %>% 
  mutate(letter = as.character(letter)) %>% 
  mutate(mivar = paste0(mivariable, '_l')) %>%
  dplyr::select(-mivariable) %>% 
  spread(key=mivar, letter)


t1raw <- topo %>% inner_join(ages, by='site') %>% 
  inner_join(dendro_summ, by='site') %>% 
  inner_join(biotic, by='site') %>% 
  inner_join(letritas, by='site')


t1raw <- t1raw %>% mutate(name = case_when(
  site == 'caH' ~ 'CA-High', 
  site == 'caL' ~ 'CA-Low',
  site == 'sj' ~ 'SJ')) 

# ADD data climate
# clima obsnev (from repo clima SN; son datos de mapas pasados 100 x 100 1960 - 2010)

# clima <- read.csv(here::here("/data/climate_obsnev", "obsnev_qp_pop.csv"), header = TRUE)
# cli <- clima %>% filter(pop %in% c(2,6)) %>% mutate_if(is.numeric, funs(round(., 1))) %>% 
#   dplyr::select(pop, mean, variable) %>% 
#   spread(variable, mean) %>% 
#   mutate(name = case_when(
#     pop == 2 ~ 'SJ',
#     pop == 6 ~ 'CA-High'
#   )) %>% dplyr::select(-pop) 
# 
# # duplicate row for CA site
# x <- cli[2,] 
# x$name <- 'CA-Low'
# cli <- cli %>% bind_rows(x) %>% 
#   mutate_at(1, round, 0) %>% 
#   unite(temp, c(tmin, tmax), sep=" - ") 


# Update use worlclim2 
clima <- read.csv(here::here("/data/climate_worldclim", "dendro_worldclim.csv"), header = TRUE)

clima <- clima %>% 
  mutate(site = case_when(
    site == 'SJHigh' ~ 'SJ', 
    site == 'SJLow' ~ 'SJ',  
    site == 'CAHigh' ~ 'CA-High',
    site == 'CALow' ~ 'CA-Low'
  )) %>% 
  mutate_at(2, round, 0) %>% 
  mutate_at(3:5, round, 1) %>% 
  group_by(site) %>% 
  summarise_each(mean) %>% 
  dplyr::select(name = site, prec = p, tmin, tmax) %>% 
  unite(temp, c(tmin, tmax), sep="-")




        
t1raw <- t1raw %>% inner_join(clima, by='name') 


t1 <- t1raw %>% dplyr::select(
  name, lat_m, long_m, elev_min, elev_max, slope_mean, slope_sd, prec, temp, 
  n_trees, n_radii, dn_mean, dn_sd, h_mean, h_sd, age_mean, age_std, age_l, 
  dn_mean_all, dn_sd_all, h_mean_all, h_sd_all,
  ba_mean, ba_sd, stand_density_mean, stand_density_sd, srd_mean, srd_sd,
  all_dn_l, all_h_l, ba_l, ft_dn_l, ft_h_l, std_l, srd_l
  ) %>% 
  mutate(pare = ")") %>% 
  mutate_at(c("lat_m","long_m","slope_mean","slope_sd","ba_mean","ba_sd","srd_mean","srd_sd"), 
            funs(formatC(., digits = 2,format='f'))) %>%  
  mutate_at(.vars = c("prec"), funs(format(., digits = 0))) %>% 
  # mutate_at(c(10:19, 22:23), round, 1) %>% 
  mutate_at(c("dn_mean","dn_sd","h_mean","h_sd","age_mean","age_std","dn_mean_all","dn_sd_all","h_mean_all","h_sd_all","stand_density_mean","stand_density_sd"),
            funs(formatC(., digits = 1,format='f'))) %>%
  mutate_at(c("elev_min", "elev_max"), funs(round(., 0))) %>% 
  unite(elev, c(elev_min, elev_max), sep= " - ") %>% 
  unite(slope, c(slope_mean, slope_sd), sep=" (") %>% 
  unite(n_trees, c(n_trees, n_radii), sep=" (") %>% 
  unite(dn, c(dn_mean, dn_sd), sep=" (") %>% 
  unite(h, c(h_mean, h_sd), sep=" (") %>% 
  unite(age, c(age_mean, age_std), sep=" (") %>% 
  unite(dn_all, c(dn_mean_all, dn_sd_all), sep=" (") %>% 
  unite(h_all, c(h_mean_all, h_sd_all), sep=" (") %>% 
  unite(ba, c(ba_mean, ba_sd), sep=" (") %>% 
  unite(stand_density, c(stand_density_mean, stand_density_sd), sep=" (") %>% 
  unite(srd, c(srd_mean, srd_sd), sep=" (") %>% 
  mutate(
    slope = paste0(slope, pare),
    n_trees = paste0(n_trees, pare),
    dn = paste(paste0(dn, pare), ft_dn_l, sep=" "),
    h = paste(paste0(h, pare), ft_h_l, sep = ' '),
    age = paste(paste0(age, pare), age_l, sep = ' '),
    dn_all = paste(paste0(dn_all, pare), all_dn_l, sep = ' '),
    h_all = paste(paste0(h_all, pare), all_h_l, sep = ' '),
    ba = paste(paste0(ba, pare), ba_l, sep = ' '),
    stand_density = paste(paste0(stand_density, pare), std_l, sep = ' '),
    srd = paste(paste0(srd, pare), srd_l, sep = ' ')) %>%
  dplyr::select(-pare, -all_dn_l, -all_h_l, -ba_l, -ft_dn_l, -ft_h_l, -std_l, -srd_l, -age_l) 


std_border = fp_border(width = 1)

ta <- regulartable(t1, col_keys =c("name", "lat_m", "long_m", "elev", "slope", "prec", "temp",
                                   "n_trees","dn","h","age","dn_all","h_all","ba","stand_density","srd"))

ta <- ta %>% set_header_labels(name = "Site", lat_m = "Lat (\u00B0)", long_m = "Long (\u00B0)", 
                               elev = "Elevation\n(m)", slope = "Slope (\u00B0)",  prec = "Prec.\n(mm)",
                               temp = "Temp.\n(\u00B0 C)", n_trees = "# trees\n(# cores)", dn = "Dbh (cm)",
                               h = "Height\n(m)", age = "Age\n(years)", dn_all = "Dbh all\n(cm)", 
                               h_all = "Height all\n(m)", ba = "BA\n(m2/ha)", 
                               stand_density = "Density\n(trees/ha)", srd = "SRD") %>% 
  add_header(name="", lat_m ="", long_m="", elev="", slope ="", prec = "", temp = "",
             n_trees = "Cored trees", dn = "Cored trees", h = "Cored trees", age = "Cored trees", 
             dn_all = "Stand competition", h_all = "Stand competition", ba = "Stand competition", 
             stand_density = "Stand competition", srd = "Stand competition", top = TRUE) %>% 
  merge_at(i = 1, j =c(8:11) , part = "header") %>% 
  merge_at(i = 1, j =c(12:16) , part = "header") %>% 
  align(align = "center", part = "header") %>% 
  bold(part = 'header') %>% 
  fontsize(i= 1, part = "header", size = 8) %>% 
  fontsize(i= 2, part = "header", size = 8) %>% 
  italic(i=1, part = "header") %>% 
    # General format 
  fontsize(part = "body", size = 8) %>% 
  autofit(add_w = 0) %>% 
  align(align = "center") %>% 
  width(j = c(2,3), width = 0.35) %>% 
  width(j = c(6,7,8), width = 0.6)



ta <- compose(
  ta, j = "ba", part = "header",
  value = as_paragraph(
     "BA\n(m",  
     as_chunk("2", props = fp_text(vertical.align = "superscript", font.size = 8)),
     " ha", 
     as_chunk("-1", props = fp_text(vertical.align = "superscript", font.size = 8)),
     ")"
     
  )
)

ta <- compose(
  ta, j = "stand_density", part = "header",
  value = as_paragraph(
     "Density\n(trees ha",  
     as_chunk("-1", props = fp_text(vertical.align = "superscript", font.size = 6)),
     ")"
     
  )
)

ta %>% vline(j = c(7, 11), border = std_border, part="all") 



```