---
output:
  word_document:
    fig_caption: yes
    fig_height: 6
    fig_width: 6
    highlight: null
    reference_docx: template_ms.docx
bibliography: ../refs/references.bib
csl: ../refs/ecology.csl
---

```{r, include=FALSE}
knitr::opts_chunk$set(echo = FALSE, message=FALSE, warning = FALSE, dpi = 200)
```

```{r}
library("tidyverse")
library("here")
library("dplyr")
library("ggrepel")
library("scales")

library("grid")
library("gridExtra")
library("patchwork")
```

```{r, echo=FALSE}
show_text <- FALSE
```

```{r echo=FALSE, results='asis', eval=show_text}
cat("
# Lista de figuras 

## Figure 1 Location map 
- [X] La figura 1 puede tener un mapa de localización de SN, otro de las poblaciones de roble (clasificadas por colores: cluster; y señalando las dos poblaciones muestradas en dendro). Ver MIGRAME dataset. 

    - [] Ver https://github.com/ajpelu/qpyr_dendro/blob/master/out/fig/geomap/mapa_situacion.pdf 
    - Ojo con los nombres SJ (Que hacemos?)

## Figure 2. Plot combinado con EVI profile (a) y anomalías (b)
")
```


### Figure 1

![](../out/fig/geomap/mapa_situacion.jpg){height=600px}

**Figure 1**. Distribution of *Quercus pyrenaica* forests in Iberian Peninsula (a) and in Sierra Nevada mountain range, where three clusters of oak populations have been identified [@PerezLuque2015] (showed in different colour) (b). A grid of with the MODIS pixels for each population is shown (see material and methods). Detailed location of the sampling sites: northern (San Juan, SJ) (c) and southern ones (Cáñar: CALow and CAHigh) (d). Colour Orthophotography of 2009 from Regional Ministry of the Environment, Regional Government of Andalusia.

### Figure 2 

```{r}
iv <- read.csv(here("data/evi", "iv_composite.csv"), header = TRUE, sep = ',')

drought_years <- c(2005, 2012)

evi_profile_dat_ref <- iv %>% 
  filter(!year %in% drought_years) %>% 
  group_by(composite) %>% 
  dplyr::summarise(mean=mean(evi, na.rm=TRUE),
            sd = sd(evi, na.rm=TRUE),
            se = sd/sqrt(length(evi))) %>% 
  mutate(composite_dates = 
           plyr::mapvalues(composite,
                           c(1,2,3,4,5,6,7,8,9,10,11,12,13,14,15,16,17,18,19,20,21,22,23),
                           c('01-01','01-17','02-02','02-18','03-06','03-22','04-07','04-23',
                             '05-09','05-25','06-10','06-26','07-12','07-28','08-13','08-29',
                             '09-14','09-30','10-16','11-01','11-17','12-03','12-19'))) %>%
  mutate(cd = as.Date(composite_dates, format = '%m-%d')) %>% 
  mutate(period = 'reference')

evi_profile_dat_2005 <- iv %>% 
  filter(year == 2005) %>% 
  group_by(composite) %>% 
  dplyr::summarise(mean=mean(evi, na.rm=TRUE),
            sd = sd(evi, na.rm=TRUE),
            se = sd/sqrt(length(evi))) %>% 
  mutate(composite_dates = 
           plyr::mapvalues(composite,
                           c(1,2,3,4,5,6,7,8,9,10,11,12,13,14,15,16,17,18,19,20,21,22,23),
                           c('01-01','01-17','02-02','02-18','03-06','03-22','04-07','04-23',
                             '05-09','05-25','06-10','06-26','07-12','07-28','08-13','08-29',
                             '09-14','09-30','10-16','11-01','11-17','12-03','12-19'))) %>%
  mutate(cd = as.Date(composite_dates, format = '%m-%d')) %>% 
  mutate(period = '2005')

evi_profile_dat_2012 <- iv %>% 
  filter(year == 2012) %>% 
  group_by(composite) %>% 
  dplyr::summarise(mean=mean(evi, na.rm=TRUE),
            sd = sd(evi, na.rm=TRUE),
            se = sd/sqrt(length(evi))) %>% 
  mutate(composite_dates = 
           plyr::mapvalues(composite,
                           c(1,2,3,4,5,6,7,8,9,10,11,12,13,14,15,16,17,18,19,20,21,22,23),
                           c('01-01','01-17','02-02','02-18','03-06','03-22','04-07','04-23',
                             '05-09','05-25','06-10','06-26','07-12','07-28','08-13','08-29',
                             '09-14','09-30','10-16','11-01','11-17','12-03','12-19'))) %>%
  mutate(cd = as.Date(composite_dates, format = '%m-%d')) %>% 
  mutate(period = '2012')

# Join the three dataframes
evi_profile_compara_dat <- rbind(evi_profile_dat_ref, evi_profile_dat_2005, evi_profile_dat_2012)

# colref <- '#455883'
# colref2 <- '#10253F'
# col2005 <- '#00BA38'
# col2012 <- '#F8766D'

col2012 <- '#0700fe'
col2005 <- '#19e00b'
colref <- '#7b7b7b'


profile_compara <- ggplot(evi_profile_compara_dat, aes(cd, y=mean, color=period)) + 
  geom_errorbar(aes(ymin = mean - 2*se, ymax= mean + 2*se), width=3, size=.5) + 
  #geom_errorbar(aes(ymin = mean - sd, ymax= mean + sd), width=4, colour='black') + 
  geom_line(size=.9) + 
  geom_point(size=1.5, fill='white', shape=21) +
  scale_x_date(labels = function(x) format(x, "%b"),
               breaks = date_breaks('month')) + 
  ylab('EVI') + xlab('Date') + 
  theme_bw() +
  theme_classic() + 
  theme(panel.grid.major=element_blank(),
        panel.grid.minor=element_blank(),
        legend.position = c(0.1,.9),
        plot.title = element_text(hjust = -0.05, size = 16, 
                                    margin = margin(t=-5, b=1))) +
  scale_color_manual(values=c(col2005, col2012, colref))

# profile_compara 
```


```{r}
# From explore_anomalies.Rmd 
# Read data 
anomalias_evimean <- read.csv(here("data/anomalies", "anomalias_evimean.csv"),header = TRUE, sep = ',')

anomalias_evimean <- anomalias_evimean %>% 
  mutate(
    clu_pop = as.factor(case_when(
      pop == 1 ~ "Camarate",
      pop %in% c(2,3,4,5) ~ 'Northern slope',
      pop %in% c(6,7,8) ~ 'Southern slope',
      pop == 9 ~ 'out')),
    clu_pop2 = as.factor(case_when(
      pop %in% c(1,2,3,4,5) ~ 'Northern slope',
      pop %in% c(6,7,8) ~ 'Southern slope',
      pop == 9 ~ 'out'))) %>% 
  filter(clu_pop != 'out')


# colours 
color_neg <- '#a63603'
color_pos <- '#006d2c'

# Standardized Anomalies 
avg_sa_clu <- anomalias_evimean %>% 
  group_by(clu_pop2, y) %>% 
  dplyr::summarise(mean=mean(sa, na.rm=T),
            sd = sd(sa, na.rm=T),
            se = sd/sqrt(length(sa))) %>% 
 mutate(signo = ifelse(mean >= 0, 'pos', 'neg'))

myylab <- 'EVI Standardized Anomaly'

plot_sa_clu  <- avg_sa_clu %>%  
  ggplot(aes(x=y, y=mean, fill=signo)) + 
  geom_bar(stat = "identity") + 
  geom_errorbar(aes(ymin = mean - se, ymax = mean + se, colour=signo), width=.5) +
  facet_wrap(~clu_pop2, nrow = 2) + 
  scale_fill_manual(values = c("pos" = color_pos, "neg" =  color_neg)) +
  scale_color_manual(values = c("pos" = color_pos, "neg" =  color_neg)) +
  ylab(myylab) + xlab('') +
  theme_bw() +
  theme(text = element_text(size=16),
        legend.position = "none",
        panel.grid.major.x = element_blank(),
        panel.grid.minor = element_blank(),
        strip.background = element_rect(fill = "white"),
        plot.title = element_text(hjust = -0.05, size = 16, 
                                    margin = margin(t=-5, b=1)))

# plot_sa_clu
```


```{r, fig.height=9} 
# grid.arrange(profile_compara, plot_sa_clu)
```


```{r, fig.height=7}
a_profile_compara <- profile_compara + labs(title = "a")
b_plot_sa_clu <- plot_sa_clu + labs(title = "b")
a_profile_compara + b_plot_sa_clu + plot_layout(ncol=1)
```

**Figure 2.** Comparison of EVI profile for the reference period (*gray*) and during the 2005 (*green*) and 2012 (*blue*) drought events (a) (mean of all analyzed pixels). EVI standardized anomaly ($EVI~sa$) during the period 2000-2016 for northern and southern populations (b). Error bars show standard error. 

### Figure 3 

```{r}
mhuber <- read.csv(here("/out/anovas_resilience/huber_evi", "robust_mhuber.csv"), header = TRUE)
mhuberbai <- read.csv(here("/out/anovas_resilience/huber_bai", "robust_mhuber.csv"), header = TRUE)

# NO plot rrs 
mhuber_filter <- mhuber %>% filter(var != 'rrs') %>% mutate(disturb_year = as.factor(disturb_year))
mhuberbai_filter <- mhuberbai %>% filter(var != 'rrs') %>% mutate(disturb_year = as.factor(disturb_year))

pd <- position_dodge(.2)
line_lwd <- .8 

aes_disturb <- aes(x = disturb_year, y = M.Huber, 
                   color = site, group = site, 
                   fill = site, linetype=site,
                   shape = site, 
                   ymin = lower.ci, ymax = upper.ci)
aes_site <- aes(x = site, y = M.Huber, 
                color = disturb_year, group=disturb_year, 
                fill=disturb_year, linetype=disturb_year,
                shape = disturb_year, 
                ymin = lower.ci, ymax = upper.ci)


theme_res <- list(
  geom_errorbar(width=.2, position=pd, lwd=line_lwd), 
  geom_line(position = pd, lwd=line_lwd),
  geom_point(size = 2.5, position = pd), 
  facet_wrap(
    ~var_sorted, nrow = 1, scales="free_y",
    labeller = as_labeller(c(
      "0_rt" = "Resistance",
      "1_rc" = "Recovery",
      "2_rs" = "Resilience"))),
  geom_text_repel(aes(label=Letter), 
                  nudge_x = - 0.5,
                  nudge_y = 0.01,
                  direction="both", 
                  size = 3.5, show.legend = FALSE,
                  segment.size = 0.5, 
                  segment.alpha = 0.5),
  theme_bw(), 
  theme(
    panel.grid.minor = element_blank(),
    strip.background = element_rect(
      colour = "black",
      fill = "white"),
    plot.title = element_text(hjust = -0.05, size = 16, margin = margin(t=-5, b=1))),  
  ylab("Response value"), 
  xlab("")
)

theme_evi <-  list(
  scale_color_manual(values = c("black", "blue")),
  scale_shape_manual(values=c(19, 22)),
  scale_fill_manual(values = c("black", "blue")),
  scale_linetype_manual(values = c("solid", "solid"))
)

theme_bai <- list(
  scale_color_manual(values=c('black','blue','blue')), 
  scale_shape_manual(values=c(19, 22, 15)),
  scale_fill_manual(values=c('black','white','blue')),  
  scale_linetype_manual(values=c("solid", "solid", 'solid'))
)
```

```{r}
# EVI_drought 
res_evi_drought <-
  ggplot(mhuber_filter, aes_disturb) + 
  theme_res + theme_evi + theme(legend.position='top') + 
  ggtitle("a) EVI")


# BAI_drought 
res_bai_drought <-
  ggplot(mhuberbai_filter, aes_disturb) + 
  theme_res + theme_bai + theme(legend.position='bottom') + 
  xlab('Drought event') + 
  ggtitle("b) BAI") 

```

```{r, fig.height=7}
res_evi_drought  + res_bai_drought + plot_layout(ncol=1)
```

**Figure 3.** Response of northern (*black*) and southern (*blue*) populations of *Q. pyrenaica* forests to drought in terms of resistance, recovery and resilience of greenness (EVI; a) and tree radial growth (BAI; b) for the years 2005 and 2012. Different letters above bars indicate significant post hoc differences between groups (see material and methods). 

### Figure 4
```{r}
theme_de <- list(
  scale_color_manual(values=c('black','red')), 
  scale_shape_manual(values=c(19, 15)),
  scale_fill_manual(values=c('black','red')),  
  scale_linetype_manual(values=c("solid", "solid")),
  labs(color = 'Drougth event', fill='Drougth event', linetype='Drougth event', shape='Drougth event')
  
)

# EVI_site
res_evi_site <-
  ggplot(mhuber_filter, aes_site) + 
  theme_res + theme_de + theme(legend.position='top') + 
  ggtitle("a) EVI") 


# BAI_site
res_bai_site <-
  ggplot(mhuberbai_filter, aes_site) + 
  theme_res + theme_de + theme(legend.position='bottom') + 
  xlab('Site') + 
  ggtitle("b) BAI") 
```

```{r}
res_evi_site  + res_bai_site + plot_layout(ncol=1)
```

**Figure 4.** Response of *Q. pyrenaica* forests to 2005 (*black*) and 2012 (*red*) drought events in terms of resistance, recovery and resilience of greenness (EVI; a) and tree radial growth (BAI; b) by site. Different letters above bars indicate significant post hoc differences between groups (see material and methods). 

### Figure 5 

```{r, warning=FALSE, out.extra='angle=90'}
cro_sites <- read.csv(here("data/cronos_medias", "cronos_sites.csv"), header = TRUE, sep = ',')

cronos_bai <- cro_sites %>% ggplot(aes(x=year, y=bai_mean/100, colour=site)) + 
  theme_bw() + ylab('BAI') + 
  geom_ribbon(aes(ymin = (bai_mean - bai_se)/100,
                  ymax = (bai_mean + bai_se)/100,
                  fill=site), alpha=.2, colour=NA) +
  geom_line() + 
  geom_point(size=.8) + 
  theme(panel.grid = element_blank(),
        axis.text.x=element_text(size=6),
        legend.position = c(0.1,.8),
        strip.background = element_blank()) + 
  scale_colour_manual(values = c('#7570b3','#e7298a','#1b9e77')) +
  scale_fill_manual(values = c('#7570b3','#e7298a','#1b9e77')) +
  ylab(expression(paste("BAI (", cm^2, year^-1, ")", sep=''))) +
  scale_x_continuous(breaks = seq(1815, 2020, by=10)) 
  # scale_y_continuous(sec.axis = sec_axis(~ ., name = '# trees', breaks = c(0,15,30))) +
  # geom_line(aes(x=year, y=n_trees+40, colour=site)) 

samp <- cro_sites %>% ggplot(aes(x=year, y=n_trees, colour=site)) + 
  theme_bw() + ylab('# trees') + 
  geom_line() + 
  theme(panel.grid = element_blank(),
        legend.position = "none", 
        axis.title.x=element_blank(),
        axis.text.x=element_blank(),
        axis.ticks.x=element_blank(), 
        plot.margin = margin(t = 5, r = 0, b = -5, l = 0, unit = "pt")) + 
  scale_colour_manual(values = c('#7570b3','#e7298a','#1b9e77')) +
  scale_fill_manual(values = c('#7570b3','#e7298a','#1b9e77')) +
  scale_x_continuous(breaks = seq(1815, 2020, by=10)) 

  # theme(plot.margin = unit(c(1,5,-30,6),units="points"),
  #       axis.title.y = element_text(vjust =0.25))


plot_bai_s <- samp + cronos_bai + plot_layout(ncol=1, heights = c(0.1, 0.9))

plot_bai_s
```

**Figure 5.** Basal Area Increment (BAI) chronologies of *Q. pyrenaica* for northern population (SJ; *green*) and southern ones: low-elevation (CA_Low; *pink*) and high-elevation (CA_High, *purple*) sites. Shading areas coorespond to standard error of the mean. Number of series are displayed in the upper plot. 

# Figure 6 

```{r}
cro_rwi <- read.csv(here("data/cronos_medias", "cronos_sites_rwi.csv"), header = TRUE, sep = ',')
year_cutoffs <- read.csv(here("data/cronos_medias", "cronos_sites_rwi_year_cutoffs.csv"), header = TRUE, sep = ',')
year_sampledepth <- read.csv(here("data/cronos_medias", "cronos_sites_rwi_year_sampledepth.csv"), header = TRUE, sep = ',')
```

```{r}
# top10  
top10pos50 <- cro_rwi %>% filter(year > 1950) %>% arrange_(~desc(res)) %>% group_by_(~site) %>%  slice(1:10)
top10neg50 <- cro_rwi %>% filter(year > 1950) %>% arrange_(~res) %>% group_by_(~site) %>%  slice(1:10)
top10pos <- cro_rwi %>% arrange_(~desc(res)) %>% group_by_(~site) %>%  slice(1:10)
top10neg <- cro_rwi %>% arrange_(~res) %>% group_by_(~site) %>%  slice(1:10)
```

```{r}
label_site <- c("0_sj" = "Northern (SJ)",
                "1_caH" = "Southern High (CaH)",
                "2_caL" = "Southern Low (CaL)")


cro_rwi <- cro_rwi %>% 
  mutate(siteF = case_when(
    site_sorted == "0_sj" ~ "Northern (SJ)",
    site_sorted == "1_caH" ~ "Southern High (Ca-High)",
    site_sorted == "2_caL" ~ "Southern Low (Ca-Low)"))

# 
plot_rwi_crono <- ggplot(cro_rwi, aes(x=year, y=res)) +
  theme_bw() + 
  theme(panel.grid = element_blank(), 
        strip.background = element_rect(fill = "white"),
        # strip.text = element_text(face="bold", size=12), 
        strip.text = element_blank(), 
        axis.text = element_text(face="bold", size=8), 
        axis.title = element_text(face="bold", size=12)) + 
  geom_hline(yintercept = 1, colour = "grey") + 
  geom_line(size=.8) + scale_y_continuous(breaks = seq(0.4,1.8, 0.2)) +
  facet_wrap(~site_sorted, scales = "free_x", ncol = 1,
             labeller = as_labeller(label_site)) + 
  ylab("Ring width index") + xlab("Year") + 
  geom_vline(xintercept = c(1995, 2005, 2012), linetype = "dotted") + 
  # geom_vline(aes(xintercept = year), data = year_cutoffs,  linetype = "dashed", colour='red') + 
  geom_vline(aes(xintercept = year), data = year_sampledepth,  linetype = "dashed", colour='blue') +
  scale_x_continuous(limits = c(1819, 2016), 
                     breaks= seq(1820, 2020, by=20)) +
  annotation_custom(x=1980, y = 1.6)

plot_rwi_crono  

```

**Figure 6.** Residual Tree-ring chronologies obtained for the *Q. pyrenaica* sites. Dashed red lines indicate the start of the reliable period (EPS > 0.85). Dotted black lines showing the three most recent severe drought years (1995, 2005 and 2012). 


# Figure 7
```{r}
rtmax <- read.csv(here("data/rwi_climate", "rtmax_selected.csv"), header = TRUE, sep = ',')
rtmin <- read.csv(here("data/rwi_climate", "rtmin_selected.csv"), header = TRUE, sep = ',')
rsequia <- read.csv(here("data/rwi_climate", "rsequia_selected.csv"), header = TRUE, sep = ',')
rprec <- read.csv(here("data/rwi_climate", "rprec_selected.csv"), header = TRUE, sep = ',')


rtmax <- rtmax %>% mutate(v_name = 'T max')
rtmin <- rtmin %>% mutate(v_name = 'T min')
rsequia <- rsequia %>% mutate(v_name ='SPEI')
rprec <- rprec %>% mutate(v_name = 'Prec')

df <- rbind(rtmax, rtmin, rsequia, rprec)

# cutre solucion para el problema de PREC 
exdf <- data.frame(
  id = c(16:19),
  varname = rep("prec", 4), 
  month = c('dec...FEB', 'MAR...MAY', 'JUN...AUG', 'SEP...NOV'),
  coef = rep(0, 4), 
  significant = rep('FALSE', 4),
  ci_lower = rep(0, 4),
  ci_upper = rep(0, 4), 
  sig = rep("", 4), 
  month_name = c("Winter", "Spring", "Summer", "Autumn"), 
  v_name = rep("Prec", 4))


exdf <- rbind(exdf, exdf, exdf)
exdf$X <- c(46:57)
exdf$site <- c(rep("SJ", 4), rep("caL", 4), rep("caH", 4))
  
  
ddf <- rbind(df, exdf) 


label_var <- c("Prec" = "(a) Prec", "SPEI" = "(b) SPEI", 
               "T max" = "(c) T max", "T min" = "(d) T min") 

clima_ring <- ddf %>% ggplot(aes(x=id, y=coef, group = site)) + 
  geom_hline(yintercept = 0, colour="gray") +
  geom_bar(aes(fill=site), stat="identity", position = "dodge") +
  facet_wrap(~v_name, labeller = as_labeller(label_var)) + 
  geom_text(aes(label = sig, x = id, y = ifelse(coef > 0, (coef + 0.02), (coef - 0.05))), 
            position = position_dodge(.9), size = 6) + 
  theme_bw() + 
  theme(axis.title.x = element_blank(),
        panel.grid.major = element_blank(),
        panel.grid.minor.y = element_blank(),
        axis.text.x = element_text(angle = 90, vjust = 0.3),
        legend.position = "bottom",
        strip.background = element_rect(fill=NA, colour=NA),
        strip.text.x = element_text(size = 10, face = "bold")) + 
  scale_x_continuous(breaks = unique(ddf$id), labels = unique(ddf$month_name)) +
  scale_y_continuous(limits = c(-0.4, 0.8), 
                     breaks = c(-0.4, -0.2, 0, 0.2, 0.4, 0.6,0.8)) + 
  scale_fill_manual(values = c("#B2DF8A","#1F78B4","#A6CEE3")) + 
  ylab('Correlation')  

clima_ring 
```


**Figure 7.** Correlation coefficients obtained by relating tree-ring residual chronologies (RWI) of *Q. pyrenaica* and monthly climatic data (precipitation (a), SPEI (b), maximun (c) and minimun (d) temperatures) for northern site (*green* bars), low-elevation southern site (*light blue* bars) and high-elevation shouthern (*dark blue* bars) site. Asteriks indicate significant ($P < 0.05$) correlation coefficients. 

# Figure 8

```{r}
gc_todos <- read.csv(here("data/disturbance", "disturbance_gc.csv"), header = TRUE, sep = ',')

# customize plot (corrected scale)
pos_neg_log <- scales::trans_new('signed_log', 
                                 transform = function(x) sign(x)*log(abs(x)),
                                 inverse = function(x) sign(x)*exp(abs(x)))

custom_ylab <- '% GC'
micolor <- c("#838B8B")


# solution for arrange
# http://felixfan.github.io/stacking-plots-same-x/

custom_corrected_gc <- list(
  geom_bar(stat='identity', fill=micolor, colour=micolor),
  theme_bw(), 
  geom_hline(yintercept=c(50, -50), linetype=2, colour='black'),
  theme(panel.grid.minor = element_blank(), 
        strip.background = element_rect(colour='black',fill='white'))
  )

c <- gc_todos %>% 
  filter(site != 'gc_sj') %>% 
  ggplot(aes(x=year, y=gc_md)) + 
  geom_hline(yintercept = 0, colour = 'black', lwd = 0.3) + 
  geom_errorbar(aes(ymin = gc_md - gc_md_se, ymax = gc_md + gc_md_se), colour='gray', width=.3, size=.2) + 
  # scale_y_continuous(trans = pos_neg_log) +
  facet_wrap(~site_sorted, nrow = 2,
             labeller=as_labeller(c("1_caH" = "Southern High (CaH)", "2_caL" = "Southern Low (CaL)"))) + 
    ylab(custom_ylab) + custom_corrected_gc

d <- gc_todos %>% 
  filter(site == 'gc_sj') %>% 
  ggplot(aes(x=year, y=gc_md)) + 
  xlim(layer_scales(c)$x$range$range[1],layer_scales(c)$x$range$range[2]) +
  geom_hline(yintercept = 1, colour = 'gray', lwd = 0.3) + 
  geom_errorbar(aes(ymin = gc_md - gc_md_se, ymax = gc_md + gc_md_se), colour=micolor, width=.3, size=.2) +
  facet_wrap(~site_sorted, nrow = 2,
             labeller=as_labeller(c("0_sj" = "Northern (SJ)"))) + 
  custom_corrected_gc + ylab('') + 
  scale_y_continuous(trans = pos_neg_log, 
                     breaks=c(-1000, -500, -100, 0, 100, 500)) +
  theme(axis.title.x = element_blank(),
        axis.text.x = element_blank()) 


plot_medians_corregido <- d + c + plot_layout(ncol=1, heights = c(1, 2))
plot_medians_corregido

```

**Figure 8.** Comparison of median growth change ($GC$) following [@Nowacki1997] for *Q. pyrenaica* sites. Dashed black lines indicate a threshold of 50 % of GC (see material and methods). 


# Figure 9

```{r}
gc_treesMed <- read.csv(here("data/disturbance", "disturbance_trees_gc_treshold_median.csv"), header = TRUE, sep = ',')
gc_treesMed50 <- read.csv(here("data/disturbance", "disturbance_trees_gc_treshold_median50.csv"), header = TRUE, sep = ',')

colorpositivo <- c("#104E8B")
colornegativo <- c("#CD3333")

pgc_median50 <- gc_treesMed50 %>% ggplot() +
  geom_bar(aes(x=year, y=per_pos), fill=colorpositivo, colour=colorpositivo, stat = "identity", position = "dodge") + 
  geom_bar(aes(x=year, y=(-1)*per_neg), fill=colornegativo, colour=colornegativo, stat = "identity", position = "dodge") +
  facet_wrap(~site_sorted, nrow = 3, labeller = as_labeller(label_site)) + 
  scale_y_continuous(sec.axis = sec_axis(~ ., name = '# trees', breaks = c(0,15,30))) +
  geom_line(aes(x=year, y=total_tree), colour = 'black') + 
  theme_bw() + ylab('% trees') +
  geom_hline(yintercept=c(50, -50), linetype=2, alpha=.4) +
  theme(panel.grid.minor = element_blank(), 
        strip.background = element_rect(colour='black', 
                                        fill='white')) 
pgc_median50

```

**Figure 9**. Percentage of *Q. pyrenaica* trees affected by GC > 50 % by site. *Black* line shows number of trees (rigth-axis). 
